---
title: "CIBW IPM-based PVA"
author: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, eval = T, include = F}

knitr::opts_chunk$set(echo = FALSE, eval = FALSE, warning = F, message = F, cache = F, fig.align = 'center')

library(jagsUI)  
library(lubridate)
library(tidyr)
library(here)
library(readr) 
library(parallel) 
library(dplyr)
library(tidyverse)
library(ggplot2)
library(stringr)
library(knitr)
library(xtable)
library(gtools)
library(demogR)
library(cowplot)
library(DescTools) 
library(truncnorm)
library(reshape2)
library(ggstance) 
library(Hmisc)
# library(rerddap)

source(here::here('PlotTheme.R'))

```

```{r aerial survey data, eval = T}

#aerial survey data from P. Wade on 3/7/22; Shelden & Wade 2019

#max day
# mu <- c(287, 304, 295, 387, 393, 508, 568, 417, 392, 314, 310)
# cv <- c(0.0826, 0.0981, 0.1479, 0.0820, 0.0661, 0.0872, 0.0985, 0.0637, 0.0575, 0.0705, 0.1218)
# 
# sd <- cv*mu# 
# tau <- 1/(sd^2)

#median day
mu <- c(238, 285, 268, 358, 283, 342, 415, 336, 379, 247, 269)
cv <- c(0.079, 0.072, 0.085, 0.073, 0.051, 0.067, 0.085, 0.051, 0.059, 0.077, 0.103)

sd <- cv*mu
tau <- 1/(sd^2)

```

```{r MR data and effort, eval = T, results = 'hide'}

#mother-calf pair MR ME data

## Choose which data to use; matching Himes Boor et al. 2022
data.type <- "left_side"
# data.type <- "right_side"
# data.type <- "dual"

# Read in the data: 
CalfAge.SH.num.csv <- read_csv(file=paste("Data/Inputs/v4.7-num_SH-",data.type,".csv",sep=""))

# Read in starting latent state matrix
start.mat.csv<-read_csv(file=paste("Data/Inputs/v4.7-fxd_start_mat-",data.type,".csv",sep=""))

#for v4.7 and above (no filter for those observations with calves that happen few times, see Himes Boor et al for more information)
CH_data <- CalfAge.SH.num.csv[,-c(1:3)]

n_ind <- dim(CH_data)[1]
n_occ <- dim(CH_data)[2] #13 yrs of data, 12 survival periods

#effort (land and boat-based surveys)
effort_raw <- read.csv(file = here::here('Data', 'CIBW_survey_effort.csv'), 
                   header = T, stringsAsFactors = F)

#taking the combination of land and vessel per year
#low/high 2-level effort
effort <- effort_raw %>% 
  transform(Land_Vessel_sc = scale(Land_Vessel)) %>%
  transform(Vessel_sc = scale(Vessel_Surveys)) %>%
  transform(eff_cat = ifelse(Land_Vessel < 36, 1, 2))

```

```{r covariates -- ocean, eval = T}

#define seasons
winter <- c(1,2,3)
spring <- c(4,5,6)
summer <- c(7,8,9)
fall <- c(10,11,12)

start <- 2 #don't want adj_yr 0 (jan-jun 2005, just want post breeding season 2005)
stop <- 13 #last year of data is 2017 (for survival from 2016-2017)
seas <- 'yr'

#seasonal level for appendix
# seas <- 'spr'
# seas <- 'sum'
# seas <- 'fall'
# seas <- 'win'

##sst for main text model
sst_goa_raw <- read.csv(here::here('Data', "sst_GoA_data.csv"), header = T, stringsAsFactors = F) %>%
  transform(year = as.numeric(substr(date, 1,4)), month = as.numeric(substr(date, 6,7))) %>%
  filter(year > 2004 & year < 2018) %>% dplyr::select(-date) %>%
  transform(yr = as.numeric(factor(year))) %>%
  transform(season = ifelse(month %in% winter, 'winter', ifelse(month %in% spring, 'spring',
                                                                ifelse(month %in% summer, 'summer', 'fall')))) 

##season level
sst_goa_seas <- data.frame()
sst_goa_temp <- sst_goa_raw 
for (i in 1:nrow(sst_goa_temp)) {
  temp <- sst_goa_temp[i,]
  year_num <- sst_goa_temp[i, 'yr']
  if (temp$season %in% c('winter', 'spring')) {
    temp$season_yr <- paste(temp$season, year_num-1, sep = '')
  } else {
    temp$season_yr <- as.character(paste(as.character(temp$season), year_num, sep = ''))
  }
  sst_goa_seas <- rbind(sst_goa_seas, temp)
}

##year-level
sst_goa_yr <- sst_goa_seas %>%
  group_by(season_yr) %>%
  dplyr::summarize(sst_goa = mean(sst, na.rm = T)) %>%
  transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
  group_by(adj_year) %>%
  dplyr::summarize(sst_goa = mean(sst_goa, na.rm = T))

#seasonal
sst_goa_seas <- sst_goa_seas %>%
  group_by(season_yr) %>%
  dplyr::summarize(sst_goa = mean(sst, na.rm = T)) %>%
  transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
  dplyr::select(-season_yr) %>%
  dcast(adj_year ~ season, value.var = 'sst_goa')

sst_goa <- sst_goa_yr %>%
  merge(sst_goa_seas, by = 'adj_year')
colnames(sst_goa) <- c('adj_year', paste('sst_goa', c('yr', 'fall', 'spring', 'summer', 'winter'), sep = '_'))

## other covariates for appendix
# ## upwelling
# #monthly anomalies
# upwell_raw <- read.csv(here::here('Data', "upwell_anom_SSL.csv"), stringsAsFactors = F) %>%
#   filter(year > 2004 & year < 2018 & lat == '60N' & long == '149W') %>%
#   dplyr::select(-c(lat, long)) %>%
#   melt(id.vars = 'year', value.name = 'upwell') %>%
#   transform(month = as.numeric(gsub('X', '', variable))) %>% dplyr::select(-variable) %>%
#   transform(upwell = scale(upwell)) %>%
#   transform(yr = as.numeric(factor(year))) %>%
#   transform(season = ifelse(month %in% winter, 'winter', ifelse(month %in% spring, 'spring',
#                                                                 ifelse(month %in% summer, 'summer', 'fall')))) 
# ##season level
# upwell_seas <- data.frame()
# upwell_temp <- upwell_raw 
# for (i in 1:nrow(upwell_temp)) {
#   temp <- upwell_temp[i,]
#   year_num <- upwell_temp[i, 'yr']
#   if (temp$season %in% c('winter', 'spring')) {
#     temp$season_yr <- paste(temp$season, year_num-1, sep = '')
#   } else {
#     temp$season_yr <- as.character(paste(as.character(temp$season), year_num, sep = ''))
#   }
#   upwell_seas <- rbind(upwell_seas, temp)
# 
# }
# 
# ##year-level
# upwell_yr <- upwell_seas %>%
#   group_by(season_yr) %>%
#   dplyr::summarize(upwell = mean(upwell, na.rm = T)) %>%
#   transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
#   group_by(adj_year) %>%
#   dplyr::summarize(upwell = mean(upwell, na.rm = T))
# 
# #seasonal
# upwell_seas <- upwell_seas %>%
#   group_by(season_yr) %>%
#   dplyr::summarize(upwell = mean(upwell, na.rm = T)) %>%
#   transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
#   dplyr::select(-season_yr) %>%
#   dcast(adj_year ~ season, value.var = 'upwell')
# 
# upwell <- upwell_yr %>%
#   merge(upwell_seas, by = 'adj_year')
# colnames(upwell) <- c('adj_year', paste('upwell', c('yr', 'fall', 'spring', 'summer', 'winter'), sep = '_'))
# 
# #PDO
# PDO_raw <- read.csv(here::here('Data', "PDO_mo.csv"), header = T, stringsAsFactors = F) %>%
#   transform(year = as.numeric(substr(Date, 1,4)), month = as.numeric(substr(Date, 5, 6))) %>%
#   filter(year > 2004 & year < 2018) %>% dplyr::select(-Date) %>%
#   transform(yr = as.numeric(factor(year))) %>%
#   transform(season = ifelse(month %in% winter, 'winter', ifelse(month %in% spring, 'spring',
#                                                                 ifelse(month %in% summer, 'summer', 'fall')))) 
# 
# ##season level
# PDO_seas <- data.frame()
# PDO_temp <- PDO_raw 
# for (i in 1:nrow(PDO_temp)) {
#   temp <- PDO_temp[i,]
#   year_num <- PDO_temp[i, 'yr']
#   if (temp$season %in% c('winter', 'spring')) {
#     temp$season_yr <- paste(temp$season, year_num-1, sep = '')
#   } else {
#     temp$season_yr <- as.character(paste(as.character(temp$season), year_num, sep = ''))
#   }
#   PDO_seas <- rbind(PDO_seas, temp)
# }
# 
# ##year-level
# PDO_yr <- PDO_seas %>%
#   group_by(season_yr) %>%
#   dplyr::summarize(PDO = mean(PDO, na.rm = T)) %>%
#   transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
#   group_by(adj_year) %>%
#   dplyr::summarize(PDO = mean(PDO, na.rm = T))
# 
# #seasonal
# PDO_seas <- PDO_seas %>%
#   group_by(season_yr) %>%
#   dplyr::summarize(PDO = mean(PDO, na.rm = T)) %>%
#   transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
#   dplyr::select(-season_yr) %>%
#   dcast(adj_year ~ season, value.var = 'PDO')
# 
# PDO <- PDO_yr %>%
#   merge(PDO_seas, by = 'adj_year')
# colnames(PDO) <- c('adj_year', paste('PDO', c('yr', 'fall', 'spring', 'summer', 'winter'), sep = '_'))
# 
# ####NPGO
# NPGO_raw <- read.csv(here::here('Data', "NPGO.csv"), header = T, stringsAsFactors = F) %>%
#   filter(year > 2004 & year < 2018) %>% 
#   transform(yr = as.numeric(factor(year))) %>%
#   transform(season = ifelse(month %in% winter, 'winter', ifelse(month %in% spring, 'spring',
#                                                                 ifelse(month %in% summer, 'summer', 'fall')))) 
# 
# ##season level
# NPGO_seas <- data.frame()
# NPGO_temp <- NPGO_raw 
# for (i in 1:nrow(NPGO_temp)) {
#   temp <- NPGO_temp[i,]
#   year_num <- NPGO_temp[i, 'yr']
#   if (temp$season %in% c('winter', 'spring')) {
#     temp$season_yr <- paste(temp$season, year_num-1, sep = '')
#   } else {
#     temp$season_yr <- as.character(paste(as.character(temp$season), year_num, sep = ''))
#   }
#   NPGO_seas <- rbind(NPGO_seas, temp)
# }
# 
# ##year-level
# NPGO_yr <- NPGO_seas %>%
#   group_by(season_yr) %>%
#   dplyr::summarize(NPGO = mean(NPGO, na.rm = T)) %>%
#   transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
#   group_by(adj_year) %>%
#   dplyr::summarize(NPGO = mean(NPGO, na.rm = T))
# 
# #seasonal
# NPGO_seas <- NPGO_seas %>%
#   group_by(season_yr) %>%
#   dplyr::summarize(NPGO = mean(NPGO, na.rm = T)) %>%
#   transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
#   dplyr::select(-season_yr) %>%
#   dcast(adj_year ~ season, value.var = 'NPGO')
# 
# NPGO <- NPGO_yr %>%
#   merge(NPGO_seas, by = 'adj_year')
# colnames(NPGO) <- c('adj_year', paste('NPGO', c('yr', 'fall', 'spring', 'summer', 'winter'), sep = '_'))
# 
# 
# ## satellite data
# xcoord <- c(-157.4, -156.2, -136.9, -145.5)
# ycoord <- c(55.7, 53.6, 57.5, 59.975)
# zcoord <- c(0,0)
# 
# # productivity; only need to do once and then re-load
# dataInfo <- rerddap::info('erdMH1ppmday')  #2003-present
# 
# parameter <- dataInfo$variable$variable_name[1] #just want prod
# 
# global <- dataInfo$alldata$NC_GLOBAL #start and end times
# tt <- global[ global$attribute_name %in% c('time_coverage_end','time_coverage_start'), "value", ]
# tcoord <- c(tt[2],"last")
# 
# prod <- rxtractogon(dataInfo,parameter=parameter,
#                     tcoord=tcoord, zcoord = zcoord,
#                     xcoord=xcoord, ycoord=ycoord)
# 
# plotBBox(prod, maxpixels = 1000000)
# 
# # spatially average all the data within the box for each dataset
# prod$avg <- apply(prod$productivity, c(3),function(x) mean(x,na.rm=TRUE))
# 
# plot(as.Date(prod$time), scale(prod$avg),
#      type='b', bg="blue", pch=21, xlab="", cex=.7,
#      xlim=as.Date(c("1997-01-01","2019-01-01")),
#      #   ylim=c(10,25),
#      ylab="Prod")
# 
# prod_data <- data.frame(date = prod$time, prod = prod$avg)
# # write.csv(prod_data, file = here::here('Data', 'prod_data.csv'), row.names = F)
# 
# prod_raw <- read.csv(here::here('Data', "prod_data.csv"), header = T, stringsAsFactors = F) %>%
#   transform(year = as.numeric(substr(date, 1,4)), month = as.numeric(substr(date, 6,7))) %>%
#   filter(year > 2004 & year < 2018) %>% dplyr::select(-date) %>%
#   transform(yr = as.numeric(factor(year))) %>%
#   transform(season = ifelse(month %in% winter, 'winter', ifelse(month %in% spring, 'spring',
#                                                                 ifelse(month %in% summer, 'summer', 'fall')))) 
# 
# ##season level
# prod_seas <- data.frame()
# prod_temp <- prod_raw 
# for (i in 1:nrow(prod_temp)) {
#   temp <- prod_temp[i,]
#   year_num <- prod_temp[i, 'yr']
#   if (temp$season %in% c('winter', 'spring')) {
#     temp$season_yr <- paste(temp$season, year_num-1, sep = '')
#   } else {
#     temp$season_yr <- as.character(paste(as.character(temp$season), year_num, sep = ''))
#   }
#   prod_seas <- rbind(prod_seas, temp)
# }
# 
# ##year-level
# prod_yr <- prod_seas %>%
#   group_by(season_yr) %>%
#   dplyr::summarize(prod = mean(prod, na.rm = T)) %>%
#   transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
#   group_by(adj_year) %>%
#   dplyr::summarize(prod = mean(prod, na.rm = T))
# 
# #seasonal
# prod_seas <- prod_seas %>%
#   group_by(season_yr) %>%
#   dplyr::summarize(prod = mean(prod, na.rm = T)) %>%
#   transform(adj_year = parse_number(season_yr), season = gsub("^\\d+|\\d+$", "", season_yr)) %>%
#   dplyr::select(-season_yr) %>%
#   dcast(adj_year ~ season, value.var = 'prod')
# 
# prod <- prod_yr %>%
#   merge(prod_seas, by = 'adj_year')
# colnames(prod) <- c('adj_year', paste('prod', c('yr', 'fall', 'spring', 'summer', 'winter'), sep = '_'))


#subset variables for season or annual yr
sst_goa <- as.numeric(scale(eval(parse(text = paste0('sst_goa$sst_goa_', seas, '[', start, ':', stop, ']')))))

# prod <- as.numeric(scale(eval(parse(text = paste0('prod$prod_', seas, '[', start, ':', stop, ']')))))
# PDO <- as.numeric(scale(eval(parse(text = paste0('PDO$PDO_', seas, '[', start, ':', stop, ']')))))
# 
# NPGO <- as.numeric(scale(eval(parse(text = paste0('NPGO$NPGO_', seas, '[', start, ':', stop, ']')))))
# 
# #always choose summer for upwelling
# up <- as.numeric(scale(eval(parse(text = paste0('upwell$upwell_', 'sum', '[', start, ':', stop, ']')))))

```

```{r covariates -- prey and other}

#energy/mass table from K. Goetz
conv_tab <- data.frame(Species = c('Chinook', 'Sockeye', 'Chum', 'Coho', 'Pink'),
                       energy = c(7.21, 7.51, 4.78, 5.8, 4.29),
                       mass = c(3.81, 2.4, 4.2, 3.56, 1.86))

## for prey, need 2005-2016 for 2005-2016 survival periods
chinook_raw <- read.csv(here::here('Data', 'Susitna_InRiver_Chinook.csv'))

chinook_inRiv_tot <- chinook_raw %>%
  dplyr::select(Year, Total_abundance) %>%
  transform(Total_abundance = Total_abundance*conv_tab[conv_tab$Species == 'Chinook', 'energy']*conv_tab[conv_tab$Species == 'Chinook', 'mass']) %>%
  transform(abun_scale = scale(Total_abundance)) %>%
  filter(Year > 2004 & Year < 2017)

prey <- read.csv(here::here('Data', 'PreyCovs.csv'), stringsAsFactors = F, header = T) %>%
  filter(Year < 2017 & Year > 2004) %>%
  merge(conv_tab, by = 'Species', all.x = T)

# #combined fish metric
salm <- prey %>% filter(Species %in% c('Coho', 'Sockeye', 'Pink', 'Chum')) %>%
  group_by(Year) %>%
  dplyr::summarize(Count = sum(Count*energy*mass), .groups = 'keep')

#sum then scale
all_fish <- scale(salm$Count + chinook_inRiv_tot$Total_abundance[1:12])[1:12]

# monthly data for appendix covariates

# sus_coho_LS <- prey %>% filter(River == 'Little Susitna') %>% 
#   transform(Count = scale(Count*energy*mass)) %>% dplyr::select(Count) 
#   
# sus_coho_SR <- prey %>% filter(River == 'Susitna River' & Species == 'Coho') %>% 
#   transform(Count = scale(Count*energy*mass)) %>% dplyr::select(Count) 
#   
# sus_pink <- prey %>% filter(River == 'Susitna River' & Species == 'Pink') %>% 
#   transform(Count = scale(Count*energy*mass)) %>% dplyr::select(Count) 
#   
# knik_coho <- prey %>% filter(River == 'Jim Creek') %>% 
#   transform(Count = scale(Count*energy*mass)) %>% dplyr::select(Count) 
# 
# knik_sock <- prey %>% filter(River == 'Fish Creek') %>% 
#   transform(Count = scale(Count*energy*mass)) %>% dplyr::select(Count) 
#   
# CI_chum <- prey %>% filter(Species == 'Chum') %>% 
#   transform(Count = scale(Count*energy*mass)) %>% dplyr::select(Count) 
#   
# CI_eul <- prey %>% filter(Species == 'Eulachon smelt') %>% 
#   transform(Count = scale(Count)) %>% dplyr::select(Count) 
# 

#other covs; stressors and prey proxies from P.Wade
# othr_covs <- read.csv(file = here::here('Data', 'other_covariates.csv'),
#                       header = T, stringsAsFactors = F) %>%
#   filter(Year < 2017 & Year > 2004)

### checking covariate correlations
# library(Hmisc)
# library(corrplot)
# 
# flattenCorrMatrix <- function(cormat, pmat) {
#   ut <- upper.tri(cormat)
#   data.frame(
#     row = rownames(cormat)[row(cormat)[ut]],
#     column = rownames(cormat)[col(cormat)[ut]],
#     cor  =(cormat)[ut],
#     p = pmat[ut]
#   )
# }
# 
# ## fish and ocean
# covs_corr <- data.frame(prod = prod, up = up, PDO = PDO, NPGO = NPGO, sst_goa = sst_goa, 
#                         chinook = chinook_inRiv_tot$abun_scale[2:13],
#                         coho1 = c(sus_coho_LS$Count), coho2 = c(sus_coho_SR$Count), 
#                         coho3 = c(knik_coho$Count),
#                         pink = c(sus_pink$Count), chum = c(CI_chum$Count), 
#                         eul = c(CI_eul$Count), sock = c(knik_sock$Count),
#                         all_fish = c(all_fish$Count), salm = c(salm$Count[1:12]))

# cor <- rcorr(as.matrix(covs_corr))
# cor_vals <- flattenCorrMatrix(cor$r, cor$P) %>% arrange(cor)
# corrplot(cor$r, type = "lower", order = "original", p.mat = cor$P,
#          insig = "blank", sig.level = 0.05, tl.col = "black", tl.cex = .9, number.cex = .2)
# 
# ## threats and forage
# covs_corr <- data.frame(sect = c(scale(othr_covs$S7_cons)), 
#                   takes = c(scale(othr_covs$B_takes)), 
#                   anch_pop = c(scale(othr_covs$Anch_pop_size)),
#                   murres = c(scale(othr_covs$Murre_f)),
#                   kitti = c(scale(othr_covs$Kitti_f)),
#                   osmer = c(scale(othr_covs$osmerid_byc)),
#                   eul_by = c(scale(othr_covs$eul_byc)),
#                   haz = c(scale(othr_covs$haz_spill)),
#                   ship = c(scale(as.numeric(othr_covs$ship_ton))))

# cor <- rcorr(as.matrix(covs_corr))
# cor_vals <- flattenCorrMatrix(cor$r, cor$P) %>% arrange(cor)
# corrplot(cor$r, type = "lower", order = "original", p.mat = cor$P,
#          insig = "blank", sig.level = 0.05, tl.col = "black", tl.cex = .9, number.cex = .2)

```

```{r indexing, eval = T}

#pop model/projection years
pop.start <- 2004 
pop.end <- 2018
ch.end <- 2017
ch.start <- 2005
grp.end <- 2018

#time series lengths
data.start <- 2004
nyears.ch <- length(2005:2017)
nyears.grp <- length(c(2004:2010, 2012, 2014, 2016, 2018))
nyears.pop <- length(pop.start:pop.end)

#year indexing to match with pop mod years
ch.years <- c(2005:2017) - (pop.start-1) 
grp.years <- c(2004:2010, 2012, 2014, 2016, 2018) - (pop.start-1)

nyears.gap <- 1 #gap years

```

```{r ME parameters and states, echo=F}

n.states <- 14
n.obs <- 72

#initial values
#date of first capture for each individual:
get.first.cap <- function(x) min(which(x != "1"))
e <- apply(CH_data, 1, get.first.cap)

# Prep starting latent matrix for use in model -- from Himes Boor et al. 2022
#  This code is technically no longer needed, but should be left in because it
#   works with the model code below.
alive.function <- function(){
  alive <- start.mat.csv
  for (i in 1:n_ind){
       for (j in 1:n_occ) {
            if (j < e[i]) {alive[i,j] = NA}
       }
  }
  alive
}

# OBSERVATIONS (i.e. events)
# see below with matrices

# STATES
# NB = alive non-breeder
# Byoy = breeder w/YOY
# Bc1 = breeder w/1yo calf
# Bc2 = breeder w/2yo calf
# Bc2yoy = breeder w/YOY & 2yo calf
# Bc3 = breeder w/3yo calf
# Bc3yoy = breeder w/YOY & 3yo calf
# Bc3c1 = breeder w/3yo & 1yo calf
# Bc4 = breeder w/4yo calf
# Bc4yoy = breeder w/YOY & 4yo calf
# Bc4c1 = breeder w/4yo & 1yo calf
# Bc4c2 = breeder w/4yo & 2yo calf
# D = dead

# PARAMETERS
# phiB  survival prob. of known-breeding adults
# phiN  survival probability of male, juvenile, and otherwise non-breeding adults
# phiC  survival prob. of calves (2-5yo)
# phiY  survival prob of YOY and yearlings
# psiB transition prob. from breeder without calf to Byoy
# psiN transition prob. for first-time breeding
# pN  detection prob. of non-breeders
# pBc detection of Byoy
# pBn detection of known breeders seen w/o calves
# deltaY detection prob of YOY
# deltaC detection prob of dependent calves 2-5yo

# pi[1:13] prob. of being in initial states 1 to 13 

#State-Transition Matrices
# Matrix 1: Adult Survival [14,14]
# Matrix 2: Young survival [14,36]
# Matrix 3: Deterministic calf aging [36,14]
# Matrix 4: Adult breeding transition [14,14]

#Observation-Event Matrices
# Matrix 1: Adult detection [14,14]
# Matrix 2: Calf detection [14,25]
# Matrix 3: Calf-age determination [25,66]

```

```{r nimble functions}

library(nimble)
getSTATE <- nimbleFunction(
  run = function(z=double(0), phiB=double(0), phiN=double(0), phiC=double(0), 
                 phiY=double(0), psiB=double(0), psiN=double(0)) {
    
   returnType(double(1))
    
   ans <- rep(0,14)
     if(z==1)   ans <- c(-phiN*(psiN-1),0,phiN*psiN,0,0,0,0,0,0,0,0,0,0,1-phiN)
     if(z==2)   ans <- c(0,-phiB*(psiB-1),phiB*psiB,0,0,0,0,0,0,0,0,0,0,1-phiB)   
     if(z==3)   ans <- c(0,-phiB*(phiY-1),0,phiB*phiY,0,0,0,0,0,0,0,0,0,1-phiB)
     if(z==4)   ans <- c(0,phiB*(phiY-1)*(psiB-1),-phiB*psiB*(phiY-1),0,
                     -phiB*phiY*(psiB-1), phiB*phiY*psiB,0,0,0,0,0,0,0,1-phiB)  
     if(z==5)   ans <- c(0,phiB*(phiC-1)*(psiB-1),-phiB*psiB*(phiC-1),0,0,0,
                     -phiB*phiC*(psiB-1),phiB*phiC*psiB,0,0,0,0,0,1-phiB)   
     if(z==6)   ans <- c(0,phiB*(phiC-1)*(phiY-1),0,-phiB*phiY*(phiC-1),0,0,
                     -phiB*phiC*(phiY-1),0,phiB*phiC*phiY,0, 0,0,0,1-phiB)                 
     if(z==7)   ans <- c(0,phiB*(phiC-1)*(psiB-1),-phiB*psiB*(phiC-1),
                     0,0,0,0,0,0,-phiB*phiC*(psiB-1), phiB*phiC*psiB,0,0,1-phiB)
     if(z==8)   ans <- c(0,phiB*(phiC-1)*(phiY-1),0,-phiB*phiY*(phiC-1),0,0,
                     0,0,0,-phiB*phiC*(phiY-1),0,phiB*phiC*phiY,0,1-phiB)   
     if(z==9)   ans <- c(0,-phiB*(phiC-1)*(phiY-1)*(psiB-1),
                     phiB*psiB*(phiC-1)*(phiY-1),0,phiB*phiY*(phiC-1)*(psiB-1),
                     -phiB*phiY*psiB*(phiC-1),0,0,0,phiB*phiC*(phiY-1)*(psiB-1),
                     -phiB*phiC*psiB*(phiY-1),0,phiB*phiC*phiY,1-phiB)      
     if(z==10)  ans <- c(0,phiB*(phiC-1)*(psiB-1),-phiB*psiB*(phiC-1),0,0,0,0,
                      0,0,-phiB*phiC*(psiB-1),phiB*phiC*psiB,0,0,1-phiB)   
     if(z==11)  ans <- c(0,phiB*(phiC-1)*(phiY-1),0,-phiB*phiY*(phiC-1),0,0,0,0,
                      0,-phiB*phiC*(phiY-1),0,phiB*phiC*phiY,0,1-phiB)      
     if(z==12)  ans <- c(0,-phiB*(phiC-1)*(phiY-1)*(psiB-1),phiB*psiB*(phiC-1)*(phiY-1),0,
                      phiB*phiY*(phiC-1)*(psiB-1),-phiB*phiY*psiB*(phiC-1),0,
                      0,0,phiB*phiC*(phiY-1)*(psiB-1), -phiB*phiC*psiB*(phiY-1),0,phiB*phiC*phiY,1-phiB)
     if(z==13) ans <- c(0,-phiB*(phiC-1)^2*(psiB-1), phiB*psiB*(phiC-1)^2,0,0,0,
                      phiB*phiC*(phiC-1)*(psiB-1),-phiB*phiC*psiB*(phiC-1),0,
                      phiB*phiC*(phiC-1)*(psiB-1),-phiB*phiC*psiB*(phiC-1),0,phiB*phiC^2,1-phiB)
     if(z==14) ans <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1) 

   return(ans)
 }
)

#observations
getOBS <- nimbleFunction(
  run = function(z=double(0), pN=double(0), pBc=double(0), pBn=double(0), 
                 deltaC=double(0), deltaY=double(0),
                 eta=double(0), gamma=double(0), omegaA=double(0), omegaB=double(0),
                 kappaC=double(0), kappaY=double(0), alphaTc=double(0), alphaTy=double(0)) {
   returnType(double(1))
   ans <- rep(0,72)
     if(z==1)   ans <- c(1-pN,pN,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                         0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
     if(z==2)   ans <- c(1-pBn,pBn,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
                         ,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)      
     if(z==3)   ans <- c(1-pBc,-pBc*(deltaY-1), alphaTy*deltaY*pBc*gamma, -deltaY*gamma*kappaY*pBc*(alphaTy-1), 
                    0, 0, deltaY*gamma*pBc*(alphaTy-1)*(kappaY-1), 0,0,0,0,0,0,
                    -deltaY*pBc*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
     if(z==4)   ans <- c(1-pBc,-pBc*(deltaY-1), 0, -deltaY*eta*gamma*omegaA*pBc*(alphaTc-1),
                         alphaTc*deltaY*pBc*gamma,            
                         deltaY*pBc*gamma*omegaA*(alphaTc-1)*(eta-1),
                         deltaY*gamma*pBc*(alphaTc-1)*(omegaA-1), 0,0,
                    0,0,0,0,-deltaY*pBc*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
     if(z==5)   ans <- c(1-pBc,-pBc*(deltaC-1), 0,0,0, deltaC*pBc*gamma*(alphaTc-1)*(omegaA-1),
                    -deltaC*eta*gamma*omegaA*pBc*(alphaTc-1), alphaTc*deltaC*pBc*gamma,
                    (alphaTc-1)*(eta-1)*deltaC*pBc*gamma*omegaA,0,0,0,
                    0,-deltaC*pBc*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)    
     if(z==6)   ans <- c(1-pBc, pBc*(deltaC-1)*(deltaY-1),
                    -alphaTy*deltaY*gamma*pBc*(deltaC-1),deltaY*gamma*kappaY*pBc*(alphaTy-1)*(deltaC-1), 0,
                    -deltaC*gamma*pBc*(alphaTc-1)*(omegaA-1)*(deltaY-1),
                  deltaC*eta*gamma*omegaA*pBc*(alphaTc-1)*(deltaY-1)-deltaY*gamma*pBc*(alphaTy-1)*(deltaC-1)*(kappaY-1),
                    -alphaTc*deltaC*gamma*pBc*(deltaY-1),
                    -deltaC*pBc*gamma*omegaA*(alphaTc-1)*(deltaY-1)*(eta-1),
                    0,0,0,0,
                    deltaC*pBc*(deltaY-1)*(gamma-1)+deltaY*pBc*(deltaC-1)*(gamma-1),
                    alphaTy*deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(omegaA-1),
                    -deltaC*deltaY*gamma^2*kappaY*pBc*(alphaTc-1)*(alphaTy-1)*(omegaA-1), 0, #here
                    -alphaTy*deltaC*deltaY*eta*gamma^2*omegaA*pBc*(alphaTc-1),
                    deltaC*deltaY*eta*gamma^2*kappaY*omegaA*pBc*(alphaTc-1)*(alphaTy-1),
                    alphaTc*alphaTy*deltaC*deltaY*gamma^2*pBc,
                    -alphaTc*deltaC*deltaY*gamma^2*kappaY*pBc*(alphaTy-1),
                    alphaTc*deltaC*deltaY*gamma^2*pBc*(alphaTy-1)*(kappaY-1),
                    alphaTy*deltaC*deltaY*gamma^2*omegaA*pBc*(alphaTc-1)*(eta-1),
                    -deltaC*deltaY*gamma^2*kappaY*omegaA*pBc*(alphaTc-1)*(alphaTy-1)*(eta-1),
                    0,0,deltaC*deltaY*gamma^2*omegaA*pBc*(alphaTc-1)*(alphaTy-1)*(eta-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    -alphaTy*deltaC*deltaY*pBc*gamma*(gamma-1),
                    deltaC*deltaY*gamma*kappaY*pBc*(alphaTy-1)*(gamma-1),0,
                    -deltaC*deltaY*gamma*pBc*(alphaTc-1)*(gamma-1)*(omegaA-1),
                    -deltaC*deltaY*pBc*(gamma*(alphaTy-1)*(gamma-1)*(kappaY-1)-eta*gamma*omegaA*(alphaTc-1)*(gamma-1)),
                    -alphaTc*deltaC*deltaY*gamma*pBc*(gamma-1),
                    -deltaC*deltaY*gamma*omegaA*pBc*(alphaTc-1)*(eta-1)*(gamma-1),
                    0,0,0,0,
                    deltaC*deltaY*pBc*(gamma-1)^2, 0, 
                    deltaY*deltaC*gamma^2*pBc*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaA-1), 0,0,
                    -deltaC*deltaY*eta*(gamma^2)*omegaA*pBc*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0)       
     if(z==7)   ans <- c(1-pBc, -pBc*(deltaC-1),
                         0,0,0,-deltaC*gamma*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,
                    deltaC*pBc*gamma*kappaC*(alphaTc-1)*(omegaB-1),alphaTc*deltaC*pBc*gamma,
                    -deltaC*gamma*omegaB*pBc*(alphaTc-1),
                    0,0,-deltaC*pBc*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0)
     if(z==8)   ans <- c(1-pBc, pBc*(deltaC-1)*(deltaY-1), -alphaTy*deltaY*pBc*gamma*(deltaC-1), 
                      deltaY*gamma*kappaY*pBc*(alphaTy-1)*(deltaC-1),0,
                    deltaC*gamma*pBc*(alphaTc-1)*(deltaY-1)*(kappaC-1)*(omegaB-1),
                    -deltaY*gamma*pBc*(alphaTy-1)*(deltaC-1)*(kappaY-1),0,
                    -deltaC*gamma*kappaC*pBc*(alphaTc-1)*(deltaY-1)*(omegaB-1),
                    -alphaTc*deltaC*gamma*pBc*(deltaY-1),
                    deltaC*gamma*omegaB*pBc*(alphaTc-1)*(deltaY-1),
                    0,0,deltaC*pBc*(deltaY-1)*(gamma-1)+deltaY*pBc*(deltaC-1)*(gamma-1),
                    -alphaTy*deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1),
                    deltaC*deltaY*gamma^2*kappaY*pBc*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1),0,0,0,0
                    ,0,0,
                    alphaTy*deltaC*deltaY*gamma^2*kappaC*pBc*(alphaTc-1)*(omegaB-1),
                    -deltaC*deltaY*gamma^2*kappaC*kappaY*pBc*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                    deltaC*deltaY*gamma^2*kappaC*pBc*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,
                    alphaTc*alphaTy*deltaC*deltaY*gamma^2*pBc,
                    -alphaTc*deltaC*deltaY*gamma^2*kappaY*pBc*(alphaTy-1),0,0,
                    alphaTc*deltaC*deltaY*gamma^2*pBc*(alphaTy-1)*(kappaY-1), 
                    -alphaTy*deltaC*deltaY*gamma^2*omegaB*pBc*(alphaTc-1),
                    deltaC*deltaY*gamma^2*kappaY*omegaB*pBc*(alphaTc-1)*(alphaTy-1), 0,0,
                    -deltaC*deltaY*gamma^2*omegaB*pBc*(alphaTc-1)*(alphaTy-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-alphaTy*deltaC*deltaY*gamma*pBc*(gamma-1),
                    deltaC*deltaY*gamma*kappaY*pBc*(alphaTy-1)*(gamma-1),0,
                    deltaC*deltaY*gamma*pBc*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1),
                    -deltaC*deltaY*gamma*pBc*(alphaTy-1)*(gamma-1)*(kappaY-1),
                    0,-deltaC*deltaY*gamma*kappaC*pBc*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC*deltaY*gamma*pBc*(gamma-1),
                    deltaC*deltaY*gamma*omegaB*pBc*(alphaTc-1)*(gamma-1),0,0,
                    deltaC*deltaY*pBc*(gamma-1)^2, 0,
                    -deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1),
                    0,0,0,0)
     if(z==9)   ans <- c(1-pBc, pBc*(deltaC-1)*(deltaY-1), 0,
                         deltaY*eta*gamma*omegaA*pBc*(alphaTc-1)*(deltaC-1),
                    -alphaTc*deltaY*pBc*gamma*(deltaC-1),
                    deltaC*gamma*pBc*(alphaTc-1)*(kappaC-1)*(deltaY-1)*(omegaB-1)-
                    deltaY*gamma*omegaA*pBc*(alphaTc-1)*(deltaC-1)*(eta-1),
                    -deltaY*gamma*pBc*(alphaTc-1)*(deltaC-1)*(omegaA-1), 0, 
                    -deltaC*gamma*kappaC*pBc*(alphaTc-1)*(deltaY-1)*(omegaB-1),
                    -alphaTc*deltaC*gamma*(deltaY-1),
                    deltaC*gamma*omegaB*pBc*(alphaTc-1)*(deltaY-1),
                    0,0, deltaC*pBc*(deltaY-1)*(gamma-1)+deltaY*pBc*(deltaC-1)*(gamma-1), 0,
                    deltaC*deltaY*eta*gamma^2*omegaA*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaB-1),
                    -alphaTc*deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    -deltaC*deltaY*eta*gamma^2*kappaC*omegaA*pBc*(alphaTc-1)^2*(omegaB-1),
                    alphaTc*deltaC*deltaY*gamma^2*kappaC*pBc*(alphaTc-1)*(omegaB-1), 
                    deltaC*deltaY*gamma^2*kappaC*omegaA*pBc*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                    deltaC*deltaY*gamma^2*kappaC*pBc*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                    0,0,-alphaTc*deltaC*deltaY*eta*gamma^2*omegaA*pBc*(alphaTc-1),
                    alphaTc^2*deltaC*deltaY*gamma^2*pBc, 
                    alphaTc*deltaC*deltaY*gamma^2*omegaA*pBc*(alphaTc-1)*(eta-1), 
                    alphaTc*deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(omegaA-1),0,
                    deltaC*deltaY*eta*gamma^2*omegaA*omegaB*(alphaTc-1)^2,
                    -alphaTc*deltaC*deltaY*gamma^2*omegaB*pBc*(alphaTc-1),
                    -deltaC*deltaY*gamma^2*omegaA*omegaB*pBc*(alphaTc-1)^2*(eta-1), 
                    -deltaC*deltaY*gamma^2*omegaB*pBc*(alphaTc-1)^2*(omegaA-1),0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,
                    deltaC*deltaY*eta*gamma*omegaA*pBc*(alphaTc-1)*(gamma-1),
                    -alphaTc*deltaC*deltaY*gamma*pBc*(gamma-1),
                    -deltaC*deltaY*pBc*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1)),
                    -deltaC*deltaY*gamma*pBc*(alphaTc-1)*(gamma-1)*(omegaA-1), 0,
                    -deltaC*deltaY*gamma*kappaC*pBc*(alphaTc-1)*(gamma-1)*(omegaB-1), 
                    -alphaTc*deltaC*deltaY*gamma*pBc*(gamma-1),
                    deltaC*deltaY*gamma*omegaB*pBc*(alphaTc-1)*(gamma-1),0,0,
                    deltaC*deltaY*pBc*(gamma-1)^2,
                    -deltaC*deltaY*gamma^2*omegaA*pBc*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1),
                    -deltaC*deltaY*gamma^2*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1),0,0,0,0)
     if(z==10)  ans <- c(1-pBc, -pBc*(deltaC-1),0,0,0,
                         -(deltaC*gamma*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,
                      -(deltaC*gamma*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,
                      deltaC*gamma*kappaC*pBc*(alphaTc-1)*(omegaB-1),
                      alphaTc*deltaC*gamma*pBc, -deltaC*gamma*omegaB*pBc*(alphaTc-1),
                      -deltaC*pBc*(gamma-1),0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0)
     if(z==11)  ans <- c(1-pBc, pBc*(deltaC-1)*(deltaY-1), -alphaTy*deltaY*gamma*pBc*(deltaC-1),
                    deltaY*gamma*kappaY*pBc*(alphaTy-1)*(deltaC-1), 0,
                    (deltaC*gamma*pBc*(alphaTc-1)*(deltaY-1)*(kappaC-1)*(omegaB-1))/2,
                     -deltaY*gamma*pBc*(alphaTy-1)*(deltaC-1)*(kappaY-1),0,
                     (deltaC*gamma*pBc*(alphaTc-1)*(deltaY-1)*(kappaC-1)*(omegaB-1))/2, 0,
                     -deltaC*gamma*kappaC*pBc*(alphaTc-1)*(deltaY-1)*(omegaB-1),
                     -alphaTc*deltaC*gamma*pBc*(deltaY-1),
                     deltaC*gamma*omegaB*pBc*(alphaTc-1)*(deltaY-1),
                     deltaC*pBc*(deltaY-1)*(gamma-1)+deltaY*pBc*(deltaC-1)*(gamma-1),
                     -(alphaTy*deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      (deltaC*deltaY*gamma^2*kappaY*pBc*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 
                     0,0,0,0,0,0,
                     -(alphaTy*deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                     (deltaC*deltaY*gamma^2*kappaY*pBc*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 0,0,
                     -(deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,
                    0,0,0,0,0,0,
                      alphaTy*deltaC*deltaY*gamma^2*kappaC*pBc*(alphaTc-1)*(omegaB-1),
                      -deltaC*deltaY*gamma^2*kappaC*kappaY*pBc*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                      deltaC*deltaY*gamma^2*kappaC*pBc*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,0,
                      alphaTc*alphaTy*deltaY*deltaC*gamma^2*pBc,
                    -alphaTc*deltaC*deltaY*gamma^2*pBc*(alphaTy-1),0,0,
                      alphaTc*deltaC*deltaY*gamma^2*pBc*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC*deltaY*gamma^2*omegaB*pBc*(alphaTc-1),
                      deltaC*deltaY*gamma^2*kappaY*omegaB*pBc*(alphaTc-1)*(alphaTy-1),0,0,
                      -deltaC*deltaY*gamma^2*omegaB*pBc*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC*deltaY*gamma*pBc*(gamma-1),
                    deltaC*deltaY*gamma*kappaY*pBc*(alphaTy-1)*(gamma-1),0,
                      (deltaC*deltaY*pBc*gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,
                      -deltaC*deltaY*gamma*pBc*(alphaTy-1)*(gamma-1)*(kappaY-1),0,
                      (deltaC*deltaY*gamma*pBc*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -deltaC*deltaY*gamma*kappaC*pBc*(alphaTc-1)*(gamma-1)*(omegaB-1),
                      -alphaTc*deltaC*deltaY*gamma*pBc*(gamma-1),
                      deltaC*deltaY*gamma*omegaB*pBc*(alphaTc-1)*(gamma-1),
                      deltaC*deltaY*pBc*(gamma-1)^2,0,
                      -(deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,
                    0,0,0,0)
     if(z==12)  ans <- c(1-pBc, pBc*(deltaC-1)*(deltaY-1),0,
                         deltaY*eta*gamma*omegaA*pBc*(alphaTc-1)*(deltaC-1),
                        -alphaTc*deltaY*gamma*pBc*(deltaC-1), 
                        ((deltaC*gamma*pBc*(alphaTc-1)*(deltaY-1)*(kappaC-1)*(omegaB-1))/2)-deltaY*gamma*omegaA*pBc*
                        (alphaTc-1)*(deltaC-1)*(eta-1),
                        -deltaY*gamma*pBc*(alphaTc-1)*(deltaC-1)*(omegaA-1),0,
                        (deltaC*gamma*pBc*(alphaTc-1)*(deltaY-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC*gamma*kappaC*pBc*(alphaTc-1)*(deltaY-1)*(omegaB-1),
                        -alphaTc*deltaC*gamma*pBc*(deltaY-1),
                        deltaC*gamma*omegaB*pBc*(alphaTc-1)*(deltaY-1),
                        deltaC*pBc*(deltaY-1)*(gamma-1)+deltaY*pBc*(deltaC-1)*(gamma-1),0,
                        (deltaC*deltaY*eta*gamma^2*omegaA*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,
                        0,0,0,0,
                        (deltaC*deltaY*eta*gamma^2*omegaA*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC*deltaY*gamma^2*omegaA*pBc*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC*deltaY*gamma^2*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                        0,0,0,0,0,0,0,
                        -deltaC*deltaY*eta*gamma^2*kappaC*omegaA*pBc*(alphaTc-1)^2*(omegaB-1),
                        alphaTc*deltaC*deltaY*gamma^2*kappaC*pBc*(alphaTc-1)*(omegaB-1),
                        deltaC*deltaY*gamma^2*kappaC*omegaA*pBc*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                        deltaC*deltaY*gamma^2*kappaC*pBc*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),0,0,0,
                        -alphaTc*deltaC*deltaY*eta*gamma^2*omegaA*pBc*(alphaTc-1),
                        alphaTc^2*deltaC*deltaY*gamma^2*pBc,
                        alphaTc*deltaC*deltaY*gamma^2*omegaA*pBc*(alphaTc-1)*(eta-1),
                        alphaTc*deltaC*deltaY*gamma^2*pBc*(alphaTc-1)*(omegaA-1),0,0,0,
                        deltaC*deltaY*eta*gamma^2*omegaA*omegaB*pBc*(alphaTc-1)^2,
                        -alphaTc*deltaC*deltaY*gamma^2*omegaB*pBc*(alphaTc-1),
                        -deltaC*deltaY*gamma^2*pBc*omegaA*omegaB*(alphaTc-1)^2*(eta-1),
                        -deltaC*deltaY*gamma^2*omegaB*pBc*(alphaTc-1)^2*(omegaA-1),0,0,0,
                        deltaC*deltaY*eta*gamma*omegaA*pBc*(alphaTc-1)*(gamma-1),
                        -alphaTc*deltaC*deltaY*gamma*pBc*(gamma-1),
                        -deltaC*deltaY*pBc*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                        -deltaC*deltaY*gamma*pBc*(alphaTc-1)*(gamma-1)*(omegaA-1),0,
                        (deltaY*deltaC*gamma*pBc*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC*deltaY*gamma*kappaC*pBc*(alphaTc-1)*(gamma-1)*(omegaB-1),
                        -alphaTc*deltaC*deltaY*gamma*pBc*(gamma-1),
                        deltaC*deltaY*gamma*omegaB*pBc*(alphaTc-1)*(gamma-1),
                        deltaC*deltaY*pBc*(gamma-1)^2,
                        -(deltaY*deltaC*gamma^2*omegaA*pBc*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC*deltaY*gamma^2*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                        0,0,0,0)

   if(z==13)  ans <- c(1-pBc, pBc*(deltaC-1)^2,0,0,0,
                      gamma*pBc*(alphaTc-1)*(omegaA-1)*(deltaC-deltaC^2)-((gamma*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC-deltaC^2))/2),
                      -eta*gamma*omegaA*pBc*(alphaTc-1)*(deltaC-deltaC^2),
                      alphaTc*gamma*pBc*(deltaC-deltaC^2),
                      gamma*omegaA*pBc*(alphaTc-1)*(eta-1)*(deltaC-deltaC^2)-((gamma*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC-deltaC^2))/2),
                      0, gamma*kappaC*pBc*(alphaTc-1)*(omegaB-1)*(deltaC-deltaC^2),
                      alphaTc*gamma*pBc*(deltaC-deltaC^2),
                      -gamma*omegaB*pBc*(alphaTc-1)*(deltaC-deltaC^2),
                      -2*pBc*(gamma-1)*(deltaC-deltaC^2),0,0,0,0,0,0,0,0,0,0,0,
                      -(deltaC^2*gamma^2*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC^2*eta*gamma^2*omegaA*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC^2*gamma^2*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,
                      0,0,0,0,0,
                      deltaC^2*gamma^2*kappaC*pBc*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                      -deltaC^2*eta*gamma^2*kappaC*omegaA*pBc*(alphaTc-1)^2*(omegaB-1),
                      alphaTc*deltaC^2*gamma^2*kappaC*pBc*(alphaTc-1)*(omegaB-1),
                      deltaC^2*gamma^2*kappaC*pBc*omegaA*(alphaTc-1)^2*(eta-1)*(omegaB-1),0,0,0,
                      alphaTc*deltaC^2*gamma^2*pBc*(alphaTc-1)*(omegaA-1),
                      -alphaTc*deltaC^2*eta*gamma^2*omegaA*pBc*(alphaTc-1),
                      alphaTc^2*deltaC^2*gamma^2*pBc,
                      alphaTc*deltaC^2*gamma^2*omegaA*pBc*(alphaTc-1)*(eta-1),0,0,0,
                      -deltaC^2*gamma^2*omegaB*pBc*(alphaTc-1)^2*(omegaA-1),
                      deltaC^2*eta*gamma^2*omegaA*omegaB*pBc*(alphaTc-1)^2,
                      -alphaTc*deltaC^2*gamma^2*omegaB*pBc*(alphaTc-1),
                      -deltaC^2*gamma^2*omegaA*omegaB*pBc*(alphaTc-1)^2*(eta-1),0,0,0,
                      -deltaC^2*pBc*(gamma*(alphaTc-1)*(gamma-1)*(omegaA-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      deltaC^2*eta*gamma*omegaA*pBc*(alphaTc-1)*(gamma-1),
                      -alphaTc*deltaC^2*gamma*pBc*(gamma-1),
                      -deltaC^2*pBc*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      0,-deltaC^2*gamma*kappaC*pBc*(alphaTc-1)*(gamma-1)*(omegaB-1),
                      -alphaTc*deltaC^2*gamma*pBc*(gamma-1),
                      deltaC^2*gamma*omegaB*pBc*(alphaTc-1)*(gamma-1),deltaC^2*pBc*(gamma-1)^2,
                      -(deltaC^2*gamma^2*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC^2*eta*gamma^2*omegaA*pBc*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC^2*gamma^2*pBc*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      -(deltaC^2*gamma^2*omegaA*pBc*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -(deltaC^2*gamma^2*omegaA*pBc*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2)
   
  if(z==14) ans <- c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)

   return(ans)
 }
)

```

```{r derive stable age dist}

fec.age <- 10
G <- fec.age+3
juv.grp <- c(7:fec.age)
ests <- data.frame(psiN = 0.05, psiB = 0.25, phiA = 0.95, phiC = 0.7, phiY = 0.85)

les_mat <- matrix(0, nrow = G, ncol = G)
les_mat[1,fec.age] <- ests$psiN*ests$phiA #8yo in year t contribute psiN in t+1
les_mat[1,fec.age+1] <- ests$psiN*ests$phiA #9+ in year t contribute psiN in t+1
les_mat[1,fec.age+2] <- 0 #Byoy in year t contribute none in t+1
les_mat[1,fec.age+3] <- ests$psiB*ests$phiA #B.sk in year t contribute psiB in t+1
les_mat[2,1] <- ests$phiY #yearlings
les_mat[3,2] <- ests$phiY
les_mat[4,3] <- ests$phiC
les_mat[5,4] <- ests$phiC
les_mat[6,5] <- ests$phiC
for (i in 1:length(juv.grp)) {
  les_mat[juv.grp[i],juv.grp[i]-1] <- ests$phiA
}
les_mat[(fec.age+1),fec.age] <- ests$phiA*(1-ests$psiN)
les_mat[(fec.age+1),(fec.age+1)] <- ests$phiA*(1-ests$psiN)
les_mat[(fec.age+2),fec.age] <- ests$phiA*ests$psiN
les_mat[(fec.age+2),(fec.age+1)] <- ests$phiA*ests$psiN
les_mat[(fec.age+2),(fec.age+3)] <- ests$phiA*ests$psiB
les_mat[(fec.age+3),(fec.age+2)] <- ests$phiA
les_mat[(fec.age+3),(fec.age+3)] <- ests$phiA*(1-ests$psiB)

ea <- demogR::eigen.analysis(les_mat)
stableAge <- ea$stable.age

```

#### Jags models

```{r random effects model text JAGS}

# THE MODEL:

model.file =  paste0('CIBW_ME_PVA_age', fec.age, '_RE.txt')

sink(paste0('CIBW_ME_PVA_age', fec.age, '_RE.txt'))
cat('
model { 

# M <- function() {
   
  #PRIORS
  
  psiN ~ dunif(0,1)    #first time breeding transition
  gamma ~ dunif(0,1)   # P(calf can be put in an age category vs unknown)
  alphaTy ~ dunif(0,1) # P(a YOY calf is identified as such without uncertainty)
  alphaTc ~ dunif(0,1) # P(a 1,2,3, or 4yo calf is identified as such without uncertainty)
  kappaY ~ dunif(0,1)  # P(a YOY is assigned to J1- category)
  kappaC ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J2+ or J3+ categories respectively)
  omegaA ~ dunif(0,1)  # P(a YOY is assigned J1+)
  omegaB ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J3+ or J4+ categories respectively)
  eta ~ dunif(0,1)  # P(being at top of allowable age class)
  
    for (t in 1:(nyears.ch-1)){  #data starts in 2005, plus 12 survival periods to 2017
        logit(phiB[t]) <- l.phiB + eps.phiB[t]
        logit(phiN[t]) <- l.phiN + eps.phiN[t]
        logit(phiC[t]) <- l.phiC + eps.phiC[t] + l.phiC.corr 
        logit(phiY[t]) <- l.phiY + eps.phiY[t] 
        logit(psiB[t]) <- l.psiB + eps.psiB[t] 
            
      logit(pN[t]) <- l.pN + eps.pN[t] + b.eff*eff[t+1] 
      logit(pBn[t]) <- l.pBn + eps.pBn[t] + b.eff*eff[t+1] 
      logit(pBc[t]) <- l.pBc + eps.pBc[t] + b.eff*eff[t+1] 
      
    } #t
    
  for (t in 1:(nyears.ch)){  #data starts in 2005, plus 12 survival periods to 2017

      logit(deltaY[t]) <- l.deltaY + eps.deltaY[t] + b.eff*eff[t] 
      logit(deltaC[t]) <- l.deltaC + eps.deltaC[t] + b.eff*eff[t] 
      
      } # t
  
     l.phiB <- log(mu.phiB/(1 - mu.phiB))
     mu.phiB ~ dunif(0.5, 1)
     l.phiN <- log(mu.phiN/(1 - mu.phiN))
     mu.phiN ~ dunif(0.5, 1)
     l.phiC <- log(mu.phiC/(1 - mu.phiC))
     mu.phiC ~ dunif(0.3, 1)
     l.phiY <- log(mu.phiY/(1 - mu.phiY))
     mu.phiY ~ dunif(0.5, 1)
     
     l.psiB <- log(mu.psiB/(1 - mu.psiB))
     mu.psiB ~ dunif(0,1)
     
     l.pN <- log(mu.pN/(1-mu.pN))
     mu.pN ~ dunif(0,1)
     l.pBn <- log(mu.pBn/(1-mu.pBn))
     mu.pBn ~ dunif(0,1)
     l.pBc <- log(mu.pBc/(1-mu.pBc))
     mu.pBc ~ dunif(0,1)
     l.deltaY <- log(mu.deltaY/(1-mu.deltaY))
     mu.deltaY ~ dunif(0,1)
     l.deltaC <- log(mu.deltaC/(1-mu.deltaC))
     mu.deltaC ~ dunif(0,1)
     
     l.phiC.corr ~ dunif(0,3)
     phiC.corr.prob <- 1/(1+exp(-l.phiC.corr))
     
     #effort covariate 
     b.eff ~ dnorm(0,0.001)
        
    for (t in 1:(nyears.ch-1)){
    eps.phiB[t] ~ dnorm(0,tau.phiB)T(-10,10)
    eps.phiN[t] ~ dnorm(0,tau.phiB)T(-10,10) 
    eps.phiC[t] ~ dnorm(0,tau.phiC)T(-10,10)
    eps.phiY[t] ~ dnorm(0,tau.phiY)T(-10,10)
    eps.psiB[t] ~ dnorm(0,tau.psiB)T(-10,10) 
    eps.pN[t] ~ dnorm(0, tau.pN)T(-10,10)
    eps.pBn[t] ~ dnorm(0, tau.pBn)T(-10,10)
    eps.pBc[t] ~ dnorm(0, tau.pBc)T(-10,10)
    
    }
    
    for (t in 1:(nyears.ch)){
        eps.deltaC[t] ~ dnorm(0, tau.deltaC)T(-10,10)
        eps.deltaY[t] ~ dnorm(0, tau.deltaY)T(-10,10)
        }

    sigma.phiB ~ dexp(1)T(0.2,)
    sigma.phiC ~ dexp(1)T(0.2,)
    sigma.phiY ~ dexp(1)T(0.2,)
    sigma.psiB ~ dexp(1)T(0.2,)
    
    sigma.pN ~ dexp(1)
    sigma.pBn ~ dexp(1)
    sigma.pBc ~ dexp(1)
    sigma.deltaC ~ dexp(1)
    sigma.deltaY ~ dexp(1)

    tau.phiB <- pow(sigma.phiB, -2)
    tau.phiC <- pow(sigma.phiC, -2)
    tau.phiY <- pow(sigma.phiY, -2)
    tau.psiB <- pow(sigma.psiB, -2)
    tau.pN <- pow(sigma.pN, -2)
    tau.pBn <- pow(sigma.pBn, -2)
    tau.pBc <- pow(sigma.pBc, -2)
    tau.deltaC <- pow(sigma.deltaC, -2)
    tau.deltaY <- pow(sigma.deltaY, -2)
    
    ## backtransform to probability scale
    for (t in 1:(nyears.ch-1)) {
      phiB.prob[t] <- 1/(1+exp(-(l.phiB + eps.phiB[t])))
      phiN.prob[t] <- 1/(1+exp(-(l.phiN + eps.phiN[t])))
      phiY.prob[t] <- 1/(1+exp(-(l.phiY + eps.phiY[t])))
      phiC.prob[t] <- 1/(1+exp(-(l.phiC + l.phiC.corr + eps.phiC[t])))
      psiB.prob[t] <- 1/(1+exp(-(l.psiB + eps.psiB[t]))) 
      phiY.true.prob[t] <- phiB.prob[t]*phiY.prob[t]
      phiC.true.prob[t] <- phiB.prob[t]*phiC.prob[t]

      pBc.prob[t] <- 1/(1+exp(-(l.pBc + eps.pBc[t] + b.eff*eff[t+1])))
      pBn.prob[t] <- 1/(1+exp(-(l.pBn + eps.pBn[t] + b.eff*eff[t+1])))
      pN.prob[t] <- 1/(1+exp(-(l.pN + eps.pN[t] + b.eff*eff[t+1])))
    }
    
    for (t in 1:(nyears.ch)) {
      deltaY.prob[t] <- 1/(1+exp(-(l.deltaY + eps.deltaY[t] + b.eff*eff[t])))
      deltaC.prob[t] <- 1/(1+exp(-(l.deltaC + eps.deltaC[t] + b.eff*eff[t])))
    }
  
  #set Dirichlet priors for initial states 1:12 (Byoy to Bc4c2; excludes dead state which = 0)
  for (i in 1:13) {
    beta[i] ~ dgamma(1,1) #induce Dirichlet prior
    pi[i]<-beta[i]/sum(beta[])
  }
  
    ##### Population model ####

  #Initialize population assuming stable age distribution - year 2004, fills N[1,]

  # conditional binomials
   # total abundance
   Ntot[1] ~ dpois(pop_init)
   pop_init ~ dunif(250,400)

  # age categories
   N[1,1] ~ dbin(stableAge[1], Ntot[1]) #YOTY

   # group 2:(G-1) prob of group g given not in any previous group
   for(g in 2:(G-1)){
    N[1,g] ~ dbin(stableAge[g]/(1-sum(stableAge[1:(g-1)])), Ntot[1] - sum(N[1,1:(g-1)]) )
   }

   # group G: deterministic
   N[1,G] <- Ntot[1] - sum(N[1,1:(G-1)])

    A.NB[1] <- N[1,fec.age+1]
    A.Byoy[1] <- N[1,fec.age+2]
    A.BSk[1] <- N[1,fec.age+3]

  ## Data years

  ### population model state process; 
  
    for (t in 1:1) { #fills N[2,] when t == 1, survival process for 2004-2005
    ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiB*mu.phiY, N[t,1]) #yearlings; use intercepts for years 1 and 14 when no MR data
     N[t+1,3] ~ dbin(mu.phiB*mu.phiY, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(mean(phiC.true.prob), N[t,a-1]) #use phiC.true instead of mu bc need to include offset
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*(mu.psiB), A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])
    
    } #t == 1, populations N[2,] == 2005
 
    for (t in 2:(nyears.ch)){  # when t == 2, starts filling N[3,], using phi[1] for 2005-2006 survival
    # last is when t == 13, 2016-2017, fills N[14,] 
    # for demog rates, use t-1 to align with MR data; t-1 means t==1, which matches phi[1] == for 05-06

     ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(phiY.true.prob[t-1], N[t,1]) #yearlings
     N[t+1,3] ~ dbin(phiY.true.prob[t-1], N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(phiC.true.prob[t-1], N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(phiN.prob[t-1], N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(phiB.prob[t-1]*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(phiB.prob[t-1]*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(phiB.prob[t-1]*(psiB.prob[t-1]), A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(phiB.prob[t-1]*(1-psiB.prob[t-1]), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(phiB.prob[t-1], A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])

    } #t data years

  ## gap year between last ch (2017) and aerial survey (2018): t == 14 fills N[15,]
    for (t in (nyears.ch+1):(nyears.ch+nyears.gap)){

      ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiY*mu.phiB, N[t,1]) #yearlings
     N[t+1,3] ~ dbin(mu.phiY*mu.phiB, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(mean(phiC.true.prob), N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from G-1 yo (here, 8 yo)
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])
     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from fec.age-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*psiN, N[t,fec.age]) #new B.yoy aging from fec.age-1
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*psiN, A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*mu.psiB, A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])
    }

  # Annual abundance

    for (t in 2:(nyears.ch+nyears.gap+1)) {
      Ntot[t] <- round(sum(N[t, 1:G]))
    } # t

     # Aerial survey model

    for (t in 1:(length(grp.years))){
      N_mu[t] ~ dnorm(N_obs[t], N_tau[t]) #observation error on cnts to estimate N_obs
      
      p_grp[t] ~ dbeta(1,1) #group detection probability; vague
      
      ##other priors used for appendix
      # p_grp[t] ~ dbeta(10,3) #group detection probability; peaks at 0.8 more pointy
      # p_grp[t] ~ dbeta(2,1) #group detection probability; broad peaking at 0.9
      # p_grp[t] ~ dbeta(15.35, 1.51) #most restrictive
      N_obs[t] ~ dbin(p_grp[t], round(Ntot[grp.years[t]])) #counts of true state (abundance)
    } #t
  
  # DEFINE PARAMETERS	
  # probabilities for each INITIAL STATE
  px0[1] <- pi[1] # prob. of initial state NB
  px0[2] <- pi[2] # prob. of being in initial state Byoy
  px0[3] <- pi[3] # prob. of being in initial state Bc1
  px0[4] <- pi[4] # prob. of being in initial state Bc2
  px0[5] <- pi[5] # prob. of being in initial state Bc2yoy
  px0[6] <- pi[6] # prob. of being in initial state Bc3
  px0[7] <- pi[7] # prob. of being in initial state Bc3yoy
  px0[8] <- pi[8] # prob. of being in initial state Bc3c1
  px0[9] <- pi[9] # prob. of being in initial state Bc4
  px0[10] <- pi[10] # prob. of being in initial state Bc4yoy
  px0[11] <- pi[11] # prob. of being in initial state Bc4c1
  px0[12] <- pi[12] # prob of initial state Bc4c2
  px0[13] <- pi[13]
  px0[14] <- 0 # prob. of being in initial state dead
  
  for (i in 1:n_ind){
    for (t in 1:(nyears.ch)) {
      
      #initial observation matrix; same as obs proc matrix without detection, or p == 1
  po.init[1,1:72,i,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[2,1:72,i,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[3,1:72,i,t] <- c(1-1,-1*(deltaY[t]-1), alphaTy*deltaY[t]*1*gamma, -deltaY[t]*gamma*kappaY*1*(alphaTy-1), 
                    0, 0, deltaY[t]*gamma*1*(alphaTy-1)*(kappaY-1), 0,0,0,0,0,0,
                    -deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[4,1:72,i,t] <- c(1-1,-1*(deltaY[t]-1), 0, -deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaY[t]*1*gamma,                       deltaY[t]*1*gamma*omegaA*(alphaTc-1)*(eta-1), deltaY[t]*gamma*1*(alphaTc-1)*(omegaA-1), 0,0,
                    0,0,0,0,-deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[5,1:72,i,t] <- c(1-1,-1*(deltaC[t]-1), 0,0,0, deltaC[t]*1*gamma*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaC[t]*1*gamma,
                    (alphaTc-1)*(eta-1)*deltaC[t]*1*gamma*omegaA,0,0,0,
                    0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[6,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),
                    -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    -deltaC[t]*gamma*1*(alphaTc-1)*(omegaA-1)*(deltaY[t]-1),
                  deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaY[t]-1)-deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    -deltaC[t]*1*gamma*omegaA*(alphaTc-1)*(deltaY[t]-1)*(eta-1),
                    0,0,0,0,
                    deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaA-1), 0,
                    -alphaTy*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*eta*gamma^2*kappaY*omegaA*(alphaTc-1)*(alphaTy-1),
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1),
                    0,0,deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    -alphaTy*deltaC[t]*deltaY[t]*1*gamma*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*1*(gamma*(alphaTy-1)*(gamma-1)*(kappaY-1)-eta*gamma*omegaA*(alphaTc-1)*(gamma-1)),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    -deltaC[t]*deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(eta-1)*(gamma-1),
                    0,0,0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0, 
                    deltaY[t]*deltaC[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaA-1), 0,0,
                    -deltaC[t]*deltaY[t]*eta*(gamma^2)*omegaA*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0)
  po.init[7,1:72,i,t] <- c(1-1, -1*(deltaC[t]-1), 0,0,0,-deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,
                    deltaC[t]*1*gamma*kappaC*(alphaTc-1)*(omegaB-1),alphaTc*deltaC[t]*1*gamma,
                    -deltaC[t]*gamma*omegaB*1*(alphaTc-1), 0,0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[8,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*1*gamma*(deltaC[t]-1), 
                      deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1),0,
                    deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1),
                    -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0,deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),0,0,
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1), 
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1), 0,0,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),
                    0,-deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0,
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1),
                    0,0,0,0)
  po.init[9,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), 0, deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                    -alphaTc*deltaY[t]*1*gamma*(deltaC[t]-1),
                    deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(deltaY[t]-1)*(omegaB-1)-
                    deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1)*(eta-1),
                    -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1), 0, 
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),-alphaTc*deltaC[t]*gamma*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0, deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1), 0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1), 
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                    0,0,-alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1, 
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1), 
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*(alphaTc-1)^2,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1), 
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), #check next
                    -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1)),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1), 0,
                    -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1), 
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1),0,0,0,0)
  po.init[10,1:72,i,t] <- c(1-1, -1*(deltaC[t]-1),0,0,0, -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,
                      -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,deltaC[t]*gamma*kappaC*(alphaTc-1)*(omegaB-1),
                      alphaTc*deltaC[t]*gamma*1, -deltaC[t]*gamma*omegaB*1*(alphaTc-1),
                      -deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[11,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),
                    deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,
                     -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                     (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2, 0,
                     -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                     -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                     deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                     deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 
                     0,0,0,0,0,0,
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                     (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 0,0,
                     -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0,0,0,
                      alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                      deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,0,
                      alphaTc*alphaTy*deltaY[t]*deltaC[t]*gamma^2*1, -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1),0,0,
                      alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                      deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1),0,0,
                      -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                      (deltaC[t]*deltaY[t]*1*gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,
                      -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),0,
                      (deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                      -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                      deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                      deltaC[t]*deltaY[t]*1*(gamma-1)^2,0,
                      -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0)
  po.init[12,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),0,deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                        -alphaTc*deltaY[t]*gamma*1*(deltaC[t]-1), 
                        ((deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2)-deltaY[t]*gamma*omegaA*1*
                        (alphaTc-1)*(deltaC[t]-1)*(eta-1),
                        -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1),0,
                        (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1), -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                        deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                        deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0,0,0,0,
                        -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),0,0,0,
                        -alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                        alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1,
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                        -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                        -deltaC[t]*deltaY[t]*gamma^2*1*omegaA*omegaB*(alphaTc-1)^2*(eta-1),
                        -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                        -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                        -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),0,
                        (deltaY[t]*deltaC[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                        deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                        -(deltaY[t]*deltaC[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0)
  po.init[13,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)^2,0,0,0,
                      gamma*1*(alphaTc-1)*(omegaA-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      -eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2), alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      gamma*omegaA*1*(alphaTc-1)*(eta-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      0, gamma*kappaC*1*(alphaTc-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2), 
                      alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      -gamma*omegaB*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2), 
                      -2*1*(gamma-1)*(deltaC[t]-deltaC[t]^2),0,0,0,0,0,0,0,0,0,0,0,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,0,0,
                      deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                      -deltaC[t]^2*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                      alphaTc*deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      deltaC[t]^2*gamma^2*kappaC*1*omegaA*(alphaTc-1)^2*(eta-1)*(omegaB-1),0,0,0,
                      alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(omegaA-1),
                      -alphaTc*deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1),
                      alphaTc^2*deltaC[t]^2*gamma^2*1,
                      alphaTc*deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),0,0,0,
                      -deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),
                      deltaC[t]^2*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                      -alphaTc*deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1),
                      -deltaC[t]^2*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1),0,0,0,
                      -deltaC[t]^2*1*(gamma*(alphaTc-1)*(gamma-1)*(omegaA-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      deltaC[t]^2*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      -deltaC[t]^2*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      0,-deltaC[t]^2*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      deltaC[t]^2*gamma*omegaB*1*(alphaTc-1)*(gamma-1),deltaC[t]^2*1*(gamma-1)^2,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2)
  po.init[14,1:72,i,t] <- c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
    }
  }
  
    for (i in 1:n_ind){
    for (t in 1:(nyears.ch-1)) {

  #observation process matrix
  po[1,1:72,i,t] <- c(1-pN[t],pN[t],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[2,1:72,i,t] <- c(1-pBn[t],pBn[t],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[3,1:72,i,t] <- c(1-pBc[t],-pBc[t]*(deltaY[t+1]-1), alphaTy*deltaY[t+1]*pBc[t]*gamma, -deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1), 
                    0, 0, deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(kappaY-1), 0,0,0,0,0,0,
                    -deltaY[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[4,1:72,i,t] <- c(1-pBc[t],-pBc[t]*(deltaY[t+1]-1), 0, -deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1), alphaTc*deltaY[t+1]*pBc[t]*gamma,                       deltaY[t+1]*pBc[t]*gamma*omegaA*(alphaTc-1)*(eta-1), deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(omegaA-1), 0,0,
                    0,0,0,0,-deltaY[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[5,1:72,i,t] <- c(1-pBc[t],-pBc[t]*(deltaC[t+1]-1), 0,0,0, deltaC[t+1]*pBc[t]*gamma*(alphaTc-1)*(omegaA-1),
                    -deltaC[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1), alphaTc*deltaC[t+1]*pBc[t]*gamma,
                    (alphaTc-1)*(eta-1)*deltaC[t+1]*pBc[t]*gamma*omegaA,0,0,0,
                    0,-deltaC[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[6,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1),
                    -alphaTy*deltaY[t+1]*gamma*pBc[t]*(deltaC[t+1]-1),deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1), 0,
                    -deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(omegaA-1)*(deltaY[t+1]-1),
                  deltaC[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)-deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1)*(kappaY-1),
                    -alphaTc*deltaC[t+1]*gamma*pBc[t]*(deltaY[t+1]-1),
                    -deltaC[t+1]*pBc[t]*gamma*omegaA*(alphaTc-1)*(deltaY[t+1]-1)*(eta-1),
                    0,0,0,0,
                    deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1),
                    alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(omegaA-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(omegaA-1), 0, #here
                    -alphaTy*deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1),
                    deltaC[t+1]*deltaY[t+1]*eta*gamma^2*kappaY*omegaA*pBc[t]*(alphaTc-1)*(alphaTy-1),
                    alphaTc*alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t],
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTy-1),
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTy-1)*(kappaY-1),
                    alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(eta-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*omegaA*pBc[t]*(alphaTc-1)*(alphaTy-1)*(eta-1),
                    0,0,deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(alphaTy-1)*(eta-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    -alphaTy*deltaC[t+1]*deltaY[t+1]*pBc[t]*gamma*(gamma-1),
                    deltaC[t+1]*deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(gamma-1),0,
                    -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaA-1),
                    -deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma*(alphaTy-1)*(gamma-1)*(kappaY-1)-eta*gamma*omegaA*(alphaTc-1)*(gamma-1)),
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma*omegaA*pBc[t]*(alphaTc-1)*(eta-1)*(gamma-1),
                    0,0,0,0,
                    deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2, 0, 
                    deltaY[t+1]*deltaC[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaA-1), 0,0,
                    -deltaC[t+1]*deltaY[t+1]*eta*(gamma^2)*omegaA*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0)
  po[7,1:72,i,t] <- c(1-pBc[t], -pBc[t]*(deltaC[t+1]-1), 0,0,0,-deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,
                    deltaC[t+1]*pBc[t]*gamma*kappaC*(alphaTc-1)*(omegaB-1),alphaTc*deltaC[t+1]*pBc[t]*gamma,
                    -deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1), 0,0,-deltaC[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[8,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1), -alphaTy*deltaY[t+1]*pBc[t]*gamma*(deltaC[t+1]-1), 
                      deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1),0,
                    deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1),
                    -deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1)*(kappaY-1),0,
                    -deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(omegaB-1),
                    -alphaTc*deltaC[t+1]*gamma*pBc[t]*(deltaY[t+1]-1),
                    deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1),
                    0,0,deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1),
                    -alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1),
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,
                    alphaTc*alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t],
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTy-1),0,0,
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTy-1)*(kappaY-1), 
                    -alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*omegaB*pBc[t]*(alphaTc-1)*(alphaTy-1), 0,0,
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-alphaTy*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                    deltaC[t+1]*deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(gamma-1),0,
                    deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(gamma-1)*(kappaY-1),
                    0,-deltaC[t+1]*deltaY[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                    deltaC[t+1]*deltaY[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2, 0, -deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1),
                    0,0,0,0)
  po[9,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1), 0, deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1),
                    -alphaTc*deltaY[t+1]*pBc[t]*gamma*(deltaC[t+1]-1),
                    deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(deltaY[t+1]-1)*(omegaB-1)-
                    deltaY[t+1]*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1)*(eta-1),
                    -deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1)*(omegaA-1), 0, 
                    -deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(omegaB-1),-alphaTc*deltaC[t+1]*gamma*(deltaY[t+1]-1),
                    deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1),
                    0,0, deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1), 0,
                    deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1),
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    -deltaC[t+1]*deltaY[t+1]*eta*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(omegaB-1),
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1), 
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                    0,0,-alphaTc*deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1),
                    alphaTc^2*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t], 
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(eta-1), 
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(omegaA-1),0,
                    deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*omegaB*(alphaTc-1)^2,
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*omegaB*pBc[t]*(alphaTc-1)^2*(eta-1), 
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1)^2*(omegaA-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    deltaC[t+1]*deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(gamma-1),
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                    -deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1)),
                    -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaA-1), 0,
                    -deltaC[t+1]*deltaY[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1), 
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),deltaC[t+1]*deltaY[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2,
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1),0,0,0,0)
  po[10,1:72,i,t] <- c(1-pBc[t], -pBc[t]*(deltaC[t+1]-1),0,0,0, -(deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,
                      -(deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,
                      deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                      alphaTc*deltaC[t+1]*gamma*pBc[t], -deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1),
                      -deltaC[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[11,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1), -alphaTy*deltaY[t+1]*gamma*pBc[t]*(deltaC[t+1]-1),
                    deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1), 0,
                    (deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1))/2,
                     -deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1)*(kappaY-1),0,
                     (deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1))/2, 0,
                     -deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(omegaB-1),
                     -alphaTc*deltaC[t+1]*gamma*pBc[t]*(deltaY[t+1]-1),
                     deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1),
                     deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1),
                     -(alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      (deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 
                     0,0,0,0,0,0,
                     -(alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                     (deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 0,0,
                     -(deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0,0,0,
                      alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                      -deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                      deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,0,
                      alphaTc*alphaTy*deltaY[t+1]*deltaC[t+1]*gamma^2*pBc[t], -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTy-1),0,0,
                      alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                      deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*omegaB*pBc[t]*(alphaTc-1)*(alphaTy-1),0,0,
                      -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1), deltaC[t+1]*deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(gamma-1),0,
                      (deltaC[t+1]*deltaY[t+1]*pBc[t]*gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,
                      -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(gamma-1)*(kappaY-1),0,
                      (deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -deltaC[t+1]*deltaY[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1),
                      -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                      deltaC[t+1]*deltaY[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),
                      deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2,0,
                      -(deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0)
  po[12,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1),0,deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1),
                        -alphaTc*deltaY[t+1]*gamma*pBc[t]*(deltaC[t+1]-1), 
                        ((deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1))/2)-deltaY[t+1]*gamma*omegaA*pBc[t]*
                        (alphaTc-1)*(deltaC[t+1]-1)*(eta-1),
                        
                        -deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1)*(omegaA-1),0,
                        (deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(omegaB-1), -alphaTc*deltaC[t+1]*gamma*pBc[t]*(deltaY[t+1]-1),
                        deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1),
                        deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1),0,
                        (deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,
                        (deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0,0,0,0,
                        -deltaC[t+1]*deltaY[t+1]*eta*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(omegaB-1),
                        alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                        deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                        deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),0,0,0,
                        -alphaTc*deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1),
                        alphaTc^2*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t],alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(eta-1),
                        alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(omegaA-1),0,0,0,
                        deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*omegaB*pBc[t]*(alphaTc-1)^2,
                        -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                        -deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*omegaA*omegaB*(alphaTc-1)^2*(eta-1),
                        -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1)^2*(omegaA-1),0,0,0,
                        deltaC[t+1]*deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(gamma-1),
                        -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                        -deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                        -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaA-1),0,
                        (deltaY[t+1]*deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t+1]*deltaY[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                        deltaC[t+1]*deltaY[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),
                        deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2,
                        -(deltaY[t+1]*deltaC[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0)
  po[13,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)^2,0,0,0,
                      gamma*pBc[t]*(alphaTc-1)*(omegaA-1)*(deltaC[t+1]-deltaC[t+1]^2)-((gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t+1]-deltaC[t+1]^2))/2),
                      -eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaC[t+1]-deltaC[t+1]^2), alphaTc*gamma*pBc[t]*(deltaC[t+1]-deltaC[t+1]^2),
                      gamma*omegaA*pBc[t]*(alphaTc-1)*(eta-1)*(deltaC[t+1]-deltaC[t+1]^2)-((gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t+1]-deltaC[t+1]^2))/2),
                      0, gamma*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1)*(deltaC[t+1]-deltaC[t+1]^2), alphaTc*gamma*pBc[t]*(deltaC[t+1]-deltaC[t+1]^2),
                      -gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaC[t+1]-deltaC[t+1]^2), -2*pBc[t]*(gamma-1)*(deltaC[t+1]-deltaC[t+1]^2),0,0,0,0,0,0,0,0,0,0,0,
                      -(deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t+1]^2*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,0,0,
                      deltaC[t+1]^2*gamma^2*kappaC*pBc[t]*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                      -deltaC[t+1]^2*eta*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(omegaB-1),
                      alphaTc*deltaC[t+1]^2*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                      deltaC[t+1]^2*gamma^2*kappaC*pBc[t]*omegaA*(alphaTc-1)^2*(eta-1)*(omegaB-1),0,0,0,
                      alphaTc*deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)*(omegaA-1),
                      -alphaTc*deltaC[t+1]^2*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1),
                      alphaTc^2*deltaC[t+1]^2*gamma^2*pBc[t],
                      alphaTc*deltaC[t+1]^2*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(eta-1),0,0,0,
                      -deltaC[t+1]^2*gamma^2*omegaB*pBc[t]*(alphaTc-1)^2*(omegaA-1),
                      deltaC[t+1]^2*eta*gamma^2*omegaA*omegaB*pBc[t]*(alphaTc-1)^2,
                      -alphaTc*deltaC[t+1]^2*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                      -deltaC[t+1]^2*gamma^2*omegaA*omegaB*pBc[t]*(alphaTc-1)^2*(eta-1),0,0,0,
                      -deltaC[t+1]^2*pBc[t]*(gamma*(alphaTc-1)*(gamma-1)*(omegaA-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      deltaC[t+1]^2*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(gamma-1),-alphaTc*deltaC[t+1]^2*gamma*pBc[t]*(gamma-1),
                      -deltaC[t+1]^2*pBc[t]*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      0,-deltaC[t+1]^2*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t+1]^2*gamma*pBc[t]*(gamma-1),
                      deltaC[t+1]^2*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),deltaC[t+1]^2*pBc[t]*(gamma-1)^2,
                      -(deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t+1]^2*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      -(deltaC[t+1]^2*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -(deltaC[t+1]^2*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2)
  po[14,1:72,i,t] <- c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)


  # STATE PROCESS: probabilities of states at t+1 (columns) given states at t (rows)
 px[1,1:14,i,t] <- c(-phiN[t]*(psiN-1),0,phiN[t]*psiN,0,0,0,0,0,0,0,0,0,0,1-phiN[t])
 px[2,1:14,i,t] <- c(0,-phiB[t]*(psiB[t]-1),phiB[t]*psiB[t],0,0,0,0,0,0,0,0,0,0,1-phiB[t])
 px[3,1:14,i,t] <- c(0,-phiB[t]*(phiY[t]-1),0,phiB[t]*phiY[t],0,0,0,0,0,0,0,0,0,1-phiB[t])
 px[4,1:14,i,t] <- c(0,phiB[t]*(phiY[t]-1)*(psiB[t]-1),-phiB[t]*psiB[t]*(phiY[t]-1),0,
                     -phiB[t]*phiY[t]*(psiB[t]-1), phiB[t]*phiY[t]*psiB[t],0,0,0,0,0,0,0,1-phiB[t])
 px[5,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(psiB[t]-1),-phiB[t]*psiB[t]*(phiC[t]-1),0,0,0,
                     -phiB[t]*phiC[t]*(psiB[t]-1),phiB[t]*phiC[t]*psiB[t],0,0,0,0,0,1-phiB[t])
 px[6,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(phiY[t]-1),0,-phiB[t]*phiY[t]*(phiC[t]-1),0,0,
                     -phiB[t]*phiC[t]*(phiY[t]-1),0,phiB[t]*phiC[t]*phiY[t],0,
                     0,0,0,1-phiB[t])
 px[7,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(psiB[t]-1),-phiB[t]*psiB[t]*(phiC[t]-1),
                     0,0,0,0,0,0,-phiB[t]*phiC[t]*(psiB[t]-1),
                     phiB[t]*phiC[t]*psiB[t],0,0,1-phiB[t])
 px[8,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(phiY[t]-1),0,-phiB[t]*phiY[t]*(phiC[t]-1),0,0,
                     0,0,0,-phiB[t]*phiC[t]*(phiY[t]-1),0,
                     phiB[t]*phiC[t]*phiY[t],0,1-phiB[t])
 px[9,1:14,i,t] <- c(0,-phiB[t]*(phiC[t]-1)*(phiY[t]-1)*(psiB[t]-1),
                     phiB[t]*psiB[t]*(phiC[t]-1)*(phiY[t]-1),0,
                     phiB[t]*phiY[t]*(phiC[t]-1)*(psiB[t]-1),
                     -phiB[t]*phiY[t]*psiB[t]*(phiC[t]-1),0,0,0,
                     phiB[t]*phiC[t]*(phiY[t]-1)*(psiB[t]-1),
                     -phiB[t]*phiC[t]*psiB[t]*(phiY[t]-1),0,phiB[t]*phiC[t]*phiY[t],1-phiB[t])
 px[10,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(psiB[t]-1),-phiB[t]*psiB[t]*(phiC[t]-1),0,0,0,0,
                      0,0,-phiB[t]*phiC[t]*(psiB[t]-1),phiB[t]*phiC[t]*psiB[t],0,0,1-phiB[t])
 px[11,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(phiY[t]-1),0,-phiB[t]*phiY[t]*(phiC[t]-1),0,0,0,0,
                      0,-phiB[t]*phiC[t]*(phiY[t]-1),0,phiB[t]*phiC[t]*phiY[t],0,1-phiB[t])
 px[12,1:14,i,t] <- c(0,-phiB[t]*(phiC[t]-1)*(phiY[t]-1)*(psiB[t]-1),
                      phiB[t]*psiB[t]*(phiC[t]-1)*(phiY[t]-1),0,
                      phiB[t]*phiY[t]*(phiC[t]-1)*(psiB[t]-1),-phiB[t]*phiY[t]*psiB[t]*(phiC[t]-1),0,
                      0,0,phiB[t]*phiC[t]*(phiY[t]-1)*(psiB[t]-1),
                      -phiB[t]*phiC[t]*psiB[t]*(phiY[t]-1),0,phiB[t]*phiC[t]*phiY[t],1-phiB[t])
 px[13,1:14,i,t] <- c(0,-phiB[t]*(phiC[t]-1)^2*(psiB[t]-1), phiB[t]*psiB[t]*(phiC[t]-1)^2,0,0,0,
                      phiB[t]*phiC[t]*(phiC[t]-1)*(psiB[t]-1),
                      -phiB[t]*phiC[t]*psiB[t]*(phiC[t]-1),0,phiB[t]*phiC[t]*(phiC[t]-1)*(psiB[t]-1),
                      -phiB[t]*phiC[t]*psiB[t]*(phiC[t]-1),0,phiB[t]*phiC[t]^2,1-phiB[t])
 px[14,1:14,i,t] <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1)
    }
  }
  
  ##### Likelihoods ######
  for (i in 1:n_ind) { # loop over each individual
    # estimated probabilities of initial states are the proportions in each state at 
    # first capture occasion
    z[i,First[i]] ~ dcat(px0[1:n.states])
    y[i,First[i]] ~ dcat(po.init[z[i,First[i]],1:n.obs,i,First[i]])

    for (j in (First[i]+1):nyears.ch) { # loop over time
      ## STATE EQUATIONS ##
      # draw states at j given states at j-1
      z[i,j] ~ dcat(px[z[i,j-1],1:n.states,i,j-1])
      
      ## OBSERVATION EQUATIONS ##
      # draw observations at j given states at j
      y[i,j] ~ dcat(po[z[i,j],1:n.obs,i,j-1]) 

      
    } #j
  } #i
  
} #mod
  
', fill = TRUE)
sink()

```


```{r covariate model text JAGS}

# THE MODEL:

model.file =  paste0('CIBW_ME_PVA_age', fec.age, '_env.txt')


sink(paste0('CIBW_ME_PVA_age', fec.age, '_env.txt'))
cat('
model { 

# M <- function() {
   
  #PRIORS
  
  psiN ~ dunif(0,1)    # first time breeding transition
  gamma ~ dunif(0,1)   # P(calf can be put in an age category vs unknown)
  alphaTy ~ dunif(0,1) # P(a YOY calf is identified as such without uncertainty)
  alphaTc ~ dunif(0,1) # P(a 1,2,3, or 4yo calf is identified as such without uncertainty)
  kappaY ~ dunif(0,1)  # P(a YOY is assigned to J1- category)
  kappaC ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J2+ or J3+ categories respectively)
  omegaA ~ dunif(0,1)  # P(a YOY is assigned J1+)
  omegaB ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J3+ or J4+ categories respectively)
  eta ~ dunif(0,1)     # P(being at top of allowable age class)
  
    for (t in 1:(nyears.ch-1)){  #data starts in 2005, plus 12 survival periods to 2017
        logit(phiB[t]) <- l.phiB + 
            b.sst_goa.b*sst_goa[t] +
            b.all_fish.b*all_fish[t] +
            eps.phiB[t]
          logit(phiN[t]) <- l.phiN + 
            b.sst_goa.b*sst_goa[t] +
            b.all_fish.b*all_fish[t] +
            eps.phiN[t]
        logit(phiC[t]) <- l.phiC + 
            b.sst_goa.c*sst_goa[t] +
            b.all_fish.c*all_fish[t] +
            eps.phiC[t] + l.phiC.corr 
        logit(phiY[t]) <- l.phiY + 
            b.sst_goa.y*sst_goa[t] +
            b.all_fish.y*all_fish[t] +
            eps.phiY[t] 
        logit(psiB[t]) <- l.psiB + eps.psiB[t] + 
            b.sst_goa.psi*sst_goa[t] +
            b.all_fish.psi*all_fish[t] 
            
      logit(pN[t]) <- l.pN + eps.pN[t] + b.eff*eff[t+1] #b.eff[eff[t]]
      logit(pBn[t]) <- l.pBn + eps.pBn[t] + b.eff*eff[t+1] #b.eff[eff[t]]
      logit(pBc[t]) <- l.pBc + eps.pBc[t] + b.eff*eff[t+1] #b.eff[eff[t]]
      
    } #t
    
  for (t in 1:(nyears.ch)){  #data starts in 2005, plus 13 detections to 2017

      logit(deltaY[t]) <- l.deltaY + eps.deltaY[t] + b.eff*eff[t] #b.eff[eff[t]]
      logit(deltaC[t]) <- l.deltaC + eps.deltaC[t] + b.eff*eff[t] #b.eff[eff[t]]
      
      } # t
  
     l.phiB <- log(mu.phiB/(1 - mu.phiB))
     mu.phiB ~ dunif(0.5, 1)
     l.phiN <- log(mu.phiN/(1 - mu.phiN))
     mu.phiN ~ dunif(0.5, 1)
     l.phiC <- log(mu.phiC/(1 - mu.phiC))
     mu.phiC ~ dunif(0.3, 1)
     l.phiY <- log(mu.phiY/(1 - mu.phiY))
     mu.phiY ~ dunif(0.5, 1)
     l.psiB <- log(mu.psiB/(1 - mu.psiB))
     mu.psiB ~ dunif(0,1)
     l.pN <- log(mu.pN/(1-mu.pN))
     mu.pN ~ dunif(0,1)
     l.pBn <- log(mu.pBn/(1-mu.pBn))
     mu.pBn ~ dunif(0,1)
     l.pBc <- log(mu.pBc/(1-mu.pBc))
     mu.pBc ~ dunif(0,1)
     l.deltaY <- log(mu.deltaY/(1-mu.deltaY))
     mu.deltaY ~ dunif(0,1)
     l.deltaC <- log(mu.deltaC/(1-mu.deltaC))
     mu.deltaC ~ dunif(0,1)
     
     l.phiC.corr ~ dunif(0,3)
     phiC.corr.prob <- 1/(1+exp(-l.phiC.corr))
     
     #effort -- numeric
     b.eff ~ dnorm(0,0.001)
     
     #fish prey and sst priors -- shrinkage
     
     b.all_fish.b ~ dnorm(0,t.all_fish.b)
     b.all_fish.c ~ dnorm(0,t.all_fish.c)
     b.all_fish.y ~ dnorm(0,t.all_fish.y)
     b.all_fish.psi ~ dnorm(0,t.all_fish.psi)
     s.all_fish.b ~ dexp(1)
     s.all_fish.c ~ dexp(1)
     s.all_fish.y ~ dexp(1)
     s.all_fish.psi ~ dexp(1)
     t.all_fish.b <- pow(s.all_fish.b, -2)
     t.all_fish.c <- pow(s.all_fish.c, -2)
     t.all_fish.y <- pow(s.all_fish.y, -2)
     t.all_fish.psi <- pow(s.all_fish.psi, -2)

     b.sst_goa.b ~ dnorm(0,t.sst_goa.b)
     b.sst_goa.c ~ dnorm(0,t.sst_goa.c)
     b.sst_goa.y ~ dnorm(0,t.sst_goa.y)
     b.sst_goa.psi ~ dnorm(0,t.sst_goa.psi)
     s.sst_goa.b ~ dexp(1)
     s.sst_goa.c ~ dexp(1)
     s.sst_goa.y ~ dexp(1)
     s.sst_goa.psi ~ dexp(1)
     t.sst_goa.b <- pow(s.sst_goa.b, -2)
     t.sst_goa.c <- pow(s.sst_goa.c, -2)
     t.sst_goa.y <- pow(s.sst_goa.y, -2)
     t.sst_goa.psi <- pow(s.sst_goa.psi, -2)
        
    for (t in 1:(nyears.ch-1)){
    eps.phiB[t] ~ dnorm(0,tau.phiB)T(-10,10)
    eps.phiN[t] ~ dnorm(0,tau.phiB)T(-10,10) #assume same standard dev w/ breeders
    eps.phiC[t] ~ dnorm(0,tau.phiC)T(-10,10)
    eps.phiY[t] ~ dnorm(0,tau.phiY)T(-10,10)
    eps.psiB[t] ~ dnorm(0,tau.psiB)T(-10,10) # or mean-centered RE; from -Inf,0
    eps.pN[t] ~ dnorm(0, tau.pN)T(-10,10)
    eps.pBn[t] ~ dnorm(0, tau.pBn)T(-10,10)
    eps.pBc[t] ~ dnorm(0, tau.pBc)T(-10,10)
    
    }
    
    for (t in 1:(nyears.ch)){
        eps.deltaC[t] ~ dnorm(0, tau.deltaC)T(-10,10)
        eps.deltaY[t] ~ dnorm(0, tau.deltaY)T(-10,10)
        }

    sigma.phiB ~ dexp(1)T(0.2,) ##fixed shrinkage w/ truncation
    sigma.phiC ~ dexp(1)T(0.2,)
    sigma.phiY ~ dexp(1)T(0.2,)
    sigma.psiB ~ dexp(1)T(0.2,)
    
    sigma.pN ~ dexp(1)
    sigma.pBn ~ dexp(1)
    sigma.pBc ~ dexp(1)
    sigma.deltaC ~ dexp(1)
    sigma.deltaY ~ dexp(1)

    tau.phiB <- pow(sigma.phiB, -2)
    tau.phiC <- pow(sigma.phiC, -2)
    tau.phiY <- pow(sigma.phiY, -2)
    tau.psiB <- pow(sigma.psiB, -2)
    tau.pN <- pow(sigma.pN, -2)
    tau.pBn <- pow(sigma.pBn, -2)
    tau.pBc <- pow(sigma.pBc, -2)
    tau.deltaC <- pow(sigma.deltaC, -2)
    tau.deltaY <- pow(sigma.deltaY, -2)
    
    ## backtransform to probability scale
    for (t in 1:(nyears.ch-1)) {
      phiB.prob[t] <- 1/(1+exp(-(l.phiB + eps.phiB[t] + b.sst_goa.b*sst_goa[t] +
      b.all_fish.b*all_fish[t])))
      phiN.prob[t] <- 1/(1+exp(-(l.phiN + eps.phiN[t] + b.sst_goa.b*sst_goa[t] +
      b.all_fish.b*all_fish[t])))
      phiY.prob[t] <- 1/(1+exp(-(l.phiY + eps.phiY[t] + b.sst_goa.y*sst_goa[t] +
      b.all_fish.y*all_fish[t])))
      phiC.prob[t] <- 1/(1+exp(-(l.phiC + l.phiC.corr + eps.phiC[t] + b.sst_goa.c*sst_goa[t] +
      b.all_fish.c*all_fish[t])))
      psiB.prob[t] <- 1/(1+exp(-(l.psiB + eps.psiB[t] + b.sst_goa.psi*sst_goa[t] +
      b.all_fish.psi*all_fish[t])))
      phiY.true.prob[t] <- phiB.prob[t]*phiY.prob[t]
      phiC.true.prob[t] <- phiB.prob[t]*phiC.prob[t]
      
      # phiB.prob[t] <- 1/(1+exp(-(l.phiB + eps.phiB[t])))
      # phiN.prob[t] <- 1/(1+exp(-(l.phiN + eps.phiN[t])))
      # phiY.prob[t] <- 1/(1+exp(-(l.phiY + eps.phiY[t])))
      # phiC.prob[t] <- 1/(1+exp(-(l.phiC + l.phiC.corr + eps.phiC[t])))
      # psiB.prob[t] <- 1/(1+exp(-(l.psiB + eps.psiB[t])))

      pBc.prob[t] <- 1/(1+exp(-(l.pBc + eps.pBc[t] + b.eff*eff[t+1])))
      pBn.prob[t] <- 1/(1+exp(-(l.pBn + eps.pBn[t] + b.eff*eff[t+1])))
      pN.prob[t] <- 1/(1+exp(-(l.pN + eps.pN[t] + b.eff*eff[t+1])))
    }
    
    for (t in 1:(nyears.ch)) {
      deltaY.prob[t] <- 1/(1+exp(-(l.deltaY + eps.deltaY[t] + b.eff*eff[t])))
      deltaC.prob[t] <- 1/(1+exp(-(l.deltaC + eps.deltaC[t] + b.eff*eff[t])))
    }
  
  #set Dirichlet priors for initial states 1:12 (Byoy to Bc4c2; excludes dead state which = 0)
  for (i in 1:13) {
    beta[i] ~ dgamma(1,1) #induce Dirichlet prior
    pi[i]<-beta[i]/sum(beta[])
  }
  
    ##### Population model ####

  #Initialize population assuming stable age distribution - year 2004, fills N[1,]

  # conditional binomials
   # total abundance
   Ntot[1] ~ dpois(pop_init)
   pop_init ~ dunif(250,400)

  # age categories
   N[1,1] ~ dbin(stableAge[1], Ntot[1]) #YOTY

   # group 2:(G-1) prob of group g given not in any previous group
   for(g in 2:(G-1)){
    N[1,g] ~ dbin(stableAge[g]/(1-sum(stableAge[1:(g-1)])), Ntot[1] - sum(N[1,1:(g-1)]) )
   }

   # group G: deterministic
   N[1,G] <- Ntot[1] - sum(N[1,1:(G-1)])

    A.NB[1] <- N[1,fec.age+1]
    A.Byoy[1] <- N[1,fec.age+2]
    A.BSk[1] <- N[1,fec.age+3]

  ## Data years

  ### population model state process; 
  
    for (t in 1:1) { #fills N[2,] when t == 1, survival process for 2004-2005
    ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiB*mu.phiY, N[t,1]) #yearlings; use intercepts for years 1 and 14 when no MR data
     N[t+1,3] ~ dbin(mu.phiB*mu.phiY, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(mean(phiC.true.prob), N[t,a-1]) #use phiC.true instead of mu bc need to include offset
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*(mu.psiB), A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])
    
    } #t == 1, populations N[2,] == 2005
 
    for (t in 2:(nyears.ch)){  # when t == 2, starts filling N[3,], using phi[1] for 2005-2006 survival
    # last is when t == 13, 2016-2017, fills N[14,] 
    # for demog rates, use t-1 to align with MR data; t-1 means t==1, which matches phi[1] == for 05-06

     ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(phiY.true.prob[t-1], N[t,1]) #yearlings
     N[t+1,3] ~ dbin(phiY.true.prob[t-1], N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(phiC.true.prob[t-1], N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(phiN.prob[t-1], N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(phiB.prob[t-1]*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(phiB.prob[t-1]*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(phiB.prob[t-1]*(psiB.prob[t-1]), A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(phiB.prob[t-1]*(1-psiB.prob[t-1]), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(phiB.prob[t-1], A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])

    } #t data years

  ## gap year between last ch (2017) and aerial survey (2018): t == 14 fills N[15,]
    for (t in (nyears.ch+1):(nyears.ch+nyears.gap)){

      ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiY*mu.phiB, N[t,1]) #yearlings
     N[t+1,3] ~ dbin(mu.phiY*mu.phiB, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(mean(phiC.true.prob), N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from G-1 yo (here, 8 yo)
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])
     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from fec.age-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*psiN, N[t,fec.age]) #new B.yoy aging from fec.age-1
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*psiN, A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*mu.psiB, A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])
    }

  # Annual abundance

    for (t in 2:(nyears.ch+nyears.gap+1)) {
      Ntot[t] <- round(sum(N[t, 1:G]))
    } # t

     # Aerial survey model

    for (t in 1:(length(grp.years))){
      N_mu[t] ~ dnorm(N_obs[t], N_tau[t]) #observation error on cnts to estimate N_obs
      p_grp[t] ~ dbeta(1,1) #group detection probability; vague
      N_obs[t] ~ dbin(p_grp[t], round(Ntot[grp.years[t]])) #counts of true state (abundance)
    } #t
  
  # DEFINE PARAMETERS	
  # probabilities for each INITIAL STATE
  px0[1] <- pi[1] # prob. of initial state NB
  px0[2] <- pi[2] # prob. of being in initial state Byoy
  px0[3] <- pi[3] # prob. of being in initial state Bc1
  px0[4] <- pi[4] # prob. of being in initial state Bc2
  px0[5] <- pi[5] # prob. of being in initial state Bc2yoy
  px0[6] <- pi[6] # prob. of being in initial state Bc3
  px0[7] <- pi[7] # prob. of being in initial state Bc3yoy
  px0[8] <- pi[8] # prob. of being in initial state Bc3c1
  px0[9] <- pi[9] # prob. of being in initial state Bc4
  px0[10] <- pi[10] # prob. of being in initial state Bc4yoy
  px0[11] <- pi[11] # prob. of being in initial state Bc4c1
  px0[12] <- pi[12] # prob of initial state Bc4c2
  px0[13] <- pi[13]
  px0[14] <- 0 # prob. of being in initial state dead
  
  for (i in 1:n_ind){
    for (t in 1:(nyears.ch)) {
      
      #initial observation matrix; same as obs proc matrix without detection, or p == 1
  po.init[1,1:72,i,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[2,1:72,i,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[3,1:72,i,t] <- c(1-1,-1*(deltaY[t]-1), alphaTy*deltaY[t]*1*gamma, -deltaY[t]*gamma*kappaY*1*(alphaTy-1), 
                    0, 0, deltaY[t]*gamma*1*(alphaTy-1)*(kappaY-1), 0,0,0,0,0,0,
                    -deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[4,1:72,i,t] <- c(1-1,-1*(deltaY[t]-1), 0, -deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaY[t]*1*gamma,                       deltaY[t]*1*gamma*omegaA*(alphaTc-1)*(eta-1), deltaY[t]*gamma*1*(alphaTc-1)*(omegaA-1), 0,0,
                    0,0,0,0,-deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[5,1:72,i,t] <- c(1-1,-1*(deltaC[t]-1), 0,0,0, deltaC[t]*1*gamma*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaC[t]*1*gamma,
                    (alphaTc-1)*(eta-1)*deltaC[t]*1*gamma*omegaA,0,0,0,
                    0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[6,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),
                    -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    -deltaC[t]*gamma*1*(alphaTc-1)*(omegaA-1)*(deltaY[t]-1),
                  deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaY[t]-1)-deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    -deltaC[t]*1*gamma*omegaA*(alphaTc-1)*(deltaY[t]-1)*(eta-1),
                    0,0,0,0,
                    deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaA-1), 0,
                    -alphaTy*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*eta*gamma^2*kappaY*omegaA*(alphaTc-1)*(alphaTy-1),
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1),
                    0,0,deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    -alphaTy*deltaC[t]*deltaY[t]*1*gamma*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*1*(gamma*(alphaTy-1)*(gamma-1)*(kappaY-1)-eta*gamma*omegaA*(alphaTc-1)*(gamma-1)),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    -deltaC[t]*deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(eta-1)*(gamma-1),
                    0,0,0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0, 
                    deltaY[t]*deltaC[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaA-1), 0,0,
                    -deltaC[t]*deltaY[t]*eta*(gamma^2)*omegaA*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0)
  po.init[7,1:72,i,t] <- c(1-1, -1*(deltaC[t]-1), 0,0,0,-deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,
                    deltaC[t]*1*gamma*kappaC*(alphaTc-1)*(omegaB-1),alphaTc*deltaC[t]*1*gamma,
                    -deltaC[t]*gamma*omegaB*1*(alphaTc-1), 0,0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[8,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*1*gamma*(deltaC[t]-1), 
                      deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1),0,
                    deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1),
                    -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0,deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),0,0,
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1), 
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1), 0,0,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),
                    0,-deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0,
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1),
                    0,0,0,0)
  po.init[9,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), 0, deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                    -alphaTc*deltaY[t]*1*gamma*(deltaC[t]-1),
                    deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(deltaY[t]-1)*(omegaB-1)-
                    deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1)*(eta-1),
                    -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1), 0, 
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),-alphaTc*deltaC[t]*gamma*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0, deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1), 0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1), 
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                    0,0,-alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1, 
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1), 
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*(alphaTc-1)^2,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1), 
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), #check next
                    -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1)),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1), 0,
                    -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1), 
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1),0,0,0,0)
  po.init[10,1:72,i,t] <- c(1-1, -1*(deltaC[t]-1),0,0,0, -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,
                      -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,deltaC[t]*gamma*kappaC*(alphaTc-1)*(omegaB-1),
                      alphaTc*deltaC[t]*gamma*1, -deltaC[t]*gamma*omegaB*1*(alphaTc-1),
                      -deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[11,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),
                    deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,
                     -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                     (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2, 0,
                     -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                     -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                     deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                     deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 
                     0,0,0,0,0,0,
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                     (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 0,0,
                     -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0,0,0,
                      alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                      deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,0,
                      alphaTc*alphaTy*deltaY[t]*deltaC[t]*gamma^2*1, -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1),0,0,
                      alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                      deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1),0,0,
                      -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                      (deltaC[t]*deltaY[t]*1*gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,
                      -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),0,
                      (deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                      -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                      deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                      deltaC[t]*deltaY[t]*1*(gamma-1)^2,0,
                      -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0)
  po.init[12,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),0,deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                        -alphaTc*deltaY[t]*gamma*1*(deltaC[t]-1), 
                        ((deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2)-deltaY[t]*gamma*omegaA*1*
                        (alphaTc-1)*(deltaC[t]-1)*(eta-1),
                        -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1),0,
                        (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1), -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                        deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                        deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0,0,0,0,
                        -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),0,0,0,
                        -alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                        alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1,
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                        -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                        -deltaC[t]*deltaY[t]*gamma^2*1*omegaA*omegaB*(alphaTc-1)^2*(eta-1),
                        -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                        -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                        -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),0,
                        (deltaY[t]*deltaC[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                        deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                        -(deltaY[t]*deltaC[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0)
  po.init[13,1:72,i,t] <- c(1-1, 1*(deltaC[t]-1)^2,0,0,0,
                      gamma*1*(alphaTc-1)*(omegaA-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      -eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2), alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      gamma*omegaA*1*(alphaTc-1)*(eta-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      0, gamma*kappaC*1*(alphaTc-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2), 
                      alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      -gamma*omegaB*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2), 
                      -2*1*(gamma-1)*(deltaC[t]-deltaC[t]^2),0,0,0,0,0,0,0,0,0,0,0,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,0,0,
                      deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                      -deltaC[t]^2*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                      alphaTc*deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      deltaC[t]^2*gamma^2*kappaC*1*omegaA*(alphaTc-1)^2*(eta-1)*(omegaB-1),0,0,0,
                      alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(omegaA-1),
                      -alphaTc*deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1),
                      alphaTc^2*deltaC[t]^2*gamma^2*1,
                      alphaTc*deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),0,0,0,
                      -deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),
                      deltaC[t]^2*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                      -alphaTc*deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1),
                      -deltaC[t]^2*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1),0,0,0,
                      -deltaC[t]^2*1*(gamma*(alphaTc-1)*(gamma-1)*(omegaA-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      deltaC[t]^2*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      -deltaC[t]^2*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      0,-deltaC[t]^2*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      deltaC[t]^2*gamma*omegaB*1*(alphaTc-1)*(gamma-1),deltaC[t]^2*1*(gamma-1)^2,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2)
  po.init[14,1:72,i,t] <- c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
    }
  }
  
    for (i in 1:n_ind){
    for (t in 1:(nyears.ch-1)) {

  #observation process matrix
  po[1,1:72,i,t] <- c(1-pN[t],pN[t],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[2,1:72,i,t] <- c(1-pBn[t],pBn[t],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[3,1:72,i,t] <- c(1-pBc[t],-pBc[t]*(deltaY[t+1]-1), alphaTy*deltaY[t+1]*pBc[t]*gamma, -deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1), 
                    0, 0, deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(kappaY-1), 0,0,0,0,0,0,
                    -deltaY[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[4,1:72,i,t] <- c(1-pBc[t],-pBc[t]*(deltaY[t+1]-1), 0, -deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1), alphaTc*deltaY[t+1]*pBc[t]*gamma,                       deltaY[t+1]*pBc[t]*gamma*omegaA*(alphaTc-1)*(eta-1), deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(omegaA-1), 0,0,
                    0,0,0,0,-deltaY[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[5,1:72,i,t] <- c(1-pBc[t],-pBc[t]*(deltaC[t+1]-1), 0,0,0, deltaC[t+1]*pBc[t]*gamma*(alphaTc-1)*(omegaA-1),
                    -deltaC[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1), alphaTc*deltaC[t+1]*pBc[t]*gamma,
                    (alphaTc-1)*(eta-1)*deltaC[t+1]*pBc[t]*gamma*omegaA,0,0,0,
                    0,-deltaC[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[6,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1),
                    -alphaTy*deltaY[t+1]*gamma*pBc[t]*(deltaC[t+1]-1),deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1), 0,
                    -deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(omegaA-1)*(deltaY[t+1]-1),
                  deltaC[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)-deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1)*(kappaY-1),
                    -alphaTc*deltaC[t+1]*gamma*pBc[t]*(deltaY[t+1]-1),
                    -deltaC[t+1]*pBc[t]*gamma*omegaA*(alphaTc-1)*(deltaY[t+1]-1)*(eta-1),
                    0,0,0,0,
                    deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1),
                    alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(omegaA-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(omegaA-1), 0, #here
                    -alphaTy*deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1),
                    deltaC[t+1]*deltaY[t+1]*eta*gamma^2*kappaY*omegaA*pBc[t]*(alphaTc-1)*(alphaTy-1),
                    alphaTc*alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t],
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTy-1),
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTy-1)*(kappaY-1),
                    alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(eta-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*omegaA*pBc[t]*(alphaTc-1)*(alphaTy-1)*(eta-1),
                    0,0,deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(alphaTy-1)*(eta-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    -alphaTy*deltaC[t+1]*deltaY[t+1]*pBc[t]*gamma*(gamma-1),
                    deltaC[t+1]*deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(gamma-1),0,
                    -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaA-1),
                    -deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma*(alphaTy-1)*(gamma-1)*(kappaY-1)-eta*gamma*omegaA*(alphaTc-1)*(gamma-1)),
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma*omegaA*pBc[t]*(alphaTc-1)*(eta-1)*(gamma-1),
                    0,0,0,0,
                    deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2, 0, 
                    deltaY[t+1]*deltaC[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaA-1), 0,0,
                    -deltaC[t+1]*deltaY[t+1]*eta*(gamma^2)*omegaA*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0)
  po[7,1:72,i,t] <- c(1-pBc[t], -pBc[t]*(deltaC[t+1]-1), 0,0,0,-deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,
                    deltaC[t+1]*pBc[t]*gamma*kappaC*(alphaTc-1)*(omegaB-1),alphaTc*deltaC[t+1]*pBc[t]*gamma,
                    -deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1), 0,0,-deltaC[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[8,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1), -alphaTy*deltaY[t+1]*pBc[t]*gamma*(deltaC[t+1]-1), 
                      deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1),0,
                    deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1),
                    -deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1)*(kappaY-1),0,
                    -deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(omegaB-1),
                    -alphaTc*deltaC[t+1]*gamma*pBc[t]*(deltaY[t+1]-1),
                    deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1),
                    0,0,deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1),
                    -alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1),
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,
                    alphaTc*alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t],
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTy-1),0,0,
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTy-1)*(kappaY-1), 
                    -alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*omegaB*pBc[t]*(alphaTc-1)*(alphaTy-1), 0,0,
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-alphaTy*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                    deltaC[t+1]*deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(gamma-1),0,
                    deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(gamma-1)*(kappaY-1),
                    0,-deltaC[t+1]*deltaY[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                    deltaC[t+1]*deltaY[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2, 0, -deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1),
                    0,0,0,0)
  po[9,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1), 0, deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1),
                    -alphaTc*deltaY[t+1]*pBc[t]*gamma*(deltaC[t+1]-1),
                    deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(deltaY[t+1]-1)*(omegaB-1)-
                    deltaY[t+1]*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1)*(eta-1),
                    -deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1)*(omegaA-1), 0, 
                    -deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(omegaB-1),-alphaTc*deltaC[t+1]*gamma*(deltaY[t+1]-1),
                    deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1),
                    0,0, deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1), 0,
                    deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1),
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    -deltaC[t+1]*deltaY[t+1]*eta*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(omegaB-1),
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1), 
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                    deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                    0,0,-alphaTc*deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1),
                    alphaTc^2*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t], 
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(eta-1), 
                    alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(omegaA-1),0,
                    deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*omegaB*(alphaTc-1)^2,
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*omegaB*pBc[t]*(alphaTc-1)^2*(eta-1), 
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1)^2*(omegaA-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    deltaC[t+1]*deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(gamma-1),
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                    -deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1)),
                    -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaA-1), 0,
                    -deltaC[t+1]*deltaY[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1), 
                    -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),deltaC[t+1]*deltaY[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2,
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1),0,0,0,0)
  po[10,1:72,i,t] <- c(1-pBc[t], -pBc[t]*(deltaC[t+1]-1),0,0,0, -(deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,
                      -(deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,
                      deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                      alphaTc*deltaC[t+1]*gamma*pBc[t], -deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1),
                      -deltaC[t+1]*pBc[t]*(gamma-1),0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po[11,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1), -alphaTy*deltaY[t+1]*gamma*pBc[t]*(deltaC[t+1]-1),
                    deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1), 0,
                    (deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1))/2,
                     -deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(deltaC[t+1]-1)*(kappaY-1),0,
                     (deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1))/2, 0,
                     -deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(omegaB-1),
                     -alphaTc*deltaC[t+1]*gamma*pBc[t]*(deltaY[t+1]-1),
                     deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1),
                     deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1),
                     -(alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      (deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 
                     0,0,0,0,0,0,
                     -(alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                     (deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 0,0,
                     -(deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0,0,0,
                      alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                      -deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*kappaY*pBc[t]*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                      deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,0,
                      alphaTc*alphaTy*deltaY[t+1]*deltaC[t+1]*gamma^2*pBc[t], -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTy-1),0,0,
                      alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                      deltaC[t+1]*deltaY[t+1]*gamma^2*kappaY*omegaB*pBc[t]*(alphaTc-1)*(alphaTy-1),0,0,
                      -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1), deltaC[t+1]*deltaY[t+1]*gamma*kappaY*pBc[t]*(alphaTy-1)*(gamma-1),0,
                      (deltaC[t+1]*deltaY[t+1]*pBc[t]*gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,
                      -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTy-1)*(gamma-1)*(kappaY-1),0,
                      (deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -deltaC[t+1]*deltaY[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1),
                      -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                      deltaC[t+1]*deltaY[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),
                      deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2,0,
                      -(deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0)
  po[12,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)*(deltaY[t+1]-1),0,deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1),
                        -alphaTc*deltaY[t+1]*gamma*pBc[t]*(deltaC[t+1]-1), 
                        ((deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1))/2)-deltaY[t+1]*gamma*omegaA*pBc[t]*
                        (alphaTc-1)*(deltaC[t+1]-1)*(eta-1),
                        
                        -deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaC[t+1]-1)*(omegaA-1),0,
                        (deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1)*(omegaB-1), -alphaTc*deltaC[t+1]*gamma*pBc[t]*(deltaY[t+1]-1),
                        deltaC[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaY[t+1]-1),
                        deltaC[t+1]*pBc[t]*(deltaY[t+1]-1)*(gamma-1)+deltaY[t+1]*pBc[t]*(deltaC[t+1]-1)*(gamma-1),0,
                        (deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,
                        (deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0,0,0,0,
                        -deltaC[t+1]*deltaY[t+1]*eta*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(omegaB-1),
                        alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                        deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                        deltaC[t+1]*deltaY[t+1]*gamma^2*kappaC*pBc[t]*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),0,0,0,
                        -alphaTc*deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1),
                        alphaTc^2*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t],alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(eta-1),
                        alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)*(omegaA-1),0,0,0,
                        deltaC[t+1]*deltaY[t+1]*eta*gamma^2*omegaA*omegaB*pBc[t]*(alphaTc-1)^2,
                        -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                        -deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*omegaA*omegaB*(alphaTc-1)^2*(eta-1),
                        -deltaC[t+1]*deltaY[t+1]*gamma^2*omegaB*pBc[t]*(alphaTc-1)^2*(omegaA-1),0,0,0,
                        deltaC[t+1]*deltaY[t+1]*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(gamma-1),
                        -alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                        -deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                        -deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaA-1),0,
                        (deltaY[t+1]*deltaC[t+1]*gamma*pBc[t]*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t+1]*deltaY[t+1]*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t+1]*deltaY[t+1]*gamma*pBc[t]*(gamma-1),
                        deltaC[t+1]*deltaY[t+1]*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),
                        deltaC[t+1]*deltaY[t+1]*pBc[t]*(gamma-1)^2,
                        -(deltaY[t+1]*deltaC[t+1]*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t+1]*deltaY[t+1]*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0)
  po[13,1:72,i,t] <- c(1-pBc[t], pBc[t]*(deltaC[t+1]-1)^2,0,0,0,
                      gamma*pBc[t]*(alphaTc-1)*(omegaA-1)*(deltaC[t+1]-deltaC[t+1]^2)-((gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t+1]-deltaC[t+1]^2))/2),
                      -eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(deltaC[t+1]-deltaC[t+1]^2), alphaTc*gamma*pBc[t]*(deltaC[t+1]-deltaC[t+1]^2),
                      gamma*omegaA*pBc[t]*(alphaTc-1)*(eta-1)*(deltaC[t+1]-deltaC[t+1]^2)-((gamma*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t+1]-deltaC[t+1]^2))/2),
                      0, gamma*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1)*(deltaC[t+1]-deltaC[t+1]^2), alphaTc*gamma*pBc[t]*(deltaC[t+1]-deltaC[t+1]^2),
                      -gamma*omegaB*pBc[t]*(alphaTc-1)*(deltaC[t+1]-deltaC[t+1]^2), -2*pBc[t]*(gamma-1)*(deltaC[t+1]-deltaC[t+1]^2),0,0,0,0,0,0,0,0,0,0,0,
                      -(deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t+1]^2*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,0,0,
                      deltaC[t+1]^2*gamma^2*kappaC*pBc[t]*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                      -deltaC[t+1]^2*eta*gamma^2*kappaC*omegaA*pBc[t]*(alphaTc-1)^2*(omegaB-1),
                      alphaTc*deltaC[t+1]^2*gamma^2*kappaC*pBc[t]*(alphaTc-1)*(omegaB-1),
                      deltaC[t+1]^2*gamma^2*kappaC*pBc[t]*omegaA*(alphaTc-1)^2*(eta-1)*(omegaB-1),0,0,0,
                      alphaTc*deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)*(omegaA-1),
                      -alphaTc*deltaC[t+1]^2*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1),
                      alphaTc^2*deltaC[t+1]^2*gamma^2*pBc[t],
                      alphaTc*deltaC[t+1]^2*gamma^2*omegaA*pBc[t]*(alphaTc-1)*(eta-1),0,0,0,
                      -deltaC[t+1]^2*gamma^2*omegaB*pBc[t]*(alphaTc-1)^2*(omegaA-1),
                      deltaC[t+1]^2*eta*gamma^2*omegaA*omegaB*pBc[t]*(alphaTc-1)^2,
                      -alphaTc*deltaC[t+1]^2*gamma^2*omegaB*pBc[t]*(alphaTc-1),
                      -deltaC[t+1]^2*gamma^2*omegaA*omegaB*pBc[t]*(alphaTc-1)^2*(eta-1),0,0,0,
                      -deltaC[t+1]^2*pBc[t]*(gamma*(alphaTc-1)*(gamma-1)*(omegaA-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      deltaC[t+1]^2*eta*gamma*omegaA*pBc[t]*(alphaTc-1)*(gamma-1),-alphaTc*deltaC[t+1]^2*gamma*pBc[t]*(gamma-1),
                      -deltaC[t+1]^2*pBc[t]*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      0,-deltaC[t+1]^2*gamma*kappaC*pBc[t]*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t+1]^2*gamma*pBc[t]*(gamma-1),
                      deltaC[t+1]^2*gamma*omegaB*pBc[t]*(alphaTc-1)*(gamma-1),deltaC[t+1]^2*pBc[t]*(gamma-1)^2,
                      -(deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t+1]^2*eta*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t+1]^2*gamma^2*pBc[t]*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      -(deltaC[t+1]^2*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -(deltaC[t+1]^2*gamma^2*omegaA*pBc[t]*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2)
  po[14,1:72,i,t] <- c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)


  # STATE PROCESS: probabilities of states at t+1 (columns) given states at t (rows)
 px[1,1:14,i,t] <- c(-phiN[t]*(psiN-1),0,phiN[t]*psiN,0,0,0,0,0,0,0,0,0,0,1-phiN[t])
 px[2,1:14,i,t] <- c(0,-phiB[t]*(psiB[t]-1),phiB[t]*psiB[t],0,0,0,0,0,0,0,0,0,0,1-phiB[t])
 px[3,1:14,i,t] <- c(0,-phiB[t]*(phiY[t]-1),0,phiB[t]*phiY[t],0,0,0,0,0,0,0,0,0,1-phiB[t])
 px[4,1:14,i,t] <- c(0,phiB[t]*(phiY[t]-1)*(psiB[t]-1),-phiB[t]*psiB[t]*(phiY[t]-1),0,
                     -phiB[t]*phiY[t]*(psiB[t]-1), phiB[t]*phiY[t]*psiB[t],0,0,0,0,0,0,0,1-phiB[t])
 px[5,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(psiB[t]-1),-phiB[t]*psiB[t]*(phiC[t]-1),0,0,0,
                     -phiB[t]*phiC[t]*(psiB[t]-1),phiB[t]*phiC[t]*psiB[t],0,0,0,0,0,1-phiB[t])
 px[6,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(phiY[t]-1),0,-phiB[t]*phiY[t]*(phiC[t]-1),0,0,
                     -phiB[t]*phiC[t]*(phiY[t]-1),0,phiB[t]*phiC[t]*phiY[t],0,
                     0,0,0,1-phiB[t])
 px[7,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(psiB[t]-1),-phiB[t]*psiB[t]*(phiC[t]-1),
                     0,0,0,0,0,0,-phiB[t]*phiC[t]*(psiB[t]-1),
                     phiB[t]*phiC[t]*psiB[t],0,0,1-phiB[t])
 px[8,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(phiY[t]-1),0,-phiB[t]*phiY[t]*(phiC[t]-1),0,0,
                     0,0,0,-phiB[t]*phiC[t]*(phiY[t]-1),0,
                     phiB[t]*phiC[t]*phiY[t],0,1-phiB[t])
 px[9,1:14,i,t] <- c(0,-phiB[t]*(phiC[t]-1)*(phiY[t]-1)*(psiB[t]-1),
                     phiB[t]*psiB[t]*(phiC[t]-1)*(phiY[t]-1),0,
                     phiB[t]*phiY[t]*(phiC[t]-1)*(psiB[t]-1),
                     -phiB[t]*phiY[t]*psiB[t]*(phiC[t]-1),0,0,0,
                     phiB[t]*phiC[t]*(phiY[t]-1)*(psiB[t]-1),
                     -phiB[t]*phiC[t]*psiB[t]*(phiY[t]-1),0,phiB[t]*phiC[t]*phiY[t],1-phiB[t])
 px[10,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(psiB[t]-1),-phiB[t]*psiB[t]*(phiC[t]-1),0,0,0,0,
                      0,0,-phiB[t]*phiC[t]*(psiB[t]-1),phiB[t]*phiC[t]*psiB[t],0,0,1-phiB[t])
 px[11,1:14,i,t] <- c(0,phiB[t]*(phiC[t]-1)*(phiY[t]-1),0,-phiB[t]*phiY[t]*(phiC[t]-1),0,0,0,0,
                      0,-phiB[t]*phiC[t]*(phiY[t]-1),0,phiB[t]*phiC[t]*phiY[t],0,1-phiB[t])
 px[12,1:14,i,t] <- c(0,-phiB[t]*(phiC[t]-1)*(phiY[t]-1)*(psiB[t]-1),
                      phiB[t]*psiB[t]*(phiC[t]-1)*(phiY[t]-1),0,
                      phiB[t]*phiY[t]*(phiC[t]-1)*(psiB[t]-1),-phiB[t]*phiY[t]*psiB[t]*(phiC[t]-1),0,
                      0,0,phiB[t]*phiC[t]*(phiY[t]-1)*(psiB[t]-1),
                      -phiB[t]*phiC[t]*psiB[t]*(phiY[t]-1),0,phiB[t]*phiC[t]*phiY[t],1-phiB[t])
 px[13,1:14,i,t] <- c(0,-phiB[t]*(phiC[t]-1)^2*(psiB[t]-1), phiB[t]*psiB[t]*(phiC[t]-1)^2,0,0,0,
                      phiB[t]*phiC[t]*(phiC[t]-1)*(psiB[t]-1),
                      -phiB[t]*phiC[t]*psiB[t]*(phiC[t]-1),0,phiB[t]*phiC[t]*(phiC[t]-1)*(psiB[t]-1),
                      -phiB[t]*phiC[t]*psiB[t]*(phiC[t]-1),0,phiB[t]*phiC[t]^2,1-phiB[t])
 px[14,1:14,i,t] <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1)
    }
  }
  
  ##### Likelihoods ######
  for (i in 1:n_ind) { # loop over each individual
    # estimated probabilities of initial states are the proportions in each state at 
    # first capture occasion
    z[i,First[i]] ~ dcat(px0[1:n.states])
    y[i,First[i]] ~ dcat(po.init[z[i,First[i]],1:n.obs,i,First[i]])

    for (j in (First[i]+1):nyears.ch) { # loop over time
      ## STATE EQUATIONS ##
      # draw states at j given states at j-1
      z[i,j] ~ dcat(px[z[i,j-1],1:n.states,i,j-1])
      
      ## OBSERVATION EQUATIONS ##
      # draw observations at j given states at j
      y[i,j] ~ dcat(po[z[i,j],1:n.obs,i,j-1]) 

      
    } #j
  } #i
  
} #mod
  
', fill = TRUE)
sink()

```


```{r run model JAGS}

jags.data <- list(N_mu = mu, N_tau = tau, stableAge = stableAge, G = G, fec.age = fec.age,
                  eff = c(effort$Land_Vessel_sc[1:13]), #numeric scaled
                  all_fish = all_fish,sst_goa = sst_goa, 
                  nyears.ch = nyears.ch, grp.years = grp.years,nyears.gap = nyears.gap,
                  n.states = n.states, n.obs = n.obs,
                  n_ind = n_ind, y = as.matrix(CH_data), First = e)

## Initial values
inits <- function() list(mu.phiB = 0.95, mu.phiC = 0.6, mu.phiY = 0.90, mu.psiB = 0.25, mu.phiN = 0.92,
                         b.sst_goa.a = 0, b.sst_goa.y = 0, b.sst_goa.c = 0, b.sst_goa.psi = 0,
                         b.all_fish.a = 0, b.all_fish.y = 0, b.all_fish.c = 0, b.all_fish.psi = 0,
                         psiN = runif(1,0.005, 0.1),
                         alphaTc = 0.06, alphaTy = 0.5, omegaA = 0.96, omegaB = 0.6, 
                         kappaC = 0.63, kappaY = 0.98,
                         gamma = 0.94, eta = 0.02, 
                         eps.pBn = c(rep(0, nyears.ch-1)), eps.pN = c(rep(0, nyears.ch-1)), 
                         eps.pBc = c(rep(0, nyears.ch-1)), eps.deltaY = c(rep(0,nyears.ch)),
                         eps.deltaC = c(rep(0,nyears.ch)),
                         z = as.matrix(alive.function()))

params <- c('tau.phiB', 'tau.psiB', 'tau.phiC', 'tau.phiY', 'tau.pN', 'tau.pBc', 'tau.pBn',
            'tau.deltaY', 'tau.deltaC',
            'b.sst_goa.b', 'b.sst_goa.y', 'b.sst_goa.c', 'b.sst_goa.psi',
            's.sst_goa.b', 's.sst_goa.y', 's.sst_goa.c', 's.sst_goa.psi',
            'b.all_fish.b', 'b.all_fish.c', 'b.all_fish.y', 'b.all_fish.psi',
            's.all_fish.b', 's.all_fish.c', 's.all_fish.y', 's.all_fish.psi',
            'sigma.psiB', 'sigma.phiB', 'sigma.phiY', 'sigma.phiC', 
            'sigma.pN', 'sigma.pBc', 'sigma.pBn', 'sigma.deltaY', 'sigma.deltaC',
            'eps.psiB', 'eps.phiB', 'eps.phiN', 'eps.phiY', 'eps.phiC', 
            'eps.pN', 'eps.pBc', 'eps.pBn', 'eps.deltaY', 'eps.deltaC', 's.rate',
            'l.phiB', 'l.phiN', 'l.psiB', 'l.phiC', 'l.phiY', 
            'l.pN', 'l.pBc', 'l.pBn', 'l.deltaC', 'l.deltaY',
            'mu.psiB', 'mu.phiB', 'mu.phiN', 'mu.phiC', 'mu.phiY', 
            'mu.pN', 'mu.pBc', 'mu.pBn', 'mu.deltaC', 'mu.deltaY',
            'phiB.prob', 'phiN.prob', 'phiY.prob', 'phiC.prob', 'psiB.prob',
            'phiY.true.prob', 'phiC.true.prob',
            'pN.prob', 'pBc.prob', 'pBn.prob', 'deltaC.prob', 'deltaY.prob',
            'l.phiC.corr', 'phiC.corr.prob', 'b.eff', 
            'gamma', 'eta', 'alphaTy', 'alphaTc', 'kappaC', 'kappaY', 'omegaA', 'omegaB',
            'deltaY', 'deltaC', 'pi', 'pN', 'pBc', 'pBn', 'psiN', #ME model
            'p_grp',  'N_obs', 'N_mu',  #count model
            'pop_init', 'Ntot', 'N')  #pop model

# run model
n.chains = 3; n.iter = 30000; n.thin = 2; n.burnin = 20000 

out <- jags(jags.data, inits = inits, params,
            model.file = model.file,
            n.chains = n.chains, n.iter = n.iter,
            n.thin = n.thin, n.burnin = n.burnin)

saveRDS(out, here::here('results', 'jags', 'out_RE.rds'))


```


#### Nimble models

```{r null model text}

#nimble models used for posterior predictive checking and WAIC calculations

# THE MODEL:

CIBW_mod <- nimbleCode({
   
  #PRIORS
  psiN ~ dunif(0,1) #first time breeding transition
  gamma ~ dunif(0,1)   # P(calf can be put in an age category vs unknown)
  alphaTy ~ dunif(0,1) # P(a YOY calf is identified as such without uncertainty)
  alphaTc ~ dunif(0,1) # P(a 1,2,3, or 4yo calf is identified as such without uncertainty)
  kappaY ~ dunif(0,1)  # P(a YOY is assigned to J1- category)
  kappaC ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J2+ or J3+ categories respectively)
  omegaA ~ dunif(0,1)  # P(a YOY is assigned J1+)
  omegaB ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J3+ or J4+ categories respectively)
  eta ~ dunif(0,1)  # P(being at top of allowable age class)

    for (t in 1:(nyears.ch-1)){  #data starts in 2005, plus 12 survival periods to 2017
        logit(phiB[t]) <- l.phiB 
        logit(phiN[t]) <- l.phiN
        logit(phiC[t]) <- l.phiC  + l.phiC.corr 
        logit(phiY[t]) <- l.phiY 
        logit(psiB[t]) <- l.psiB
    }
        
     for (t in 1:(nyears.ch)){ 
        logit(deltaY[t]) <- l.deltaY 
        logit(deltaC[t]) <- l.deltaC 
        logit(pN[t]) <- l.pN 
        logit(pBn[t]) <- l.pBn  
        logit(pBc[t]) <- l.pBc 
      } # t
  
     l.phiB <- log(mu.phiB/(1 - mu.phiB))
     mu.phiB ~ dunif(0.5, 1)
     l.phiN <- log(mu.phiN/(1 - mu.phiN))
     mu.phiN ~ dunif(0.5, 1)
     l.phiC <- log(mu.phiC/(1 - mu.phiC))
     mu.phiC ~ dunif(0.3, 1)
     l.phiY <- log(mu.phiY/(1 - mu.phiY))
     mu.phiY ~ dunif(0.5, 1)
     l.psiB <- log(mu.psiB/(1 - mu.psiB))
     mu.psiB ~ dunif(0,1)
     l.pN <- log(mu.pN/(1-mu.pN))
     mu.pN ~ dunif(0,1)
     l.pBn <- log(mu.pBn/(1-mu.pBn))
     mu.pBn ~ dunif(0,1)
     l.pBc <- log(mu.pBc/(1-mu.pBc))
     mu.pBc ~ dunif(0,1)
     l.deltaY <- log(mu.deltaY/(1-mu.deltaY))
     mu.deltaY ~ dunif(0,1)
     l.deltaC <- log(mu.deltaC/(1-mu.deltaC))
     mu.deltaC ~ dunif(0,1)
     
     l.phiC.corr ~ dunif(0,3)
     phiC.corr.prob <- 1/(1+exp(-l.phiC.corr))
     
    ## backtransform to probability scale
    for (t in 1:(nyears.ch-1)) {
      phiB.prob[t] <- 1/(1+exp(-(l.phiB)))
      phiN.prob[t] <- 1/(1+exp(-(l.phiN)))
      phiY.prob[t] <- 1/(1+exp(-(l.phiY)))
      phiC.prob[t] <- 1/(1+exp(-(l.phiC + l.phiC.corr)))
      psiB.prob[t] <- 1/(1+exp(-l.psiB)) 
      phiY.true.prob[t] <- phiB.prob[t]*phiY.prob[t]
      phiC.true.prob[t] <- phiB.prob[t]*phiC.prob[t]
    }
     
     for (t in 1:(nyears.ch)){ 
      pBc.prob[t] <- 1/(1+exp(-(l.pBc)))
      pBn.prob[t] <- 1/(1+exp(-(l.pBn)))
      pN.prob[t] <- 1/(1+exp(-(l.pN)))
      deltaY.prob[t] <- 1/(1+exp(-(l.deltaY)))
      deltaC.prob[t] <- 1/(1+exp(-(l.deltaC)))
    }
    
  #set Dirichlet priors for initial states 1:13 (Byoy to Bc4c2; excludes dead state which = 0)
  for (i in 1:13) {
    beta[i] ~ dgamma(1,1) 
    pi[i]<-beta[i]/sum(beta[1:13]) 
  }
  
    ## Population model ##

  #Initialize population assuming stable age distribution - year 2004, fills N[1,]

  # conditional binomials
   # total abundance
   Ntot[1] ~ dpois(pop_init)
   pop_init ~ dunif(250,400)

  # age categories
   N[1,1] ~ dbin(stableAge[1], Ntot[1]) #YOTY

   # group 2:(G-1) prob of group g given not in any previous group
   for(g in 2:(G-1)){
    N[1,g] ~ dbin(stableAge[g]/(1-sum(stableAge[1:(g-1)])), Ntot[1] - sum(N[1,1:(g-1)]) )
   }

   # group G: deterministic
   N[1,G] <- Ntot[1] - sum(N[1,1:(G-1)])

    A.NB[1] <- N[1,fec.age+1]
    A.Byoy[1] <- N[1,fec.age+2]
    A.BSk[1] <- N[1,fec.age+3]

  ## Data years

  ### population model state process; 
  
    for (t in 1:1) { #fills N[2,] when t == 1, survival process for 2004-2005
    ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiB*mu.phiY, N[t,1]) #yearlings; use mu for years 1 and 14 (no MR data)
     N[t+1,3] ~ dbin(mu.phiB*mu.phiY, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
       #use phiC.true instead of mu bc need to include offset
     N[t+1,a] ~ dbin(mean(phiC.true.prob[1:(nyears.ch-1)]), N[t,a-1]) 
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*(mu.psiB), A.BSk[t]) 

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

    } #t == 1, populations N[2,] == 2005
 
    for (t in 2:(nyears.ch)){  # when t == 2, starts filling N[3,], using phi[1] for 2005-2006 survival
    # when t == 13, 2016-2017, fills N[14,] 
    # for demog rates, use t-1 to align with MR data; t-1 means t==1, which matches phi[1] == for 05-06

     ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(phiY.true.prob[t-1], N[t,1]) #yearlings
     N[t+1,3] ~ dbin(phiY.true.prob[t-1], N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(phiC.true.prob[t-1], N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(phiN.prob[t-1], N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(phiB.prob[t-1]*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(phiB.prob[t-1]*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(phiB.prob[t-1]*(psiB.prob[t-1]), A.BSk[t]) 

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(phiB.prob[t-1]*(1-psiB.prob[t-1]), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(phiB.prob[t-1], A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders
    } #t data years

  ## gap year between last ch (2017) and aerial survey (2018): t == 14 fills N[15,]
    for (t in (nyears.ch+1):(nyears.ch+nyears.gap)){

      ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiY*mu.phiB, N[t,1]) #yearlings
     N[t+1,3] ~ dbin(mu.phiY*mu.phiB, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(mean(phiC.true.prob[1:(nyears.ch-1)]), N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from G-1 yo (here, 8 yo)
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])
     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from fec.age-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*psiN, N[t,fec.age]) #new B.yoy aging from fec.age-1
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*psiN, A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*mu.psiB, A.BSk[t]) 
     
     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders
    }

  # Annual abundance

    for (t in 2:(nyears.ch+nyears.gap+1)) {
      Ntot[t] <- round(sum(N[t, 1:G]))
    } # t

     # Aerial survey model

    for (t in 1:(length(grp.years))){
      N_mu[t] ~ dnorm(N_obs[t], N_tau[t]) #observation error on cnts to estimate N_obs
      p_grp[t] ~ dbeta(1,1) #group detection probability; vague prior
      N_obs[t] ~ dbin(p_grp[t], round(Ntot[grp.years[t]])) #counts of true state (abundance)
    } #t
  
  # DEFINE PARAMETERS	
  # probabilities for each INITIAL STATE
  px0[1] <- pi[1] # prob. of initial state NB
  px0[2] <- pi[2] # prob. of being in initial state Byoy
  px0[3] <- pi[3] # prob. of being in initial state Bc1
  px0[4] <- pi[4] # prob. of being in initial state Bc2
  px0[5] <- pi[5] # prob. of being in initial state Bc2yoy
  px0[6] <- pi[6] # prob. of being in initial state Bc3
  px0[7] <- pi[7] # prob. of being in initial state Bc3yoy
  px0[8] <- pi[8] # prob. of being in initial state Bc3c1
  px0[9] <- pi[9] # prob. of being in initial state Bc4
  px0[10] <- pi[10] # prob. of being in initial state Bc4yoy
  px0[11] <- pi[11] # prob. of being in initial state Bc4c1
  px0[12] <- pi[12] # prob of initial state Bc4c2
  px0[13] <- pi[13]
  px0[14] <- 0 # prob. of being in initial state dead
  
## po.init ##
    for (t in 1:(nyears.ch)) {

      #initial observation matrix; same as obs proc matrix without detection, or p == 1
  po.init[1,1:72,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[2,1:72,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[3,1:72,t] <- c(1-1,-1*(deltaY[t]-1), alphaTy*deltaY[t]*1*gamma, -deltaY[t]*gamma*kappaY*1*(alphaTy-1),
                    0, 0, deltaY[t]*gamma*1*(alphaTy-1)*(kappaY-1), 0,0,0,0,0,0,
                    -deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[4,1:72,t] <- c(1-1,-1*(deltaY[t]-1), 0, -deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaY[t]*1*gamma,                       deltaY[t]*1*gamma*omegaA*(alphaTc-1)*(eta-1), deltaY[t]*gamma*1*(alphaTc-1)*(omegaA-1), 0,0,
                    0,0,0,0,-deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[5,1:72,t] <- c(1-1,-1*(deltaC[t]-1), 0,0,0, deltaC[t]*1*gamma*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaC[t]*1*gamma,
                    (alphaTc-1)*(eta-1)*deltaC[t]*1*gamma*omegaA,0,0,0,
                    0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[6,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),
                    -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    -deltaC[t]*gamma*1*(alphaTc-1)*(omegaA-1)*(deltaY[t]-1),
                  deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaY[t]-1)-deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    -deltaC[t]*1*gamma*omegaA*(alphaTc-1)*(deltaY[t]-1)*(eta-1),
                    0,0,0,0,
                    deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaA-1), 0,
                    -alphaTy*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*eta*gamma^2*kappaY*omegaA*(alphaTc-1)*(alphaTy-1),
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1),
                    0,0,deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    -alphaTy*deltaC[t]*deltaY[t]*1*gamma*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*1*(gamma*(alphaTy-1)*(gamma-1)*(kappaY-1)-eta*gamma*omegaA*(alphaTc-1)*(gamma-1)),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    -deltaC[t]*deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(eta-1)*(gamma-1),
                    0,0,0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0,
                    deltaY[t]*deltaC[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaA-1), 0,0,
                    -deltaC[t]*deltaY[t]*eta*(gamma^2)*omegaA*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0)
  po.init[7,1:72,t] <- c(1-1, -1*(deltaC[t]-1), 0,0,0,-deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,
                    deltaC[t]*1*gamma*kappaC*(alphaTc-1)*(omegaB-1),alphaTc*deltaC[t]*1*gamma,
                    -deltaC[t]*gamma*omegaB*1*(alphaTc-1), 0,0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[8,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*1*gamma*(deltaC[t]-1),
                      deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1),0,
                    deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1),
                    -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0,deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),0,0,
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1), 0,0,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),
                    0,-deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0,
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1),
                    0,0,0,0)
  po.init[9,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), 0, deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                    -alphaTc*deltaY[t]*1*gamma*(deltaC[t]-1),
                    deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(deltaY[t]-1)*(omegaB-1)-
                    deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1)*(eta-1),
                    -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1), 0,
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),-alphaTc*deltaC[t]*gamma*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0, deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1), 0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                    0,0,-alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1,
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*(alphaTc-1)^2,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1),
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), 
                    -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1)),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1), 0,
                    -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1),0,0,0,0)
  po.init[10,1:72,t] <- c(1-1, -1*(deltaC[t]-1),0,0,0, -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,
                      -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,deltaC[t]*gamma*kappaC*(alphaTc-1)*(omegaB-1),
                      alphaTc*deltaC[t]*gamma*1, -deltaC[t]*gamma*omegaB*1*(alphaTc-1),
                      -deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[11,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),
                    deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,
                     -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                     (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2, 0,
                     -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                     -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                     deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                     deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2,
                     0,0,0,0,0,0,
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                     (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 0,0,
                     -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0,0,0,
                      alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                      deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,0,
                      alphaTc*alphaTy*deltaY[t]*deltaC[t]*gamma^2*1, -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1),0,0,
                      alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                      deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1),0,0,
                      -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                      (deltaC[t]*deltaY[t]*1*gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,
                      -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),0,
                      (deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                      -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                      deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                      deltaC[t]*deltaY[t]*1*(gamma-1)^2,0,
                      -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0)
  po.init[12,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),0,deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                        -alphaTc*deltaY[t]*gamma*1*(deltaC[t]-1),
                        ((deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2)-deltaY[t]*gamma*omegaA*1*
                        (alphaTc-1)*(deltaC[t]-1)*(eta-1),
                        -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1),0,
                        (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1), -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                        deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                        deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0,0,0,0,
                        -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),0,0,0,
                        -alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                        alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1,
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                        -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                        -deltaC[t]*deltaY[t]*gamma^2*1*omegaA*omegaB*(alphaTc-1)^2*(eta-1),
                        -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                        -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                        -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),0,
                        (deltaY[t]*deltaC[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                        deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                        -(deltaY[t]*deltaC[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0)
  po.init[13,1:72,t] <- c(1-1, 1*(deltaC[t]-1)^2,0,0,0,
                      gamma*1*(alphaTc-1)*(omegaA-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      -eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2), alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      gamma*omegaA*1*(alphaTc-1)*(eta-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      0, gamma*kappaC*1*(alphaTc-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2),
                      alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      -gamma*omegaB*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2),
                      -2*1*(gamma-1)*(deltaC[t]-deltaC[t]^2),0,0,0,0,0,0,0,0,0,0,0,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,0,0,
                      deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                      -deltaC[t]^2*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                      alphaTc*deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      deltaC[t]^2*gamma^2*kappaC*1*omegaA*(alphaTc-1)^2*(eta-1)*(omegaB-1),0,0,0,
                      alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(omegaA-1),
                      -alphaTc*deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1),
                      alphaTc^2*deltaC[t]^2*gamma^2*1,
                      alphaTc*deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),0,0,0,
                      -deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),
                      deltaC[t]^2*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                      -alphaTc*deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1),
                      -deltaC[t]^2*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1),0,0,0,
                      -deltaC[t]^2*1*(gamma*(alphaTc-1)*(gamma-1)*(omegaA-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      deltaC[t]^2*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      -deltaC[t]^2*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      0,-deltaC[t]^2*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      deltaC[t]^2*gamma*omegaB*1*(alphaTc-1)*(gamma-1),deltaC[t]^2*1*(gamma-1)^2,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2)
  po.init[14,1:72,t] <- c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
    }

##### Likelihoods ##
  for (i in 1:n_ind) { # loop over each individual
    # estimated probabilities of initial states are the proportions in each state at
    # first capture occasion
    z[i,First[i]] ~ dcat(px0[1:n.states])
    y[i,First[i]] ~ dcat(po.init[z[i,First[i]],1:n.obs, First[i]]) 

    for (t in (First[i]+1):nyears.ch) {
      ## State Process ##
      # draw states at t given states at t-1
      z[i,t] ~ dcat(state_probs[i,t-1,1:n.states])

      ## Observation Process ##
      # draw observations at t given states at t
      y[i,t] ~ dcat(event_probs[i,t,1:n.obs])

    state_probs[i,t-1,1:n.states] <- getSTATE(z = z[i,t-1],
                                      phiB = phiB[t-1], phiN = phiN[t-1], phiC = phiC[t-1],
                                      phiY = phiY[t-1], psiB = psiB[t-1], psiN = psiN)

    event_probs[i,t,1:n.obs] <- getOBS(z = z[i,t],
                                    pN = pN[t-1], pBc = pBc[t-1], pBn = pBn[t-1], 
                                    deltaY = deltaY[t], deltaC = deltaC[t], 
                                    eta = eta, gamma = gamma, alphaTc = alphaTc,
                                    alphaTy = alphaTy,
                                    omegaB = omegaB, omegaA = omegaA,
                                    kappaC = kappaC, kappaY = kappaY)
    } #t
  } #i
  
}) #mod

```

```{r random effects model text}

# THE MODEL:

CIBW_mod <- nimbleCode({
   
  #PRIORS
  
  psiN ~ dunif(0,1) #first time breeding transition
  gamma ~ dunif(0,1)   # P(calf can be put in an age category vs unknown)
  alphaTy ~ dunif(0,1) # P(a YOY calf is identified as such without uncertainty)
  alphaTc ~ dunif(0,1) # P(a 1,2,3, or 4yo calf is identified as such without uncertainty)
  kappaY ~ dunif(0,1)  # P(a YOY is assigned to J1- category)
  kappaC ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J2+ or J3+ categories respectively)
  omegaA ~ dunif(0,1)  # P(a YOY is assigned J1+)
  omegaB ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J3+ or J4+ categories respectively)
  eta ~ dunif(0,1)  # P(being at top of allowable age class)

    for (t in 1:(nyears.ch-1)){  #data starts in 2005, plus 12 survival periods to 2017
        logit(phiB[t]) <- l.phiB + eps.phiB[t]
        logit(phiN[t]) <- l.phiN + eps.phiN[t]
        logit(phiC[t]) <- l.phiC + eps.phiC[t] + l.phiC.corr 
        logit(phiY[t]) <- l.phiY + eps.phiY[t] 
        logit(psiB[t]) <- l.psiB + eps.psiB[t] 
        logit(pN[t]) <- l.pN + eps.pN[t] + b.eff*eff[t+1] 
        logit(pBn[t]) <- l.pBn + eps.pBn[t] + b.eff*eff[t+1] 
        logit(pBc[t]) <- l.pBc + eps.pBc[t] + b.eff*eff[t+1] 
    }
        
     for (t in 1:(nyears.ch)){ 
        logit(deltaY[t]) <- l.deltaY + eps.deltaY[t] + b.eff*eff[t] 
        logit(deltaC[t]) <- l.deltaC + eps.deltaC[t] + b.eff*eff[t] 
      } 
  
     l.phiB <- log(mu.phiB/(1 - mu.phiB))
     mu.phiB ~ dunif(0.5, 1)
     l.phiN <- log(mu.phiN/(1 - mu.phiN))
     mu.phiN ~ dunif(0.5, 1)
     l.phiC <- log(mu.phiC/(1 - mu.phiC))
     mu.phiC ~ dunif(0.3, 1)
     l.phiY <- log(mu.phiY/(1 - mu.phiY))
     mu.phiY ~ dunif(0.5, 1)
     l.psiB <- log(mu.psiB/(1 - mu.psiB))
     mu.psiB ~ dunif(0,1)
     l.pN <- log(mu.pN/(1-mu.pN))
     mu.pN ~ dunif(0,1)
     l.pBn <- log(mu.pBn/(1-mu.pBn))
     mu.pBn ~ dunif(0,1)
     l.pBc <- log(mu.pBc/(1-mu.pBc))
     mu.pBc ~ dunif(0,1)
     l.deltaY <- log(mu.deltaY/(1-mu.deltaY))
     mu.deltaY ~ dunif(0,1)
     l.deltaC <- log(mu.deltaC/(1-mu.deltaC))
     mu.deltaC ~ dunif(0,1)
     
     l.phiC.corr ~ dunif(0,3)
     phiC.corr.prob <- 1/(1+exp(-l.phiC.corr))
     
     #numeric
     b.eff ~ dnorm(0, 0.001)
     
    for (t in 1:(nyears.ch-1)){
    eps.phiB[t] ~ dnorm(0, sd = sigma.phiB)
    eps.phiN[t] ~ dnorm(0, sd = sigma.phiB) #assume same standard dev w/ breeders
    eps.phiC[t] ~ dnorm(0, sd = sigma.phiC)
    eps.phiY[t] ~ dnorm(0, sd = sigma.phiY)
    eps.psiB[t] ~ dnorm(0, sd = sigma.psiB) 
    eps.pN[t] ~ dnorm(0, sd = sigma.pN)
    eps.pBn[t] ~ dnorm(0, sd = sigma.pBn)
    eps.pBc[t] ~ dnorm(0, sd = sigma.pBc)
    }
     
    for (t in 1:(nyears.ch)){ 
    eps.deltaC[t] ~ dnorm(0, sd = sigma.deltaC)
    eps.deltaY[t] ~ dnorm(0, sd = sigma.deltaY)
    }
    
    sigma.phiB ~ dexp(1)
    sigma.phiC ~ dexp(1)
    sigma.phiY ~ dexp(1)
    sigma.psiB ~ dexp(1)
    sigma.pN ~ dexp(1)
    sigma.pBn ~ dexp(1)
    sigma.pBc ~ dexp(1)
    sigma.deltaC ~ dexp(1)
    sigma.deltaY ~ dexp(1)

    ## backtransform to probability scale
    for (t in 1:(nyears.ch-1)) {
      phiB.prob[t] <- 1/(1+exp(-(l.phiB + eps.phiB[t])))
      phiN.prob[t] <- 1/(1+exp(-(l.phiN + eps.phiN[t])))
      phiY.prob[t] <- 1/(1+exp(-(l.phiY + eps.phiY[t])))
      phiC.prob[t] <- 1/(1+exp(-(l.phiC + l.phiC.corr + eps.phiC[t])))
      psiB.prob[t] <- 1/(1+exp(-(l.psiB + eps.psiB[t]))) #range from (0, 0.5)
      phiY.true.prob[t] <- phiB.prob[t]*phiY.prob[t]
      phiC.true.prob[t] <- phiB.prob[t]*phiC.prob[t]
      pBc.prob[t] <- 1/(1+exp(-(l.pBc + eps.pBc[t] + b.eff*eff[t+1])))
      pBn.prob[t] <- 1/(1+exp(-(l.pBn + eps.pBn[t] + b.eff*eff[t+1])))
      pN.prob[t] <- 1/(1+exp(-(l.pN + eps.pN[t] + b.eff*eff[t+1])))
    }
      
      for (t in 1:(nyears.ch)){ 
      deltaY.prob[t] <- 1/(1+exp(-(l.deltaY + eps.deltaY[t] + b.eff*eff[t])))
      deltaC.prob[t] <- 1/(1+exp(-(l.deltaC + eps.deltaC[t] + b.eff*eff[t])))
    }
  
  #set Dirichlet priors for initial states 1:13 (Byoy to Bc4c2; excludes dead state which = 0)
  for (i in 1:13) {
    beta[i] ~ dgamma(1,1) #induce Dirichlet prior
    pi[i]<-beta[i]/sum(beta[1:13]) #help; check
  }
  
    ##### Population model ##

  #Initialize population assuming stable age distribution - year 2004, fills N[1,]

  # conditional binomials
   # total abundance
   Ntot[1] ~ dpois(pop_init)
   pop_init ~ dunif(250,400)

  # age categories
   N[1,1] ~ dbin(stableAge[1], Ntot[1]) #YOTY

   # group 2:(G-1) prob of group g given not in any previous group
   for(g in 2:(G-1)){
    N[1,g] ~ dbin(stableAge[g]/(1-sum(stableAge[1:(g-1)])), Ntot[1] - sum(N[1,1:(g-1)]) )
   }

   # group G: deterministic
   N[1,G] <- Ntot[1] - sum(N[1,1:(G-1)])

    A.NB[1] <- N[1,fec.age+1]
    A.Byoy[1] <- N[1,fec.age+2]
    A.BSk[1] <- N[1,fec.age+3]

  ## Data years

  ### population model state process; 
  
    for (t in 1:1) { #fills N[2,] when t == 1, survival process for 2004-2005
    ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiB*mu.phiY, N[t,1]) #yearlings; use intercepts for years 1 and 14 when no MR data
     N[t+1,3] ~ dbin(mu.phiB*mu.phiY, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(mean(phiC.true.prob[1:(nyears.ch-1)]), N[t,a-1]) #use phiC.true instead of mu bc need to include offset
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*(mu.psiB), A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])
    
    } #t == 1, populations N[2,] == 2005
 
    for (t in 2:(nyears.ch)){  # when t == 2, starts filling N[3,], using phi[1] for 2005-2006 survival
    # last is when t == 13, 2016-2017, fills N[14,] 
    # for demog rates, use t-1 to align with MR data; t-1 means t==1, which matches phi[1] == for 05-06

     ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(phiY.true.prob[t-1], N[t,1]) #yearlings
     N[t+1,3] ~ dbin(phiY.true.prob[t-1], N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(phiC.true.prob[t-1], N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(phiN.prob[t-1], N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(phiB.prob[t-1]*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(phiB.prob[t-1]*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(phiB.prob[t-1]*(psiB.prob[t-1]), A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(phiB.prob[t-1]*(1-psiB.prob[t-1]), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(phiB.prob[t-1], A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])

    } #t data years

  ## gap year between last ch (2017) and aerial survey (2018): t == 14 fills N[15,]
    for (t in (nyears.ch+1):(nyears.ch+nyears.gap)){

      ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiY*mu.phiB, N[t,1]) #yearlings
     N[t+1,3] ~ dbin(mu.phiY*mu.phiB, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(mean(phiC.true.prob[1:(nyears.ch-1)]), N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from G-1 yo (here, 8 yo)
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])
     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from fec.age-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*psiN, N[t,fec.age]) #new B.yoy aging from fec.age-1
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*psiN, A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*mu.psiB, A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])
    }

  # Annual abundance

    for (t in 2:(nyears.ch+nyears.gap+1)) {
      Ntot[t] <- round(sum(N[t, 1:G]))
    } # t

     # Aerial survey model

    for (t in 1:(length(grp.years))){
      N_mu[t] ~ dnorm(N_obs[t], N_tau[t]) #observation error on cnts to estimate N_obs
      # p_grp[t] ~ dbeta(15.35, 1.51) #group detection probability
      p_grp[t] ~ dbeta(1,1) #group detection probability; vague
      # p_grp[t] ~ dbeta(10,3) #group detection probability; peaks at 0.8 more pointy
      # p_grp[t] ~ dbeta(2,1) #group detection probability; broad peaking at 0.9
      N_obs[t] ~ dbin(p_grp[t], round(Ntot[grp.years[t]])) #counts of true state (abundance)
    } #t
  
  # DEFINE PARAMETERS	
  # probabilities for each INITIAL STATE
  px0[1] <- pi[1] # prob. of initial state NB
  px0[2] <- pi[2] # prob. of being in initial state Byoy
  px0[3] <- pi[3] # prob. of being in initial state Bc1
  px0[4] <- pi[4] # prob. of being in initial state Bc2
  px0[5] <- pi[5] # prob. of being in initial state Bc2yoy
  px0[6] <- pi[6] # prob. of being in initial state Bc3
  px0[7] <- pi[7] # prob. of being in initial state Bc3yoy
  px0[8] <- pi[8] # prob. of being in initial state Bc3c1
  px0[9] <- pi[9] # prob. of being in initial state Bc4
  px0[10] <- pi[10] # prob. of being in initial state Bc4yoy
  px0[11] <- pi[11] # prob. of being in initial state Bc4c1
  px0[12] <- pi[12] # prob of initial state Bc4c2
  px0[13] <- pi[13]
  px0[14] <- 0 # prob. of being in initial state dead
  
#### po.init ##
    for (t in 1:(nyears.ch)) {

      #initial observation matrix; same as obs proc matrix without detection, or p == 1
  po.init[1,1:72,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[2,1:72,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[3,1:72,t] <- c(1-1,-1*(deltaY[t]-1), alphaTy*deltaY[t]*1*gamma, -deltaY[t]*gamma*kappaY*1*(alphaTy-1),
                    0, 0, deltaY[t]*gamma*1*(alphaTy-1)*(kappaY-1), 0,0,0,0,0,0,
                    -deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[4,1:72,t] <- c(1-1,-1*(deltaY[t]-1), 0, -deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaY[t]*1*gamma,                       deltaY[t]*1*gamma*omegaA*(alphaTc-1)*(eta-1), deltaY[t]*gamma*1*(alphaTc-1)*(omegaA-1), 0,0,
                    0,0,0,0,-deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[5,1:72,t] <- c(1-1,-1*(deltaC[t]-1), 0,0,0, deltaC[t]*1*gamma*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaC[t]*1*gamma,
                    (alphaTc-1)*(eta-1)*deltaC[t]*1*gamma*omegaA,0,0,0,
                    0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[6,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),
                    -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    -deltaC[t]*gamma*1*(alphaTc-1)*(omegaA-1)*(deltaY[t]-1),
                  deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaY[t]-1)-deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    -deltaC[t]*1*gamma*omegaA*(alphaTc-1)*(deltaY[t]-1)*(eta-1),
                    0,0,0,0,
                    deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaA-1), 0,
                    -alphaTy*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*eta*gamma^2*kappaY*omegaA*(alphaTc-1)*(alphaTy-1),
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1),
                    0,0,deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    -alphaTy*deltaC[t]*deltaY[t]*1*gamma*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*1*(gamma*(alphaTy-1)*(gamma-1)*(kappaY-1)-eta*gamma*omegaA*(alphaTc-1)*(gamma-1)),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    -deltaC[t]*deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(eta-1)*(gamma-1),
                    0,0,0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0,
                    deltaY[t]*deltaC[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaA-1), 0,0,
                    -deltaC[t]*deltaY[t]*eta*(gamma^2)*omegaA*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0)
  po.init[7,1:72,t] <- c(1-1, -1*(deltaC[t]-1), 0,0,0,-deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,
                    deltaC[t]*1*gamma*kappaC*(alphaTc-1)*(omegaB-1),alphaTc*deltaC[t]*1*gamma,
                    -deltaC[t]*gamma*omegaB*1*(alphaTc-1), 0,0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[8,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*1*gamma*(deltaC[t]-1),
                      deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1),0,
                    deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1),
                    -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0,deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),0,0,
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1), 0,0,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),
                    0,-deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0,
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1),
                    0,0,0,0)
  po.init[9,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), 0, deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                    -alphaTc*deltaY[t]*1*gamma*(deltaC[t]-1),
                    deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(deltaY[t]-1)*(omegaB-1)-
                    deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1)*(eta-1),
                    -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1), 0,
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),-alphaTc*deltaC[t]*gamma*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0, deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1), 0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                    0,0,-alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1,
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*(alphaTc-1)^2,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1),
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), 
                    -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1)),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1), 0,
                    -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1),0,0,0,0)
  po.init[10,1:72,t] <- c(1-1, -1*(deltaC[t]-1),0,0,0, -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,
                      -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,deltaC[t]*gamma*kappaC*(alphaTc-1)*(omegaB-1),
                      alphaTc*deltaC[t]*gamma*1, -deltaC[t]*gamma*omegaB*1*(alphaTc-1),
                      -deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[11,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),
                    deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,
                     -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                     (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2, 0,
                     -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                     -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                     deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                     deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2,
                     0,0,0,0,0,0,
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                     (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 0,0,
                     -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0,0,0,
                      alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                      deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,0,
                      alphaTc*alphaTy*deltaY[t]*deltaC[t]*gamma^2*1, -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1),0,0,
                      alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                      deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1),0,0,
                      -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                      (deltaC[t]*deltaY[t]*1*gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,
                      -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),0,
                      (deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                      -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                      deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                      deltaC[t]*deltaY[t]*1*(gamma-1)^2,0,
                      -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0)
  po.init[12,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),0,deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                        -alphaTc*deltaY[t]*gamma*1*(deltaC[t]-1),
                        ((deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2)-deltaY[t]*gamma*omegaA*1*
                        (alphaTc-1)*(deltaC[t]-1)*(eta-1),
                        -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1),0,
                        (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1), -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                        deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                        deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0,0,0,0,
                        -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),0,0,0,
                        -alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                        alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1,
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                        -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                        -deltaC[t]*deltaY[t]*gamma^2*1*omegaA*omegaB*(alphaTc-1)^2*(eta-1),
                        -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                        -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                        -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),0,
                        (deltaY[t]*deltaC[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                        deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                        -(deltaY[t]*deltaC[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0)
  po.init[13,1:72,t] <- c(1-1, 1*(deltaC[t]-1)^2,0,0,0,
                      gamma*1*(alphaTc-1)*(omegaA-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      -eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2), alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      gamma*omegaA*1*(alphaTc-1)*(eta-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      0, gamma*kappaC*1*(alphaTc-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2),
                      alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      -gamma*omegaB*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2),
                      -2*1*(gamma-1)*(deltaC[t]-deltaC[t]^2),0,0,0,0,0,0,0,0,0,0,0,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,0,0,
                      deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                      -deltaC[t]^2*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                      alphaTc*deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      deltaC[t]^2*gamma^2*kappaC*1*omegaA*(alphaTc-1)^2*(eta-1)*(omegaB-1),0,0,0,
                      alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(omegaA-1),
                      -alphaTc*deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1),
                      alphaTc^2*deltaC[t]^2*gamma^2*1,
                      alphaTc*deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),0,0,0,
                      -deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),
                      deltaC[t]^2*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                      -alphaTc*deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1),
                      -deltaC[t]^2*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1),0,0,0,
                      -deltaC[t]^2*1*(gamma*(alphaTc-1)*(gamma-1)*(omegaA-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      deltaC[t]^2*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      -deltaC[t]^2*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      0,-deltaC[t]^2*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      deltaC[t]^2*gamma*omegaB*1*(alphaTc-1)*(gamma-1),deltaC[t]^2*1*(gamma-1)^2,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2)
  po.init[14,1:72,t] <- c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
    }

##### Likelihoods ###
  for (i in 1:n_ind) { # loop over each individual
    # estimated probabilities of initial states are the proportions in each state at
    # first capture occasion
    z[i,First[i]] ~ dcat(px0[1:n.states])
    y[i,First[i]] ~ dcat(po.init[z[i,First[i]],1:n.obs, First[i]]) 

    for (t in (First[i]+1):nyears.ch) {
      ## State Process ##
      # draw states at t given states at t-1
      z[i,t] ~ dcat(state_probs[i,t-1,1:n.states])

      ## Observation Process ##
      # draw observations at t given states at t
      y[i,t] ~ dcat(event_probs[i,t,1:n.obs])

    state_probs[i,t-1,1:n.states] <- getSTATE(z = z[i,t-1],
                                      phiB = phiB[t-1], phiN = phiN[t-1], phiC = phiC[t-1],
                                      phiY = phiY[t-1], psiB = psiB[t-1], psiN = psiN)

    event_probs[i,t,1:n.obs] <- getOBS(z = z[i,t],
                                    pN = pN[t-1], pBc = pBc[t-1], pBn = pBn[t-1], 
                                    deltaY = deltaY[t], deltaC = deltaC[t], 
                                    eta = eta, gamma = gamma, alphaTc = alphaTc,
                                    alphaTy = alphaTy,
                                    omegaB = omegaB, omegaA = omegaA,
                                    kappaC = kappaC, kappaY = kappaY)
    } #t
  } #i
  
}) #mod

```

```{r run no covariate models}

nim.data <- list(N_mu = mu, N_tau = tau, stableAge = stableAge, 
                  eff = c(effort$Land_Vessel_sc[1:13]), 
                  y = as.matrix(CH_data))

nim.constants <- list(nyears.ch = nyears.ch, G = G, fec.age = fec.age, First = e,
                  grp.years = grp.years,
                  nyears.gap = nyears.gap,
                  n.states = n.states, n.obs = n.obs, n_ind = n_ind)

## Initial values
inits <- list(mu.phiB = 0.95, mu.phiC = 0.6, mu.phiY = 0.90, mu.psiB = 0.25, 
                        mu.phiN = 0.92, psiN = runif(1,0.005, 0.1),
                        mu.deltaY = 0.5, mu.deltaC = 0.5, mu.pN = 0.5, mu.pBn = 0.7, mu.pBc = 0.7,
                        alphaTc = 0.06, alphaTy = 0.5, omegaA = 0.96, omegaB = 0.6, 
                        kappaC = 0.63, kappaY = 0.98,
                        gamma = 0.94, eta = 0.03, 
                        eps.phiB = c(rep(0, nyears.ch-1)), eps.phiC = c(rep(0, nyears.ch-1)),
                        eps.phiY = c(rep(0, nyears.ch-1)), eps.psiB = c(rep(0, nyears.ch-1)),
                        eps.phiN = c(rep(0, nyears.ch-1)),
                        eps.pBn = c(rep(0, nyears.ch-1)), eps.pN = c(rep(0, nyears.ch-1)),
                        eps.pBc = c(rep(0, nyears.ch-1)),
                        eps.deltaY = c(rep(0,nyears.ch)), eps.deltaC = c(rep(0,nyears.ch)),
                        z = as.matrix(alive.function()))

params <- c('gamma', 'eta', 'alphaTy', 'alphaTc', 'kappaC', 'kappaY', 'omegaA', 'omegaB',
            'sigma.psiB', 'sigma.phiB', 'sigma.phiY', 'sigma.phiC',
            'sigma.pN', 'sigma.pBc', 'sigma.pBn', 'sigma.deltaY', 'sigma.deltaC',
            'eps.psiB', 'eps.phiB', 'eps.phiN', 'eps.phiY', 'eps.phiC',
            'eps.pN', 'eps.pBc', 'eps.pBn', 'eps.deltaY', 'eps.deltaC',
            'l.phiB', 'l.phiN', 'l.psiB', 'l.phiC', 'l.phiY', 
            'l.pN', 'l.pBc', 'l.pBn', 'l.deltaC', 'l.deltaY',
            'mu.psiB', 'mu.phiB', 'mu.phiN', 'mu.phiC', 'mu.phiY', 
            'mu.pN', 'mu.pBc', 'mu.pBn', 'mu.deltaC', 'mu.deltaY',
            'phiB.prob', 'phiN.prob', 'phiY.prob', 'phiC.prob', 'psiB.prob',
            'phiY.true.prob', 'phiC.true.prob',
            'pN.prob', 'pBc.prob', 'pBn.prob', 'deltaC.prob', 'deltaY.prob',
            'l.phiC.corr', 'phiC.corr.prob', #'b.eff', 
            'deltaY', 'deltaC', 'pi', 'pN', 'pBc', 'pBn', 'psiN', #ME model
            'p_grp',  'N_obs', 'N_mu',  #count model
             'pop_init', 'Ntot', 'N')  #pop model

# run model
n.iter = 40000; n.chains = 3; n.burnin = 20000; nthin = 2; nAdapt = 10

Rmodel <- nimbleModel(code = CIBW_mod, 
                      constants = nim.constants, data = nim.data, 
                      calculate = F, check = F, inits = inits)

conf <- configureMCMC(Rmodel, monitors = params, control = list(adaptInterval = nAdapt),
                      thin = nthin, useConjugacy = FALSE, enableWAIC = TRUE)

Rmcmc <- buildMCMC(conf)
Cmodel <- compileNimble(Rmodel) #builds dag
Cmcmc <- compileNimble(Rmcmc, project = Rmodel)

out <- runMCMC(Cmcmc, niter = n.iter, nburnin = n.burnin, nchains = n.chains, inits = inits,
                 setSeed = FALSE, progressBar = TRUE,
               WAIC = TRUE,
               samplesAsCodaMCMC = TRUE)

# saveRDS(out, here::here('results', 'nimble', paste0('out_null.rds')))
saveRDS(out, here::here('results', 'nimble', paste0('out_RE.rds')))

#posterior predictive distribution (of N_obs)
samples <- out$samples
samples <- samples$chain1
nSamp <- nrow(samples)
n <- length(nim.data$N_mu)
ppSamples <- matrix(0, nSamp, n)

# nSamp <- 6000
ppNobs <- array(0, dim = c(nSamp, n))
for (i in 1:nSamp) {
  rSimNobs <- simNodes(Rmodel, nodes = 'N_obs')
  cSimNobs <- compileNimble(rSimNobs, project = Rmodel) #compiles function
  cSimNobs$run()
  ppNobs[i,] <- Cmodel$N_obs

}

# write.csv(ppNobs, file = here::here(file = 'Output', '2023', 'ppNobs.csv'), row.names = F)

sd_obs <- cv*mu

#posterior predictive distribution (of N_mu)
#take N_obs and then generate N_mu based on tau (data)
ppNmu <- array(0, dim = c(nSamp, n))
for (i in 1:nSamp) {
  for (t in 1:n) {
    ppNmu[i,t] <- rnorm(1, ppNobs[i,t], sd_obs[t])
  }
}

write.csv(ppNmu, file = here::here(file = 'results', 'ppNmu_RE_thinned.csv'), row.names = F)


```

```{r random effects covariate model text}

# THE MODEL:

CIBW_mod <- nimbleCode({
   
  #PRIORS
  
  psiN ~ dunif(0,1) #first time breeding transition
  gamma ~ dunif(0,1)   # P(calf can be put in an age category vs unknown)
  alphaTy ~ dunif(0,1) # P(a YOY calf is identified as such without uncertainty)
  alphaTc ~ dunif(0,1) # P(a 1,2,3, or 4yo calf is identified as such without uncertainty)
  kappaY ~ dunif(0,1)  # P(a YOY is assigned to J1- category)
  kappaC ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J2+ or J3+ categories respectively)
  omegaA ~ dunif(0,1)  # P(a YOY is assigned J1+)
  omegaB ~ dunif(0,1)  # P(a 3 or 4yo is assigned to the J3+ or J4+ categories respectively)
  eta ~ dunif(0,1)  # P(being at top of allowable age class)

    for (t in 1:(nyears.ch-1)){  #data starts in 2005, plus 12 survival periods to 2017
        logit(phiB[t]) <- l.phiB + 
          b.sst_goa.b*sst_goa[t] +
          b.all_fish.b*all_fish[t] +
      #for appendix models
        # b.sect.b*sect[t] +
        # b.takes.b*takes[t] +
        # b.anch.b*anch_pop[t] +
        # b.mur.b*murres[t] +
        # b.kit.b*kitti[t] +
        # b.osm.b*osmer[t] +
        # b.eul.by.b*eul_by[t] +
        # b.ship.b*ship[t] +
        # b.haz.b*haz[t] +
        # b.chinook.b*chinook[t] +
        # b.PDO.b*PDO[t] +
        # b.npgo.b*NPGO[t] +
        # b.up.b*up[t] +
        # b.prod.b*prod[t] +
        # b.coho.b*sus_coho_LS[t] +
        # b.pink.b*sus_pink[t] +
        # b.sock.b*knik_sock[t] +
        # b.chum.b*CI_chum[t] +
        # b.eul.b*CI_eul[t] +
          eps.phiB[t]
        logit(phiN[t]) <- l.phiN + 
          b.sst_goa.b*sst_goa[t] +
          b.all_fish.b*all_fish[t] +
        # b.anch.b*anch_pop[t] +
        # b.mur.b*murres[t] +
        # b.kit.b*kitti[t] +
        # b.pol.b*pollock[t] +
        # b.eul.bio.b*eul_b[t] +
        # b.osm.b*osmer[t] +
        # b.chinook.b*chinook[t] +
        # b.PDO.b*PDO[t] +
        # b.npgo.b*NPGO[t] +
        # b.up.b*up[t] +
        # b.prod.b*prod[t] +
        # b.coho.b*sus_coho_LS[t] +
        # b.pink.b*sus_pink[t] +
        # b.sock.b*knik_sock[t] +
        # b.chum.b*CI_chum[t] +
        # b.eul.b*CI_eul[t] +
          eps.phiN[t]
        logit(phiC[t]) <- l.phiC + 
          b.sst_goa.c*sst_goa[t] +
          b.all_fish.c*all_fish[t] +
        # b.anch.c*anch_pop[t] +
        # b.mur.c*murres[t] +
        # b.kit.c*kitti[t] +
        # b.pol.c*pollock[t] +
        # b.eul.bio.c*eul_b[t] +
        # b.osm.c*osmer[t] +
        # b.chinook.c*chinook[t] +
        # b.PDO.c*PDO[t] +
        # b.up.c*up[t] +
        # b.prod.c*prod[t] +
        # b.npgo.c*NPGO[t] +
        # b.coho.c*sus_coho_LS[t] +
        # b.pink.c*sus_pink[t] +
        # b.sock.c*knik_sock[t] +
        # b.chum.c*CI_chum[t] +
        # b.eul.c*CI_eul[t] +
          eps.phiC[t] + l.phiC.corr 
        logit(phiY[t]) <- l.phiY + 
          b.sst_goa.y*sst_goa[t] +
          b.all_fish.y*all_fish[t] +
        # b.anch.y*anch_pop[t] +
        # b.mur.y*murres[t] +
        # b.kit.y*kitti[t] +
        # b.pol.y*pollock[t] +
        # b.eul.bio.y*eul_b[t] +
        # b.osm.y*osmer[t] +
        # b.chinook.y*chinook[t] +
        # b.PDO.y*PDO[t] +
        # b.up.y*up[t] +
        # b.prod.y*prod[t] +
        # b.npgo.y*NPGO[t] +
        # b.coho.y*sus_coho_LS[t] +
        # b.pink.y*sus_pink[t] +
        # b.sock.y*knik_sock[t] +
        # b.chum.y*CI_chum[t] +
        # b.eul.y*CI_eul[t] +
          eps.phiY[t] 
        logit(psiB[t]) <- l.psiB + eps.psiB[t] +
          b.all_fish.psi*all_fish[t] +
          b.sst_goa.psi*sst_goa[t] #+
        # b.anch.psi*anch_pop[t]
        # b.mur.psi*murres[t]
        # b.kit.psi*kitti[t]
        # b.pol.psi*pollock[t]
        # b.eul.bio.psi*eul_b[t]
        # b.osm.psi*osmer[t]
        # b.chinook.psi*chinook[t] #+
        # b.PDO.psi*PDO[t] #+
        # b.npgo.psi*NPGO[t] #+
        # b.up.psi*up[t] #+
        # b.prod.psi*prod[t] #+
        # b.coho.psi*sus_coho_LS[t] #+
        # b.pink.psi*sus_pink[t] #+
        # b.sock.psi*knik_sock[t] #+
        # b.chum.psi*CI_chum[t] #+
        # b.eul.psi*CI_eul[t]
        logit(pN[t]) <- l.pN + eps.pN[t] + b.eff*eff[t+1] 
        logit(pBn[t]) <- l.pBn + eps.pBn[t] + b.eff*eff[t+1] 
        logit(pBc[t]) <- l.pBc + eps.pBc[t] + b.eff*eff[t+1] 
    }
        
     for (t in 1:(nyears.ch)){ 
        logit(deltaY[t]) <- l.deltaY + eps.deltaY[t] + b.eff*eff[t] 
        logit(deltaC[t]) <- l.deltaC + eps.deltaC[t] + b.eff*eff[t] 
      } # t
  
     l.phiB <- log(mu.phiB/(1 - mu.phiB))
     mu.phiB ~ dunif(0.5, 1)
     l.phiN <- log(mu.phiN/(1 - mu.phiN))
     mu.phiN ~ dunif(0.5, 1)
     l.phiC <- log(mu.phiC/(1 - mu.phiC))
     mu.phiC ~ dunif(0.3, 1)
     l.phiY <- log(mu.phiY/(1 - mu.phiY))
     mu.phiY ~ dunif(0.5, 1)
     l.psiB <- log(mu.psiB/(1 - mu.psiB))
     mu.psiB ~ dunif(0,1)
     l.pN <- log(mu.pN/(1-mu.pN))
     mu.pN ~ dunif(0,1)
     l.pBn <- log(mu.pBn/(1-mu.pBn))
     mu.pBn ~ dunif(0,1)
     l.pBc <- log(mu.pBc/(1-mu.pBc))
     mu.pBc ~ dunif(0,1)
     l.deltaY <- log(mu.deltaY/(1-mu.deltaY))
     mu.deltaY ~ dunif(0,1)
     l.deltaC <- log(mu.deltaC/(1-mu.deltaC))
     mu.deltaC ~ dunif(0,1)
     
     l.phiC.corr ~ dunif(0,3)
     phiC.corr.prob <- 1/(1+exp(-l.phiC.corr))
     
     #numeric
     b.eff ~ dnorm(0, 0.001)
     
    for (t in 1:(nyears.ch-1)){
    eps.phiB[t] ~ dnorm(0, sd = sigma.phiB)
    eps.phiN[t] ~ dnorm(0, sd = sigma.phiB) #assume same standard dev w/ breeders
    eps.phiC[t] ~ dnorm(0, sd = sigma.phiC)
    eps.phiY[t] ~ dnorm(0, sd = sigma.phiY)
    eps.psiB[t] ~ dnorm(0, sd = sigma.psiB) 
    eps.pN[t] ~ dnorm(0, sd = sigma.pN)
    eps.pBn[t] ~ dnorm(0, sd = sigma.pBn)
    eps.pBc[t] ~ dnorm(0, sd = sigma.pBc)
    }
     
    for (t in 1:(nyears.ch)){ 
    eps.deltaC[t] ~ dnorm(0, sd = sigma.deltaC)
    eps.deltaY[t] ~ dnorm(0, sd = sigma.deltaY)
    }
    
    sigma.phiB ~ dexp(1)
    sigma.phiC ~ dexp(1)
    sigma.phiY ~ dexp(1)
    sigma.psiB ~ dexp(1)
    
    sigma.pN ~ dexp(1)
    sigma.pBn ~ dexp(1)
    sigma.pBc ~ dexp(1)
    sigma.deltaC ~ dexp(1)
    sigma.deltaY ~ dexp(1)
    
    b.all_fish.b ~ dnorm(0,sd = s.all_fish.b)
    b.all_fish.c ~ dnorm(0,sd = s.all_fish.c)
    b.all_fish.y ~ dnorm(0,sd = s.all_fish.y)
    b.all_fish.psi ~ dnorm(0,sd = s.all_fish.psi)
    s.all_fish.b ~ dexp(1)
    s.all_fish.c ~ dexp(1)
    s.all_fish.y ~ dexp(1)
    s.all_fish.psi ~ dexp(1)
    
    b.sst_goa.b ~ dnorm(0,sd = s.sst_goa.b)
    b.sst_goa.c ~ dnorm(0,sd = s.sst_goa.c)
    b.sst_goa.y ~ dnorm(0,sd = s.sst_goa.y)
    b.sst_goa.psi ~ dnorm(0,sd = s.sst_goa.psi)
    s.sst_goa.b ~ dexp(1)
    s.sst_goa.c ~ dexp(1)
    s.sst_goa.y ~ dexp(1)
    s.sst_goa.psi ~ dexp(1)

    # b.pol.b ~ dnorm(0,sd = s.pol.b)
    # b.pol.c ~ dnorm(0,sd = s.pol.c)
    # b.pol.y ~ dnorm(0,sd = s.pol.y)
    # b.pol.psi ~ dnorm(0,sd = s.pol.psi)
    # s.pol.b ~ dexp(1)
    # s.pol.c ~ dexp(1)
    # s.pol.y ~ dexp(1)
    # s.pol.psi ~ dexp(1)
    
    # b.chinook.b ~ dnorm(0,sd = s.chinook.b)
    # b.chinook.c ~ dnorm(0,sd = s.chinook.c)
    # b.chinook.y ~ dnorm(0,sd = s.chinook.y)
    # b.chinook.psi ~ dnorm(0,sd = s.chinook.psi)
    # s.chinook.b ~ dexp(1)
    # s.chinook.c ~ dexp(1)
    # s.chinook.y ~ dexp(1)
    # s.chinook.psi ~ dexp(1)
    
    # b.kit.b ~ dnorm(0,sd = s.kit.b)
    # b.kit.c ~ dnorm(0,sd = s.kit.c)
    # b.kit.y ~ dnorm(0,sd = s.kit.y)
    # b.kit.psi ~ dnorm(0,sd = s.kit.psi)
    # s.kit.b ~ dexp(1)
    # s.kit.c ~ dexp(1)
    # s.kit.y ~ dexp(1)
    # s.kit.psi ~ dexp(1)
    # 
    # b.mur.b ~ dnorm(0,sd = s.mur.b)
    # b.mur.c ~ dnorm(0,sd = s.mur.c)
    # b.mur.y ~ dnorm(0,sd = s.mur.y)
    # b.mur.psi ~ dnorm(0,sd = s.mur.psi)
    # s.mur.b ~ dexp(1)
    # s.mur.c ~ dexp(1)
    # s.mur.y ~ dexp(1)
    # s.mur.psi ~ dexp(1)
    # 
    # b.anch.b ~ dnorm(0,sd = s.anch.b)
    # b.anch.c ~ dnorm(0,sd = s.anch.c)
    # b.anch.y ~ dnorm(0,sd = s.anch.y)
    # b.anch.psi ~ dnorm(0,sd = s.anch.psi)
    # s.anch.b ~ dexp(1)
    # s.anch.c ~ dexp(1)
    # s.anch.y ~ dexp(1)
    # s.anch.psi ~ dexp(1)
    # 
    # b.eul.bio.b ~ dnorm(0,sd = s.eul.bio.b)
    # b.eul.bio.c ~ dnorm(0,sd = s.eul.bio.c)
    # b.eul.bio.y ~ dnorm(0,sd = s.eul.bio.y)
    # b.eul.bio.psi ~ dnorm(0,sd = s.eul.bio.psi)
    # s.eul.bio.b ~ dexp(1)
    # s.eul.bio.c ~ dexp(1)
    # s.eul.bio.y ~ dexp(1)
    # s.eul.bio.psi ~ dexp(1)
    # 
    # b.osm.b ~ dnorm(0,sd = s.osm.b)
    # b.osm.c ~ dnorm(0,sd = s.osm.c)
    # b.osm.y ~ dnorm(0,sd = s.osm.y)
    # b.osm.psi ~ dnorm(0,sd = s.osm.psi)
    # s.osm.b ~ dexp(1)
    # s.osm.c ~ dexp(1)
    # s.osm.y ~ dexp(1)
    # s.osm.psi ~ dexp(1)
    # 
    # b.up.b ~ dnorm(0,sd = s.up.b)
    # b.up.c ~ dnorm(0,sd = s.up.c)
    # b.up.y ~ dnorm(0,sd = s.up.y)
    # b.up.psi ~ dnorm(0,sd = s.up.psi)
    # s.up.b ~ dexp(1)
    # s.up.c ~ dexp(1)
    # s.up.y ~ dexp(1)
    # s.up.psi ~ dexp(1)
    
    # b.PDO.b ~ dnorm(0,sd = s.PDO.b)
    # b.PDO.c ~ dnorm(0,sd = s.PDO.c)
    # b.PDO.y ~ dnorm(0,sd = s.PDO.y)
    # b.PDO.psi ~ dnorm(0,sd = s.PDO.psi)
    # s.PDO.b ~ dexp(1)
    # s.PDO.c ~ dexp(1)
    # s.PDO.y ~ dexp(1)
    # s.PDO.psi ~ dexp(1)
    # 
    # b.npgo.b ~ dnorm(0,sd = s.npgo.b)
    # b.npgo.c ~ dnorm(0,sd = s.npgo.c)
    # b.npgo.y ~ dnorm(0,sd = s.npgo.y)
    # b.npgo.psi ~ dnorm(0,sd = s.npgo.psi)
    # s.npgo.b ~ dexp(1)
    # s.npgo.c ~ dexp(1)
    # s.npgo.y ~ dexp(1)
    # s.npgo.psi ~ dexp(1)
    # 
    # b.prod.b ~ dnorm(0,sd = s.prod.b)
    # b.prod.c ~ dnorm(0,sd = s.prod.c)
    # b.prod.y ~ dnorm(0,sd = s.prod.y)
    # b.prod.psi ~ dnorm(0,sd = s.prod.psi)
    # s.prod.b ~ dexp(1)
    # s.prod.c ~ dexp(1)
    # s.prod.y ~ dexp(1)
    # s.prod.psi ~ dexp(1)
    
    # b.coho.psi ~ dnorm(0,sd = s.coho.psi)
    # s.coho.psi ~ dexp(1)
    # b.coho.b ~ dnorm(0,sd = s.coho.b)
    # s.coho.b ~ dexp(1)
    # b.coho.c ~ dnorm(0,sd = s.coho.c)
    # s.coho.c ~ dexp(1)
    # b.coho.y ~ dnorm(0,sd = s.coho.y)
    # s.coho.y ~ dexp(1)
    
    # b.pink.psi ~ dnorm(0,sd = s.pink.psi)
    # s.pink.psi ~ dexp(1)
    # b.pink.b ~ dnorm(0,sd = s.pink.b)
    # s.pink.b ~ dexp(1)
    # b.pink.c ~ dnorm(0,sd = s.pink.c)
    # s.pink.c ~ dexp(1)
    # b.pink.y ~ dnorm(0,sd = s.pink.y)
    # s.pink.y ~ dexp(1)
    # 
    # b.sock.psi ~ dnorm(0,sd = s.sock.psi)
    # s.sock.psi ~ dexp(1)
    # b.sock.b ~ dnorm(0,sd = s.sock.b)
    # s.sock.b ~ dexp(1)
    # b.sock.c ~ dnorm(0,sd = s.sock.c)
    # s.sock.c ~ dexp(1)
    # b.sock.y ~ dnorm(0,sd = s.sock.y)
    # s.sock.y ~ dexp(1)
    # 
    # b.eul.psi ~ dnorm(0,sd = s.eul.psi)
    # s.eul.psi ~ dexp(1)
    # b.eul.b ~ dnorm(0,sd = s.eul.b)
    # s.eul.b ~ dexp(1)
    # b.eul.c ~ dnorm(0,sd = s.eul.c)
    # s.eul.c ~ dexp(1)
    # b.eul.y ~ dnorm(0,sd = s.eul.y)
    # s.eul.y ~ dexp(1)
    # 
    # b.chum.psi ~ dnorm(0,sd = s.chum.psi)
    # s.chum.psi ~ dexp(1)
    # b.chum.b ~ dnorm(0,sd = s.chum.b)
    # s.chum.b ~ dexp(1)
    # b.chum.c ~ dnorm(0,sd = s.chum.c)
    # s.chum.c ~ dexp(1)
    # b.chum.y ~ dnorm(0,sd = s.chum.y)
    # s.chum.y ~ dexp(1)

    ## backtransform to probability scale
    for (t in 1:(nyears.ch-1)) {
      phiB.prob[t] <- 1/(1+exp(-(l.phiB + eps.phiB[t])))
      phiN.prob[t] <- 1/(1+exp(-(l.phiN + eps.phiN[t])))
      phiY.prob[t] <- 1/(1+exp(-(l.phiY + eps.phiY[t])))
      phiC.prob[t] <- 1/(1+exp(-(l.phiC + l.phiC.corr + eps.phiC[t])))
      psiB.prob[t] <- 1/(1+exp(-(l.psiB + eps.psiB[t]))) #range from (0, 0.5)
      phiY.true.prob[t] <- phiB.prob[t]*phiY.prob[t]
      phiC.true.prob[t] <- phiB.prob[t]*phiC.prob[t]
      pBc.prob[t] <- 1/(1+exp(-(l.pBc + eps.pBc[t] + b.eff*eff[t+1])))
      pBn.prob[t] <- 1/(1+exp(-(l.pBn + eps.pBn[t] + b.eff*eff[t+1])))
      pN.prob[t] <- 1/(1+exp(-(l.pN + eps.pN[t] + b.eff*eff[t+1])))
    }
      
      for (t in 1:(nyears.ch)){ 
      deltaY.prob[t] <- 1/(1+exp(-(l.deltaY + eps.deltaY[t] + b.eff*eff[t])))
      deltaC.prob[t] <- 1/(1+exp(-(l.deltaC + eps.deltaC[t] + b.eff*eff[t])))
    }
  
  #set Dirichlet priors for initial states 1:13 (Byoy to Bc4c2; excludes dead state which = 0)
  for (i in 1:13) {
    beta[i] ~ dgamma(1,1) #induce Dirichlet prior
    pi[i]<-beta[i]/sum(beta[1:13]) #help; check
  }
  
    ##### Population model ##

  #Initialize population assuming stable age distribution - year 2004, fills N[1,]

  # conditional binomials
   # total abundance
   Ntot[1] ~ dpois(pop_init)
   pop_init ~ dunif(250,400)

  # age categories
   N[1,1] ~ dbin(stableAge[1], Ntot[1]) #YOTY

   # group 2:(G-1) prob of group g given not in any previous group
   for(g in 2:(G-1)){
    N[1,g] ~ dbin(stableAge[g]/(1-sum(stableAge[1:(g-1)])), Ntot[1] - sum(N[1,1:(g-1)]) )
   }

   # group G: deterministic
   N[1,G] <- Ntot[1] - sum(N[1,1:(G-1)])

    A.NB[1] <- N[1,fec.age+1]
    A.Byoy[1] <- N[1,fec.age+2]
    A.BSk[1] <- N[1,fec.age+3]

  ## Data years

  ### population model state process; 
  
    for (t in 1:1) { #fills N[2,] when t == 1, survival process for 2004-2005
    ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiB*mu.phiY, N[t,1]) #yearlings; use intercepts for years 1 and 14 when no MR data
     N[t+1,3] ~ dbin(mu.phiB*mu.phiY, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(mean(phiC.true.prob[1:(nyears.ch-1)]), N[t,a-1]) #use phiC.true instead of mu bc need to include offset
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*(mu.psiB), A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])
    
    } #t == 1, populations N[2,] == 2005
 
    for (t in 2:(nyears.ch)){  # when t == 2, starts filling N[3,], using phi[1] for 2005-2006 survival
    # last is when t == 13, 2016-2017, fills N[14,] 
    # for demog rates, use t-1 to align with MR data; t-1 means t==1, which matches phi[1] == for 05-06

     ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(phiY.true.prob[t-1], N[t,1]) #yearlings
     N[t+1,3] ~ dbin(phiY.true.prob[t-1], N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(phiC.true.prob[t-1], N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(phiN.prob[t-1], N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), N[t,fec.age]) #new NB aging from fec.age-1 yo

     #repeat NB from total NB group[t]
     Aplus.NB[t+1] ~ dbin(phiN.prob[t-1]*(1-psiN), A.NB[t])

     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from G-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(phiB.prob[t-1]*(psiN), N[t,fec.age]) #new B.yoy aging from G-1 (here, 8 yo)
     Aplus.Byoy.NB[t+1] ~ dbin(phiB.prob[t-1]*(psiN), A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(phiB.prob[t-1]*(psiB.prob[t-1]), A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(phiB.prob[t-1]*(1-psiB.prob[t-1]), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(phiB.prob[t-1], A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])

    } #t data years

  ## gap year between last ch (2017) and aerial survey (2018): t == 14 fills N[15,]
    for (t in (nyears.ch+1):(nyears.ch+nyears.gap)){

      ### YOTY/CALVES ###
     N[t+1,1] <- A.Byoy[t+1] #YOY
     N[t+1,2] ~ dbin(mu.phiY*mu.phiB, N[t,1]) #yearlings
     N[t+1,3] ~ dbin(mu.phiY*mu.phiB, N[t,2]) #2yo calf

     for (a in 4:6) { #calves age 3-5
     N[t+1,a] ~ dbin(mean(phiC.true.prob[1:(nyears.ch-1)]), N[t,a-1])
     } #a

     ### PB and MALES ###
     for (aa in 7:fec.age) { #new 6-8 year olds
     N[t+1,aa] ~ dbin(mu.phiN, N[t,aa-1])
     } #aa

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###

     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[t+1] ~ dbin(mu.phiN*(1-psiN), N[t,fec.age]) #new NB aging from G-1 yo (here, 8 yo)
     Aplus.NB[t+1] ~ dbin(mu.phiN*(1-psiN), A.NB[t])
     A.NB[t+1] <- Anew.NB[t+1] + Aplus.NB[t+1]

     ## B.yoy group (from fec.age-1, NB plus, Sk)
     Anew.Byoy[t+1] ~ dbin(mu.phiB*psiN, N[t,fec.age]) #new B.yoy aging from fec.age-1
     Aplus.Byoy.NB[t+1] ~ dbin(mu.phiB*psiN, A.NB[t]) #new B.yoy from NB
     Aplus.Byoy.Sk[t+1] ~ dbin(mu.phiB*mu.psiB, A.BSk[t]) #help; repeat B.yoy from A.BSk[t]

     A.Byoy[t+1] <- Aplus.Byoy.NB[t+1] + Anew.Byoy[t+1] + Aplus.Byoy.Sk[t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[t+1] ~ dbin(mu.phiB*(1-mu.psiB), A.BSk[t]) #repeat B.Sk from B.Sk
     A.Byoy.age[t+1] ~ dbin(mu.phiB, A.Byoy[t])  #aging B.yoy

     A.BSk[t+1] <- A.Byoy.age[t+1] + A.BSk.stay[t+1]

     #return to the N[t,age] matrix and fill in groups
     N[t+1,fec.age+1] <- A.NB[t+1] #all 9+ NB
     N[t+1,fec.age+2] <- A.Byoy[t+1] #all 9+ Byoy
     N[t+1,fec.age+3] <- A.BSk[t+1] #all 9+ skip breeders

     # Ntot[t+1] = sum(N[t+1,1:G])
    }

  # Annual abundance

    for (t in 2:(nyears.ch+nyears.gap+1)) {
      Ntot[t] <- round(sum(N[t, 1:G]))
    } # t

     # Aerial survey model

    for (t in 1:(length(grp.years))){
      N_mu[t] ~ dnorm(N_obs[t], N_tau[t]) #observation error on cnts to estimate N_obs
      # p_grp[t] ~ dbeta(15.35, 1.51) #group detection probability
      p_grp[t] ~ dbeta(1,1) #group detection probability; vague
      # p_grp[t] ~ dbeta(10,3) #group detection probability; peaks at 0.8 more pointy
      # p_grp[t] ~ dbeta(2,1) #group detection probability; broad peaking at 0.9
      N_obs[t] ~ dbin(p_grp[t], round(Ntot[grp.years[t]])) #counts of true state (abundance)
    } #t
  
  # DEFINE PARAMETERS	
  # probabilities for each INITIAL STATE
  px0[1] <- pi[1] # prob. of initial state NB
  px0[2] <- pi[2] # prob. of being in initial state Byoy
  px0[3] <- pi[3] # prob. of being in initial state Bc1
  px0[4] <- pi[4] # prob. of being in initial state Bc2
  px0[5] <- pi[5] # prob. of being in initial state Bc2yoy
  px0[6] <- pi[6] # prob. of being in initial state Bc3
  px0[7] <- pi[7] # prob. of being in initial state Bc3yoy
  px0[8] <- pi[8] # prob. of being in initial state Bc3c1
  px0[9] <- pi[9] # prob. of being in initial state Bc4
  px0[10] <- pi[10] # prob. of being in initial state Bc4yoy
  px0[11] <- pi[11] # prob. of being in initial state Bc4c1
  px0[12] <- pi[12] # prob of initial state Bc4c2
  px0[13] <- pi[13]
  px0[14] <- 0 # prob. of being in initial state dead
  
#### po.init ##
    for (t in 1:(nyears.ch)) {

      #initial observation matrix; same as obs proc matrix without detection, or p == 1
  po.init[1,1:72,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[2,1:72,t] <- c(1-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[3,1:72,t] <- c(1-1,-1*(deltaY[t]-1), alphaTy*deltaY[t]*1*gamma, -deltaY[t]*gamma*kappaY*1*(alphaTy-1),
                    0, 0, deltaY[t]*gamma*1*(alphaTy-1)*(kappaY-1), 0,0,0,0,0,0,
                    -deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[4,1:72,t] <- c(1-1,-1*(deltaY[t]-1), 0, -deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaY[t]*1*gamma,                       deltaY[t]*1*gamma*omegaA*(alphaTc-1)*(eta-1), deltaY[t]*gamma*1*(alphaTc-1)*(omegaA-1), 0,0,
                    0,0,0,0,-deltaY[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[5,1:72,t] <- c(1-1,-1*(deltaC[t]-1), 0,0,0, deltaC[t]*1*gamma*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1), alphaTc*deltaC[t]*1*gamma,
                    (alphaTc-1)*(eta-1)*deltaC[t]*1*gamma*omegaA,0,0,0,
                    0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[6,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),
                    -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    -deltaC[t]*gamma*1*(alphaTc-1)*(omegaA-1)*(deltaY[t]-1),
                  deltaC[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaY[t]-1)-deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    -deltaC[t]*1*gamma*omegaA*(alphaTc-1)*(deltaY[t]-1)*(eta-1),
                    0,0,0,0,
                    deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaA-1), 0,
                    -alphaTy*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*eta*gamma^2*kappaY*omegaA*(alphaTc-1)*(alphaTy-1),
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1),
                    0,0,deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(alphaTy-1)*(eta-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    -alphaTy*deltaC[t]*deltaY[t]*1*gamma*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),
                    -deltaC[t]*deltaY[t]*1*(gamma*(alphaTy-1)*(gamma-1)*(kappaY-1)-eta*gamma*omegaA*(alphaTc-1)*(gamma-1)),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    -deltaC[t]*deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(eta-1)*(gamma-1),
                    0,0,0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0,
                    deltaY[t]*deltaC[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaA-1), 0,0,
                    -deltaC[t]*deltaY[t]*eta*(gamma^2)*omegaA*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0)
  po.init[7,1:72,t] <- c(1-1, -1*(deltaC[t]-1), 0,0,0,-deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,
                    deltaC[t]*1*gamma*kappaC*(alphaTc-1)*(omegaB-1),alphaTc*deltaC[t]*1*gamma,
                    -deltaC[t]*gamma*omegaB*1*(alphaTc-1), 0,0,-deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[8,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*1*gamma*(deltaC[t]-1),
                      deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1),0,
                    deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1),
                    -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0,deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,
                    alphaTc*alphaTy*deltaC[t]*deltaY[t]*gamma^2*1,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTy-1),0,0,
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),
                    -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1), 0,0,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                    deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),
                    0,-deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                    deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2, 0,
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1),
                    0,0,0,0)
  po.init[9,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), 0, deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                    -alphaTc*deltaY[t]*1*gamma*(deltaC[t]-1),
                    deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(deltaY[t]-1)*(omegaB-1)-
                    deltaY[t]*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1)*(eta-1),
                    -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1), 0,
                    -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),-alphaTc*deltaC[t]*gamma*(deltaY[t]-1),
                    deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                    0,0, deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1), 0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1),0,0,0,0,0,0,
                    -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                    deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                    0,0,-alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                    alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1,
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                    alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,
                    deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*(alphaTc-1)^2,
                    -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1),
                    -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), 
                    -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1)),
                    -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1), 0,
                    -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                    -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),0,0,
                    deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                    -deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1),
                    -deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1),0,0,0,0)
  po.init[10,1:72,t] <- c(1-1, -1*(deltaC[t]-1),0,0,0, -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,
                      -(deltaC[t]*gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,deltaC[t]*gamma*kappaC*(alphaTc-1)*(omegaB-1),
                      alphaTc*deltaC[t]*gamma*1, -deltaC[t]*gamma*omegaB*1*(alphaTc-1),
                      -deltaC[t]*1*(gamma-1),0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
  po.init[11,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1), -alphaTy*deltaY[t]*gamma*1*(deltaC[t]-1),
                    deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(deltaC[t]-1), 0,
                    (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,
                     -deltaY[t]*gamma*1*(alphaTy-1)*(deltaC[t]-1)*(kappaY-1),0,
                     (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2, 0,
                     -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1),
                     -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                     deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                     deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2,
                     0,0,0,0,0,0,
                     -(alphaTy*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                     (deltaC[t]*deltaY[t]*gamma^2*kappaY*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(omegaB-1))/2, 0,0,
                     -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0,0,0,
                      alphaTy*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      -deltaC[t]*deltaY[t]*gamma^2*kappaC*kappaY*1*(alphaTc-1)*(alphaTy-1)*(omegaB-1),0,0,
                      deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1)*(omegaB-1),0,0,
                      alphaTc*alphaTy*deltaY[t]*deltaC[t]*gamma^2*1, -alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1),0,0,
                      alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                      deltaC[t]*deltaY[t]*gamma^2*kappaY*omegaB*1*(alphaTc-1)*(alphaTy-1),0,0,
                      -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)*(alphaTy-1)*(kappaY-1),0,0,
                      -alphaTy*deltaC[t]*deltaY[t]*gamma*1*(gamma-1), deltaC[t]*deltaY[t]*gamma*kappaY*1*(alphaTy-1)*(gamma-1),0,
                      (deltaC[t]*deltaY[t]*1*gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,
                      -deltaC[t]*deltaY[t]*gamma*1*(alphaTy-1)*(gamma-1)*(kappaY-1),0,
                      (deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),
                      -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                      deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                      deltaC[t]*deltaY[t]*1*(gamma-1)^2,0,
                      -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(alphaTy-1)*(kappaC-1)*(kappaY-1)*(omegaB-1))/2,0,0,0,0)
  po.init[12,1:72,t] <- c(1-1, 1*(deltaC[t]-1)*(deltaY[t]-1),0,deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-1),
                        -alphaTc*deltaY[t]*gamma*1*(deltaC[t]-1),
                        ((deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2)-deltaY[t]*gamma*omegaA*1*
                        (alphaTc-1)*(deltaC[t]-1)*(eta-1),
                        -deltaY[t]*gamma*1*(alphaTc-1)*(deltaC[t]-1)*(omegaA-1),0,
                        (deltaC[t]*gamma*1*(alphaTc-1)*(deltaY[t]-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*gamma*kappaC*1*(alphaTc-1)*(deltaY[t]-1)*(omegaB-1), -alphaTc*deltaC[t]*gamma*1*(deltaY[t]-1),
                        deltaC[t]*gamma*omegaB*1*(alphaTc-1)*(deltaY[t]-1),
                        deltaC[t]*1*(deltaY[t]-1)*(gamma-1)+deltaY[t]*1*(deltaC[t]-1)*(gamma-1),0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,
                        (deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                        -(alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0,0,0,0,
                        -deltaC[t]*deltaY[t]*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(eta-1)*(omegaB-1),
                        deltaC[t]*deltaY[t]*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),0,0,0,
                        -alphaTc*deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*1*(alphaTc-1),
                        alphaTc^2*deltaC[t]*deltaY[t]*gamma^2*1,
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),
                        alphaTc*deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                        -alphaTc*deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1),
                        -deltaC[t]*deltaY[t]*gamma^2*1*omegaA*omegaB*(alphaTc-1)^2*(eta-1),
                        -deltaC[t]*deltaY[t]*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),0,0,0,
                        deltaC[t]*deltaY[t]*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),
                        -alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        -deltaC[t]*deltaY[t]*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                        -deltaC[t]*deltaY[t]*gamma*1*(alphaTc-1)*(gamma-1)*(omegaA-1),0,
                        (deltaY[t]*deltaC[t]*gamma*1*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2,0,
                        -deltaC[t]*deltaY[t]*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]*deltaY[t]*gamma*1*(gamma-1),
                        deltaC[t]*deltaY[t]*gamma*omegaB*1*(alphaTc-1)*(gamma-1),
                        deltaC[t]*deltaY[t]*1*(gamma-1)^2,
                        -(deltaY[t]*deltaC[t]*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,
                        -(deltaC[t]*deltaY[t]*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,0,0,0,0)
  po.init[13,1:72,t] <- c(1-1, 1*(deltaC[t]-1)^2,0,0,0,
                      gamma*1*(alphaTc-1)*(omegaA-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      -eta*gamma*omegaA*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2), alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      gamma*omegaA*1*(alphaTc-1)*(eta-1)*(deltaC[t]-deltaC[t]^2)-((gamma*1*(alphaTc-1)*(kappaC-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2))/2),
                      0, gamma*kappaC*1*(alphaTc-1)*(omegaB-1)*(deltaC[t]-deltaC[t]^2),
                      alphaTc*gamma*1*(deltaC[t]-deltaC[t]^2),
                      -gamma*omegaB*1*(alphaTc-1)*(deltaC[t]-deltaC[t]^2),
                      -2*1*(gamma-1)*(deltaC[t]-deltaC[t]^2),0,0,0,0,0,0,0,0,0,0,0,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,0,0,0,0,0,0,0,0,
                      deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)^2*(omegaA-1)*(omegaB-1),
                      -deltaC[t]^2*eta*gamma^2*kappaC*omegaA*1*(alphaTc-1)^2*(omegaB-1),
                      alphaTc*deltaC[t]^2*gamma^2*kappaC*1*(alphaTc-1)*(omegaB-1),
                      deltaC[t]^2*gamma^2*kappaC*1*omegaA*(alphaTc-1)^2*(eta-1)*(omegaB-1),0,0,0,
                      alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(omegaA-1),
                      -alphaTc*deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1),
                      alphaTc^2*deltaC[t]^2*gamma^2*1,
                      alphaTc*deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)*(eta-1),0,0,0,
                      -deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1)^2*(omegaA-1),
                      deltaC[t]^2*eta*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2,
                      -alphaTc*deltaC[t]^2*gamma^2*omegaB*1*(alphaTc-1),
                      -deltaC[t]^2*gamma^2*omegaA*omegaB*1*(alphaTc-1)^2*(eta-1),0,0,0,
                      -deltaC[t]^2*1*(gamma*(alphaTc-1)*(gamma-1)*(omegaA-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      deltaC[t]^2*eta*gamma*omegaA*1*(alphaTc-1)*(gamma-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      -deltaC[t]^2*1*(gamma*omegaA*(alphaTc-1)*(eta-1)*(gamma-1)-(gamma*(alphaTc-1)*(gamma-1)*(kappaC-1)*(omegaB-1))/2),
                      0,-deltaC[t]^2*gamma*kappaC*1*(alphaTc-1)*(gamma-1)*(omegaB-1),-alphaTc*deltaC[t]^2*gamma*1*(gamma-1),
                      deltaC[t]^2*gamma*omegaB*1*(alphaTc-1)*(gamma-1),deltaC[t]^2*1*(gamma-1)^2,
                      -(deltaC[t]^2*gamma^2*1*(alphaTc-1)^2*(kappaC-1)*(omegaA-1)*(omegaB-1))/2,
                      (deltaC[t]^2*eta*gamma^2*omegaA*1*(alphaTc-1)^2*(kappaC-1)*(omegaB-1))/2,
                      -(alphaTc*deltaC[t]^2*gamma^2*1*(alphaTc-1)*(kappaC-1)*(omegaB-1))/2,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2,0,
                      -(deltaC[t]^2*gamma^2*omegaA*1*(alphaTc-1)^2*(eta-1)*(kappaC-1)*(omegaB-1))/2)
  po.init[14,1:72,t] <- c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
    }

##### Likelihoods ##
  for (i in 1:n_ind) { # loop over each individual
    # estimated probabilities of initial states are the proportions in each state at
    # first capture occasion
    z[i,First[i]] ~ dcat(px0[1:n.states])
    y[i,First[i]] ~ dcat(po.init[z[i,First[i]],1:n.obs, First[i]]) 

    for (t in (First[i]+1):nyears.ch) {
      ## State Process ##
      # draw states at t given states at t-1
      z[i,t] ~ dcat(state_probs[i,t-1,1:n.states])

      ## Observation Process ##
      # draw observations at t given states at t
      y[i,t] ~ dcat(event_probs[i,t,1:n.obs])

    state_probs[i,t-1,1:n.states] <- getSTATE(z = z[i,t-1],
                                      phiB = phiB[t-1], phiN = phiN[t-1], phiC = phiC[t-1],
                                      phiY = phiY[t-1], psiB = psiB[t-1], psiN = psiN)

    event_probs[i,t,1:n.obs] <- getOBS(z = z[i,t],
                                    pN = pN[t-1], pBc = pBc[t-1], pBn = pBn[t-1], 
                                    deltaY = deltaY[t], deltaC = deltaC[t], 
                                    eta = eta, gamma = gamma, alphaTc = alphaTc,
                                    alphaTy = alphaTy,
                                    omegaB = omegaB, omegaA = omegaA,
                                    kappaC = kappaC, kappaY = kappaY)
    } #t
  } #i
  
}) #mod

```

```{r run covariate models}

nim.data <- list(N_mu = mu, N_tau = tau, stableAge = stableAge, 
                  eff = c(effort$Land_Vessel_sc[1:13]), #numeric scaled
                 
                 #for main text model
                 sst_goa = sst_goa,
                 all_fish = all_fish,
                 
                 #for appendix models
                 # chinook = chinook_inRiv_tot$abun_scale[2:14], #no lag
                 # chinook = c(scale(esc_sp_cnt$Chinook)), #counts
                 # chinook = c(scale(esc_sp_sd$Chinook)), #sd's
                 # chinook = c(scale(esc_jul$Chinook)), #monthly chinook
                 # chinook = c(scale(esc_aug$Chinook)), #monthly chinook
                 # all_fish = c(scale(esc_jul$Total)), #monthly total
                 # all_fish = c(scale(esc_aug$Total)), #monthly total
                 # sock = c(scale(esc_sp_cnt$Sockeye)), #counts
                 # sock = c(scale(esc_sp_sd$Sockeye)), #sd's
                 # coho = c(scale(esc_sp_cnt$Coho)), #counts
                 # coho = c(scale(esc_sp_sd$Coho)), #sd's
                 # pink = c(scale(esc_sp_cnt$Pink)), #counts
                 # pink = c(scale(esc_sp_sd$Pink)), #sd's
                 # prod = prod, up = up, PDO = PDO, NPGO = NPGO,
                 # anch_pop = c(scale(othr_covs$Anch_pop_size)),
                 # murres = c(scale(othr_covs$Murre_f)),
                 # kitti = c(scale(othr_covs$Kitti_f)),
                 # osmer = c(scale(othr_covs$osmerid_byc)),
                 # eul_by = c(scale(othr_covs$eul_byc)),
                 y = as.matrix(CH_data))

nim.constants <- list(nyears.ch = nyears.ch, G = G, fec.age = fec.age, First = e,
                  grp.years = grp.years,
                  nyears.gap = nyears.gap,
                  n.states = n.states, n.obs = n.obs, n_ind = n_ind)

## Initial values
inits <- list(mu.phiB = 0.95, mu.phiC = 0.6, mu.phiY = 0.90, mu.psiB = 0.25, 
              mu.phiN = 0.92, psiN = runif(1,0.005, 0.1),
              mu.deltaY = 0.5, mu.deltaC = 0.5, mu.pN = 0.5, mu.pBn = 0.7, mu.pBc = 0.7,
              alphaTc = 0.06, alphaTy = 0.5, omegaA = 0.96, omegaB = 0.6, 
              kappaC = 0.63, kappaY = 0.98,
              gamma = 0.94, eta = 0.03, 
              b.sst_goa.b = 0, b.sst_goa.y = 0, b.sst_goa.c = 0, b.sst_goa.psi = 0,
              b.all_fish.b = 0, b.all_fish.c = 0, b.all_fish.y = 0, b.all_fish.psi = 0,
              eps.phiB = c(rep(0, nyears.ch-1)), eps.phiC = c(rep(0, nyears.ch-1)),
              eps.phiY = c(rep(0, nyears.ch-1)), eps.psiB = c(rep(0, nyears.ch-1)),
              eps.phiN = c(rep(0, nyears.ch-1)),
              eps.pBn = c(rep(0, nyears.ch-1)), eps.pN = c(rep(0, nyears.ch-1)),
              eps.pBc = c(rep(0, nyears.ch-1)),
              eps.deltaY = c(rep(0,nyears.ch)), eps.deltaC = c(rep(0,nyears.ch)),
              z = as.matrix(alive.function()))

params <- c('gamma', 'eta', 'alphaTy', 'alphaTc', 'kappaC', 'kappaY', 'omegaA', 'omegaB',
            'sigma.psiB', 'sigma.phiB', 'sigma.phiY', 'sigma.phiC',
            'sigma.pN', 'sigma.pBc', 'sigma.pBn', 'sigma.deltaY', 'sigma.deltaC',
            'eps.psiB', 'eps.phiB', 'eps.phiN', 'eps.phiY', 'eps.phiC',
            'eps.pN', 'eps.pBc', 'eps.pBn', 'eps.deltaY', 'eps.deltaC',
            'l.phiB', 'l.phiN', 'l.psiB', 'l.phiC', 'l.phiY', 
            'l.pN', 'l.pBc', 'l.pBn', 'l.deltaC', 'l.deltaY',
            'mu.psiB', 'mu.phiB', 'mu.phiN', 'mu.phiC', 'mu.phiY', 
            'mu.pN', 'mu.pBc', 'mu.pBn', 'mu.deltaC', 'mu.deltaY',
            'phiB.prob', 'phiN.prob', 'phiY.prob', 'phiC.prob', 'psiB.prob',
            'phiY.true.prob', 'phiC.true.prob',
            'pN.prob', 'pBc.prob', 'pBn.prob', 'deltaC.prob', 'deltaY.prob',
            'l.phiC.corr', 'phiC.corr.prob', 'b.eff', 
            'deltaY', 'deltaC', 'pi', 'pN', 'pBc', 'pBn', 'psiN', #ME model
            'b.sst_goa.b', 'b.sst_goa.y', 'b.sst_goa.c', 'b.sst_goa.psi',
            's.sst_goa.b', 's.sst_goa.y', 's.sst_goa.c', 's.sst_goa.psi',
            'b.all_fish.b', 'b.all_fish.c', 'b.all_fish.y', 'b.all_fish.psi',
            's.all_fish.b', 's.all_fish.c', 's.all_fish.y', 's.all_fish.psi',
            'p_grp',  'N_obs', 'N_mu',  #count model
             'pop_init', 'Ntot', 'N')  #pop model

# run model
n.iter = 40000; n.chains = 3; n.burnin = 20000; nthin = 1; nAdapt = 10

Rmodel <- nimbleModel(code = CIBW_mod, 
                      constants = nim.constants, data = nim.data, 
                      calculate = F, check = F, inits = inits)

conf <- configureMCMC(Rmodel, monitors = params, control = list(adaptInterval = nAdapt),
                      thin = nthin, useConjugacy = FALSE, enableWAIC = TRUE)

Rmcmc <- buildMCMC(conf)
Cmodel <- compileNimble(Rmodel) #builds dag
Cmcmc <- compileNimble(Rmcmc, project = Rmodel)

out <- runMCMC(Cmcmc, niter = n.iter, nburnin = n.burnin, nchains = n.chains, inits = inits,
                 setSeed = FALSE, progressBar = TRUE,
               WAIC = TRUE, samplesAsCodaMCMC = TRUE)

saveRDS(out, here::here('results', 'nimble', paste0('out_sst_all_fish.rds')))

```

### Results

```{r posterior density plots}

out <- readRDS(file = here::here('results', 'out_null.rds'))


##psiB
ecolPsiB <- ggplot(data.frame(fec = out$sims.list$mu.psiB), aes(fec)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(fec)),
             linetype = 'dotted', show.legend = F) +
  xlab('psiB') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])
 
##phiB
ecolPhiB <- ggplot(data.frame(phiB = out$sims.list$mu.phiB), aes(phiB)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(phiB)),
             linetype = 'dotted', show.legend = F) +
  xlab('phiB') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

##phiN
ecolPhiN <- ggplot(data.frame(phiN = out$sims.list$mu.phiN), aes(phiN)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(phiN)),
             linetype = 'dotted', show.legend = F) +
  xlab('phiN') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])
 
##phiC
ecolPhiC <- ggplot(data.frame(phiC = out$sims.list$mu.phiC), aes(phiC)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(phiC)),
             linetype = 'dotted', show.legend = F) +
  xlab('phiC') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

##phiY
ecolPhiY <- ggplot(data.frame(phiY = out$sims.list$mu.phiY), aes(phiY)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(phiY)),
             linetype = 'dotted', show.legend = F) +
  xlab('phiY') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])
 
##psiN
ecolPsiN <- ggplot(data.frame(psiN = out$sims.list$psiN), aes(psiN)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(psiN)),
             linetype = 'dotted', show.legend = F) +
  xlab('psiN') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

ecolPhiCoffset <- ggplot(data.frame(corrC = out$sims.list$phiC.corr.prob), aes(corrC)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(corrC)),
             linetype = 'dotted', show.legend = F) +
  xlab('phiC.corr') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

#obs params
obspBn <- ggplot(data.frame(pBn = out$sims.list$mu.pBn), aes(pBn)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(pBn)),
             linetype = 'dotted', show.legend = F) +
  xlab('pBn') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obspBc <- ggplot(data.frame(pBc = out$sims.list$mu.pBc), aes(pBc)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(pBc)),
             linetype = 'dotted', show.legend = F) +
  xlab('pBc') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obspN <- ggplot(data.frame(pN = out$sims.list$mu.pN), aes(pN)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(pN)),
             linetype = 'dotted', show.legend = F) +
  xlab('pN') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsDeltaY <- ggplot(data.frame(delta = out$sims.list$mu.deltaY), aes(delta)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(delta)),
             linetype = 'dotted', show.legend = F) +
  xlab('delta') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsDeltaC <- ggplot(data.frame(delta = out$sims.list$mu.deltaC), aes(delta)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(delta)),
             linetype = 'dotted', show.legend = F) +
  xlab('delta') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsEff <- ggplot(data.frame(b.eff = out$sims.list$b.eff), aes(b.eff)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(b.eff)),
             linetype = 'dotted', show.legend = F) +
  xlab('b.eff') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsAlphaTy <- ggplot(data.frame(alphaTy = out$sims.list$alphaTy), aes(alphaTy)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(alphaTy)),
             linetype = 'dotted', show.legend = F) +
  xlab('alphaTy') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsAlphaTc <- ggplot(data.frame(alphaTc = out$sims.list$alphaTc), aes(alphaTc)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(alphaTc)),
             linetype = 'dotted', show.legend = F) +
  xlab('alphaTc') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsGamma <- ggplot(data.frame(gamma = out$sims.list$gamma), aes(gamma)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(gamma)),
             linetype = 'dotted', show.legend = F) +
  xlab('gamma') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsOmegaA <- ggplot(data.frame(omegaA = out$sims.list$omegaA), aes(omegaA)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(omegaA)),
             linetype = 'dotted', show.legend = F) +
  xlab('omegaA') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsOmegaB <- ggplot(data.frame(omegaB = out$sims.list$omegaB), aes(omegaB)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(omegaB)),
             linetype = 'dotted', show.legend = F) +
  xlab('omegaB') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsKappaY <- ggplot(data.frame(kappaY = out$sims.list$kappaY), aes(kappaY)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(kappaY)),
             linetype = 'dotted', show.legend = F) +
  xlab('kappaY') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsKappaC <- ggplot(data.frame(kappaC = out$sims.list$kappaC), aes(kappaC)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(kappaC)),
             linetype = 'dotted', show.legend = F) +
  xlab('kappaC') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

obsEta <- ggplot(data.frame(eta = out$sims.list$eta), aes(eta)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(eta)),
             linetype = 'dotted', show.legend = F) +
  xlab('eta') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

# #sigmas
sigma1 <- ggplot(data.frame(sigmaB = out$sims.list$sigma.phiB), aes(sigmaB)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(sigmaB)),
             linetype = 'dotted', show.legend = F) +
  xlab('sigma.phiB') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

sigma2 <- ggplot(data.frame(sigmaC = out$sims.list$sigma.phiC), aes(sigmaC)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(sigmaC)),
             linetype = 'dotted', show.legend = F) +
  xlab('sigma.phiC') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

sigma3 <- ggplot(data.frame(sigmaY = out$sims.list$sigma.phiY), aes(sigmaY)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(sigmaY)),
             linetype = 'dotted', show.legend = F) +
  xlab('sigma.phiY') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

sigma4 <- ggplot(data.frame(sigmaPsiB = out$sims.list$sigma.psiB), aes(sigmaPsiB)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(sigmaPsiB)),
             linetype = 'dotted', show.legend = F) +
  xlab('sigmaPsiB') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

#taus
tau1 <- ggplot(data.frame(tau.psiB = out$sims.list$tau.psiB), aes(tau.psiB)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(tau.psiB)),
             linetype = 'dotted', show.legend = F) +
  xlab('tau.psiB') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

tau2 <- ggplot(data.frame(tau.phiA = out$sims.list$tau.phiA), aes(tau.phiA)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(tau.phiA)),
             linetype = 'dotted', show.legend = F) +
  xlab('tau.phiA') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

tau3 <- ggplot(data.frame(tau.phiC = out$sims.list$tau.phiC), aes(tau.phiC)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(tau.phiC)),
             linetype = 'dotted', show.legend = F) +
  xlab('tau.phiC') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

tau4 <- ggplot(data.frame(tau.phiY = out$sims.list$tau.phiY), aes(tau.phiY)) +
  geom_line(stat = 'density') +
  geom_vline(data = NULL, aes(xintercept = mean(tau.phiY)),
             linetype = 'dotted', show.legend = F) +
  xlab('tau.phiY') + ylab('Density') +
  plot_theme(legend.title = element_blank(),
             plot.title = element_text(size = 10)) +
  scale_color_manual(values = rainbow2[-c(2,4)])

plot_grid(ecolPhiB, ecolPhiN, ecolPhiC, ecolPhiY, ecolPsiB, ecolPsiN)
plot_grid(obsEta, obsGamma, obsKappaC, obsKappaY, obsOmegaB, obsOmegaA, obsAlphaTc, obsAlphaTy)
plog_grid(obspN, obspBc, obspBn, obsDeltaC, obsDeltaY, obsEff)
plot_grid(sigma1, sigma2, sigma3, sigma4, tau1, tau2, tau3, tau4)

```

```{r multiplicative projections}

proj <- 150
# proj <- 100
nSims <- 500
fec.age <- 10

out <- readRDS(here::here('results', 'jags', 'out_RE.rds'))

#length of mcmc chain
# 40000-30000 burnin x 3 chains, thin = 2 == 15000 samples
nSamples <- dim(out$sims.list$N)[1]

#storage for sim loop
Ntot_sim <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj, nSims))
p.ext.yr.mean.sim <- p.ext.yr.upper.sim <- p.ext.yr.lower.sim <- array(NA, dim = c(nSims, nyears.ch+nyears.gap+proj))
p.ext.sim <- p.ad.ext.sim <- p.qe.end.sim <- p.qe.ever.sim <- p.neg.sim <- 
  p.down.50.sim <- p.down.100.sim <- numeric(nSims)
lambda.mean.sim <- lambda.upper.sim <- lambda.lower.sim <- numeric(nSims)
qe.size.sim <- end.size.sim <- array(NA, dim = c(nSims, 3))

for (sim in 1:nSims) {

    i <- fec.age
    G <- fec.age+3 #total age groups

    N <- out$sims.list$N #age-specific population during data period; samples of 15 yrs of data for 13 age groups
    N_proj <- array(NA, dim = c(nSamples, proj, G))
    
    #temp storage for population model objects; need row for each of nSamples and col for each proj year
    A.NB <- A.Byoy <- A.BSk <- array(NA, dim = c(nSamples, proj)) 
    Anew.NB <- Aplus.NB <- array(NA, dim = c(nSamples, proj))
    Aplus.Byoy.NB <- Aplus.Byoy.Sk <- Anew.Byoy <- array(NA, dim = c(nSamples, proj))
    A.Byoy.age <- A.BSk.stay <- array(NA, dim = c(nSamples, proj))
    
    #total population size for data period + projections (Ntot) and just projections (Ntot_proj)
    Ntot <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj)) #add 1 for 2004
    Ntot_proj <- array(NA, dim = c(nSamples, proj))
    
    #demographic rates
    phiN.prob.proj <- phiB.prob.proj <- phiC.prob.proj <- array(NA, dim = c(nSamples, proj-1))
    psiB.prob.proj <- phiY.prob.proj <- array(NA, dim = c(nSamples, proj-1))

    #grab last year from data period to initialize
    N_proj[,1,] <- N[,dim(N)[2],] #set up space for age-specific population projections, populate with last year from data period
    A.NB[,1] <- N[,dim(N)[2],i+1]
    A.Byoy[,1] <- N[,dim(N)[2],i+2]
    A.BSk[,1] <- N[,dim(N)[2],i+3]
    
    Ntot[,1:(nyears.ch+nyears.gap)] <- out$sims.list$Ntot[,1:(dim(N)[2]-1)] #fills up to Ntot[,14]
    Ntot_proj[,1] <- out$sims.list$Ntot[,(dim(N)[2])] #grab 15th year

   ## projection; sigma == sd, sigma^2 == variance, 1/variance == precision
    for (t in 1:(proj-1)) {
      #use deviates (for every mcmc sample row, sample one of the twelve t "columns");
      pick.year <- sample(1:12, 1)
      phiB.prob.proj[,t] <- out$sims.list$phiB.prob[,pick.year]
      phiN.prob.proj[,t] <- out$sims.list$phiN.prob[,pick.year]
      phiC.prob.proj[,t] <- out$sims.list$phiC.true.prob[,pick.year] #"true" indicating it has been multiplied by phiB
      phiY.prob.proj[,t] <- out$sims.list$phiY.true.prob[,pick.year]
      psiB.prob.proj[,t] <- out$sims.list$psiB.prob[,pick.year]

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###
     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiN.prob.proj[,t]*(1-out$mean$psiN))
     Aplus.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiN.prob.proj[,t]*(1-out$mean$psiN))
     A.NB[,t+1] <- Anew.NB[,t+1] + Aplus.NB[,t+1]

     ## B.yoy group (from fec.age-1, NB plus, Sk)
     Anew.Byoy[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiB.prob.proj[,t]*(out$mean$psiN))
     Aplus.Byoy.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiB.prob.proj[,t]*(out$mean$psiN))
     Aplus.Byoy.Sk[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(psiB.prob.proj[,t]))
     A.Byoy[,t+1] <- Aplus.Byoy.NB[,t+1] + Anew.Byoy[,t+1] + Aplus.Byoy.Sk[,t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(1-psiB.prob.proj[,t]))
     A.Byoy.age[,t+1] <- rbinom(nSamples, A.Byoy[,t], phiB.prob.proj[,t])
     A.BSk[,t+1] <- A.Byoy.age[,t+1] + A.BSk.stay[,t+1]

      ### YOTY/CALVES ###
     # N_proj[,t+1,1] <- N_proj[,t+1,G-1]  #YOY
     N_proj[,t+1,1] <- A.Byoy[,t+1]  #YOY
     N_proj[,t+1,2] <- rbinom(nSamples, N_proj[,t,1], phiY.prob.proj[,t]) #1yo calf
     N_proj[,t+1,3] <- rbinom(nSamples, N_proj[,t,2], phiY.prob.proj[,t]) #2yo calf

    for (a in 4:6) { #calves age 3-5
     N_proj[,t+1,a] <- rbinom(nSamples, N_proj[,t,a-1], phiC.prob.proj[,t])
     } #a

     # # ### PB and MALES ###
     for (aa in 7:i) { #new 6-8 year olds
     N_proj[,t+1,aa] <- rbinom(nSamples, N_proj[,t,aa-1], phiN.prob.proj[,t])
     } #aa

     #return to the N_proj[t,age] matrix and fill in groups
     N_proj[,t+1,i+1] <- A.NB[,t+1] #all 9+ NB
     N_proj[,t+1,i+2] <- A.Byoy[,t+1] #all 9+ Byoy
     N_proj[,t+1,i+3] <- A.BSk[,t+1] #all 9+ skip breeders

     #Ntot
     Ntot_proj[,t+1] = rowSums(N_proj[1:nSamples,t+1,1:G])
    } #t pop mod

#fill space in Ntot with Ntot_proj projection years, essentially bind_cols()
Ntot[,((nyears.ch+nyears.gap+1):(nyears.ch+nyears.gap+proj))] <- Ntot_proj[,]

###### summarize objects over mcmc samples

#growth rate over the whole study period
lambda.yr.mean <- lambda.yr.lower <- lambda.yr.upper <- numeric(length = length(2:(nyears.ch+nyears.gap+proj)))

p.ext.yr.mean <- p.ext.yr.lower <- p.ext.yr.upper <- numeric(length = length(2:(nyears.ch+nyears.gap+proj)))

for (t in 2:(nyears.ch+nyears.gap+proj)) {
  #mean and quantiles per year across mcmc samples; leave na.rm for zero size pops in mcmc samples
  lambda.yr.mean[t] <- mean(Ntot[,t]/(Ntot[,t-1]), na.rm = T) 
  lambda.yr.lower[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.025, na.rm = T, names = F) 
  lambda.yr.upper[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.975, na.rm = T, names = F) 
  
  p.ext.yr.mean[t] <- mean(Ntot[,t]<2)


} #t lambda

#### derive and store values for each simulation

p.ext.yr.mean.sim[sim,] <- p.ext.yr.mean

#geometric mean, and quantile
lambda.mean.sim[sim] <- exp(mean(log(lambda.yr.mean[which(lambda.yr.mean>0)])))
lambda.lower.sim[sim] <- exp(mean(log(lambda.yr.lower[which(lambda.yr.lower>0)])))
lambda.upper.sim[sim] <- exp(mean(log(lambda.yr.upper[which(lambda.yr.upper>0)])))

#prob of having less than 2 individuals and less than 1 breeding age female at end
p.ext.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)]<2)
p.ad.ext.sim[sim] <- mean(N_proj[,proj,c((i+2):(i+3))]<1)

#probability of population being below qe individuals at the end year or ever
p.qe.end.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)]<50)
p.qe.ever.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]<50)>1)

#prob of reaching downlist criteria (520) at any point in 1:50 or 1:95 years
p.down.100.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]>520)>1)
p.down.50.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+50)]>520)>1)

#probability that have fewer individuals at end than start
p.neg.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)] < Ntot[,1])

#population size at end of projection
end.size.sim[sim,1:3] <- quantile(Ntot[,(nyears.gap+nyears.ch+proj)], 
                                probs = c(0.025, 0.5, 0.975), names = F)

#Ntot
Ntot_sim[1:nSamples,,sim] <- as.matrix(Ntot)

} #sim iter

## save objects
# saveRDS(p.ext.yr.mean.sim, file = here::here('results', 'Projections', 'p.ext.yr.sim.rds'))
# saveRDS(Ntot_sim, file = here::here('results', 'Projections',  'Ntot.sim.rds'))
# saveRDS(p.ext.sim, file = here::here('results', 'Projections', 'p.ext.sim.rds'))
# saveRDS(p.ad.ext.sim, file = here::here('results', 'Projections', 'p.ad.ext.sim.rds'))
# saveRDS(p.qe.end.sim, file = here::here('results', 'Projections', 'p.qe.end.sim.rds'))
# saveRDS(p.qe.ever.sim, file = here::here('results', 'Projections', 'p.qe.ever.sim.rds'))
# saveRDS(p.neg.sim, file = here::here('results', 'Projections', 'p.neg.sim.rds'))
# saveRDS(p.down.50.sim, file = here::here('results', 'Projections', 'p.down.50.sim.rds'))
# saveRDS(p.down.100.sim, file = here::here('results', 'Projections', 'p.down.100.sim.rds'))
# saveRDS(lambda.mean.sim, file = here::here('results', 'Projections', 'lambda.mean.sim.rds'))
# saveRDS(lambda.upper.sim, file = here::here('results', 'Projections', 'lambda.upper.sim.rds'))
# saveRDS(lambda.lower.sim, file = here::here('results', 'Projections', 'lambda.lower.sim.rds'))

## summarizing Ntot [1:nSamples, 1:nyears+proj, 1:nSims]
# length(apply(Ntot_sim, 2, mean)) #a single annual mean (parametric uncertainty + environmental stochasticity)
# dim(apply(Ntot_sim, c(3,2), mean)) #means across mcmc samples (environmental stochasticity)
# dim(apply(Ntot_sim, c(1,2), mean)) #means across simulation samples (parametric uncertainty)

Ntot_mean <- apply(Ntot_sim, c(3,2), median) 
Ntot_q2.5 <- apply(Ntot_sim, c(3,2), function(x) quantile(x,0.025))
Ntot_q97.5 <- apply(Ntot_sim, c(3,2), function(x) quantile(x,0.975))

#Ntot figures
#all projections for each simulation of the whole mcmc chain
N_mean_long_sim <- Ntot_mean %>%
  melt(value.name = 'mean') %>%
  dplyr::rename(sim = Var1, year = Var2) 

N_low_long_sim <- Ntot_q2.5 %>%
  melt(value.name = 'lower') %>%
  dplyr::rename(sim = Var1, year = Var2) 

N_high_long_sim <- Ntot_q97.5 %>%
  melt(value.name = 'upper') %>%
  dplyr::rename(sim = Var1, year = Var2) 

N_vals_sim <- N_mean_long_sim %>%
  merge(N_low_long_sim, by = c('sim', 'year')) %>%
  merge(N_high_long_sim, by = c('sim', 'year')) %>%
  arrange(sim, year) 

CIs <- N_vals_sim %>% group_by(year) %>%
  dplyr::summarize(lower_mean = mean(lower), upper_mean = mean(upper)) 

N_vals_sim <- N_vals_sim %>% merge(CIs, by = 'year')

#Ntot; shows individual trajectories for each simulation
ggplot(N_vals_sim,
       aes(year, mean, group = sim, col = sim)) +
  geom_line() +
    geom_ribbon(data = N_vals_sim %>% filter(sim == 1), aes(x = year, ymin = lower_mean, ymax = upper_mean),
              size = 0.2, alpha = 0.1, linetype = 'dotted', show.legend = F) +
  xlab('') + ylab('Population size') +
  # facet_wrap(~mod) +
  plot_theme(legend.position = 'none') +
    scale_x_continuous(limits = c(1,nyears.ch+nyears.gap+proj),
                     breaks = seq(2, nyears.ch+nyears.gap+proj, by = 10),
                     labels = seq(2005, (2005+nyears.ch+nyears.gap+proj), by = 10))

## summarizing over both sim and mcmc sample
Ntot_mean <- apply(Ntot_sim, c(2), median) 
Ntot_q2.5 <- apply(Ntot_sim, c(2), function(x) quantile(x,0.025))
Ntot_q97.5 <- apply(Ntot_sim, c(2), function(x) quantile(x,0.975))

N_vals_mean <- data.frame(year = 1:(nyears.ch+nyears.gap+proj),
                          mean = Ntot_mean, lower = Ntot_q2.5, upper = Ntot_q97.5)

ggplot(N_vals_mean, aes(year, mean)) +
  geom_line() +
  geom_ribbon(aes(x = year, ymin = lower, ymax = upper),
              size = 0.2, alpha = 0.1, linetype = 'dotted', show.legend = F) +
  xlab('') + ylab('Population size') +
  plot_theme(legend.position = 'top') +
    scale_x_continuous(limits = c(1,nyears.ch+nyears.gap+proj),
                     breaks = seq(2, nyears.ch+nyears.gap+proj, by = 10),
                     labels = seq(2005, (2005+nyears.ch+nyears.gap+proj), by = 10)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = '')

#p.ext yr
p.ext.yr.mean <- apply(p.ext.yr.mean.sim, c(2), median) 
p.ext.yr.lower <- apply(p.ext.yr.mean.sim, c(2), function(x) quantile(x,0.025))
p.ext.yr.upper <- apply(p.ext.yr.mean.sim, c(2), function(x) quantile(x,0.975))

p.ext.yr <- data.frame(year = 1:(nyears.ch+nyears.gap+proj),
                          mean = p.ext.yr.mean, lower = p.ext.yr.lower, 
                       upper = p.ext.yr.upper)

ggplot(p.ext.yr, aes(year, mean)) +
  geom_line() +
  geom_ribbon(aes(x = year, ymin = lower, ymax = upper),
              size = 0.2, alpha = 0.1, linetype = 'dotted', show.legend = F) +
  xlab('') + ylab('Extinction probability') +
  plot_theme(legend.position = 'top') +
    scale_x_continuous(limits = c(1,nyears.ch+nyears.gap+proj),
                     breaks = seq(2, nyears.ch+nyears.gap+proj, by = 10),
                     labels = seq(2005, (2005+nyears.ch+nyears.gap+proj), by = 10)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = '')

```

```{r multiplicative projections - dem sensitivity, eval = T}

# proj <- 94
proj <- 150
nSims <- 100

scenarios_a <- c(0, 0.01, 0.015, 0.02)
scenarios_y <- c(0, 0.01, 0.02, 0.04)
scenarios_c <- c(0, 0.05, 0.1, 0.15)
scenarios_psi <- c(0, 0.05, 0.1, 0.15)

#mod storage
Ntot.mod <- lambda.mod <- data.frame() #5 and 4 columns, respectively
p.ext.mod <- p.ext.100.mod <- p.ad.ext.mod <- p.neg.mod <-  p.down.50.mod <- p.down.100.mod <- p.qe.mod <- p.de.50.mod <- p.de.100.mod <- data.frame() #2 columns

for (sc_a in scenarios_a) {
  for (sc_y in scenarios_y) {
    for (sc_c in scenarios_c) {
      for (sc_psi in scenarios_psi) {

  f <- 10
  out <- readRDS(here::here('results', 'jags', 'out_RE.rds'))

  nSamples <- dim(out$sims.list$N)[1]

#storage for sim loop
Ntot_sim <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj, nSims))
p.ext.sim <- p.ext.100.sim <- p.ad.ext.sim <- p.qe.end.sim <- p.qe.ever.sim <- p.neg.sim <- 
  p.down.50.sim <- p.de.50.sim <- p.down.100.sim <- p.de.100.sim <-numeric(nSims)
lambda.mean.sim <- lambda.upper.sim <- lambda.lower.sim <- numeric(nSims)
end.size.sim <- array(NA, dim = c(nSims, 3))

for (sim in 1:nSims) {
  
  i <- f
  G <- i+3 #total age groups
  
  N <- out$sims.list$N #age-specific population during data period; 6000 samples of 15 yrs of data for 13 age groups
  N_proj <- array(NA, dim = c(nSamples, proj, G))
  
  #temp storage for population model objects; need a row for each of nSamples and columns for each projection year
  A.NB <- A.Byoy <- A.BSk <- array(NA, dim = c(nSamples, proj)) 
  Anew.NB <- Aplus.NB <- array(NA, dim = c(nSamples, proj))
  Aplus.Byoy.NB <- Aplus.Byoy.Sk <- Anew.Byoy <- array(NA, dim = c(nSamples, proj))
  A.Byoy.age <- A.BSk.stay <- array(NA, dim = c(nSamples, proj))
  
  #total population size for data period + projections (Ntot) and just projections (Ntot_proj)
  Ntot <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj)) #add 1 for 2004
  Ntot_proj <- array(NA, dim = c(nSamples, proj))
  
  #demographic rates
  phiN.prob.proj <- phiB.prob.proj <- phiC.prob.proj <- array(NA, dim = c(nSamples, proj-1))
  psiB.prob.proj <- phiY.prob.proj <- array(NA, dim = c(nSamples, proj-1))
  
  #grab last year from data period to initialize
  N_proj[,1,] <- N[,dim(N)[2],] #set up space for age-specific population projections, populate with last year from data period
  A.NB[,1] <- N[,dim(N)[2],i+1]
  A.Byoy[,1] <- N[,dim(N)[2],i+2]
  A.BSk[,1] <- N[,dim(N)[2],i+3]
  
  Ntot[,1:(nyears.ch+nyears.gap)] <- out$sims.list$Ntot[,1:(dim(N)[2]-1)] #fills up to Ntot[,14]
  Ntot_proj[,1] <- out$sims.list$Ntot[,(dim(N)[2])] #grab 15th year
    Ntot_proj[,1] <- out$sims.list$Ntot[,(dim(N)[2])] #check not repeating a year here

   ## projection; sigma == sd, sigma^2 == variance, 1/variance == precision
    for (t in 1:(proj-1)) {
      pick.year <- sample(1:12,1)

      phiB.prob.proj[,t] <- out$sims.list$phiB.prob[,pick.year] + out$sims.list$phiB.prob[,pick.year]*sc_a
      phiN.prob.proj[,t] <- out$sims.list$phiN.prob[,pick.year] + out$sims.list$phiN.prob[,pick.year]*sc_a
      phiC.prob.proj[,t] <- out$sims.list$phiC.true.prob[,pick.year] + out$sims.list$phiC.true.prob[,pick.year]*sc_c
      phiY.prob.proj[,t] <- out$sims.list$phiY.true.prob[,pick.year] + out$sims.list$phiY.true.prob[,pick.year]*sc_y
      psiB.prob.proj[,t] <- out$sims.list$psiB.prob[,pick.year] + out$sims.list$psiB.prob[,pick.year]*sc_psi

      phiB.prob.proj[which(phiB.prob.proj[,t]>1),t] <- 0.99
      phiN.prob.proj[which(phiN.prob.proj[,t]>1),t] <- 0.99
      phiC.prob.proj[which(phiC.prob.proj[,t]>1),t] <- 0.99
      phiY.prob.proj[which(phiY.prob.proj[,t]>1),t] <- 0.99
      psiB.prob.proj[which(psiB.prob.proj[,t]>0.46),t] <- 0.45

    ### PLUS GROUP, contains B.yoy, B.Sk, NB ###
    ## NB group (from fec.age-1 and NB plus group)
    Anew.NB[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiN.prob.proj[,t]*(1-out$mean$psiN))
    Aplus.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiN.prob.proj[,t]*(1-out$mean$psiN))
    A.NB[,t+1] <- Anew.NB[,t+1] + Aplus.NB[,t+1]
    
    ## B.yoy group (from fec.age-1, NB plus, Sk)
    Anew.Byoy[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiB.prob.proj[,t]*(out$mean$psiN))
    Aplus.Byoy.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiB.prob.proj[,t]*(out$mean$psiN))
    Aplus.Byoy.Sk[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(psiB.prob.proj[,t]))
    A.Byoy[,t+1] <- Aplus.Byoy.NB[,t+1] + Anew.Byoy[,t+1] + Aplus.Byoy.Sk[,t+1]
    
    ## B.Sk (from aging B.yoy and repeat skipping)
    A.BSk.stay[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(1-psiB.prob.proj[,t]))
    A.Byoy.age[,t+1] <- rbinom(nSamples, A.Byoy[,t], phiB.prob.proj[,t])
    A.BSk[,t+1] <- A.Byoy.age[,t+1] + A.BSk.stay[,t+1]
    
    ### YOTY/CALVES ###
    # N_proj[,t+1,1] <- N_proj[,t+1,G-1]  #YOY
    N_proj[,t+1,1] <- A.Byoy[,t+1]  #YOY
    N_proj[,t+1,2] <- rbinom(nSamples, N_proj[,t,1], phiY.prob.proj[,t]) #1yo calf
    N_proj[,t+1,3] <- rbinom(nSamples, N_proj[,t,2], phiY.prob.proj[,t]) #2yo calf
    
    for (a in 4:6) { #calves age 3-5
      N_proj[,t+1,a] <- rbinom(nSamples, N_proj[,t,a-1], phiC.prob.proj[,t])
    } #a
    
    # # ### PB and MALES ###
    for (aa in 7:i) { #new 6-8 year olds
      N_proj[,t+1,aa] <- rbinom(nSamples, N_proj[,t,aa-1], phiN.prob.proj[,t])
    } #aa
    
    #return to the N_proj[t,age] matrix and fill in groups
    N_proj[,t+1,i+1] <- A.NB[,t+1] #all 9+ NB
    N_proj[,t+1,i+2] <- A.Byoy[,t+1] #all 9+ Byoy
    N_proj[,t+1,i+3] <- A.BSk[,t+1] #all 9+ skip breeders
    
    #Ntot
    Ntot_proj[,t+1] = rowSums(N_proj[1:nSamples,t+1,1:G])
    
    for (y in 1:nSamples) {
        if (Ntot_proj[y, t+1] > 1300) # length is 1 
          {Ntot_proj[y, t+1] <- 1300}
        } #y
    
  } #t pop mod
  
  #fill space in Ntot with Ntot_proj projection years, essentially bind_cols()
  Ntot[,((nyears.ch+nyears.gap+1):(nyears.ch+nyears.gap+proj))] <- Ntot_proj[,]
  
  ###### summarize objects over mcmc samples
  
  #growth rate over the whole study period
  lambda.yr.mean <- lambda.yr.lower <- lambda.yr.upper <- numeric(length = length(2:(nyears.ch+nyears.gap+proj)))
  for (t in 2:(nyears.ch+nyears.gap+proj)) {
    #mean and quantiles per year across mcmc samples; leave na.rm for zero size pops in mcmc samples
    lambda.yr.mean[t] <- mean(Ntot[,t]/(Ntot[,t-1]), na.rm = T) 
    lambda.yr.lower[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.025, na.rm = T, names = F) 
    lambda.yr.upper[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.975, na.rm = T, names = F) 
  } #t lambda
  
  #### derive and store values for each simulation
  
  #geometric mean, and quantiles
  lambda.mean.sim[sim] <- exp(mean(log(lambda.yr.mean[which(lambda.yr.mean>0)])))
  lambda.lower.sim[sim] <- exp(mean(log(lambda.yr.lower[which(lambda.yr.lower>0)])))
  lambda.upper.sim[sim] <- exp(mean(log(lambda.yr.upper[which(lambda.yr.upper>0)])))
  
  #prob of having less than 2 individuals and less than 1 breeding age female at end
  p.ext.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)]<2)
  p.ext.100.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+100)]<2)
  p.ad.ext.sim[sim] <- mean(N_proj[,proj,c((i+2):(i+3))]<1)
  
  #probability of population being below qe individuals at the end year or ever
  # p.qe.ever.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]<10)>1) #any time
  p.qe.ever.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)]<28) #end
  
  #prob of reaching downlist criteria (520) at any point in 1:50 or 1:95 years
  p.de.50.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+50)]>780)>1)
  p.down.50.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+50)]>520)>1)
  p.de.100.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]>780)>1)
  p.down.100.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]>520)>1)
  
  #probability that have fewer individuals at end than start
  p.neg.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)] < Ntot[,1])
  
  #population size at end of projection
  end.size.sim[sim,1:3] <- quantile(Ntot[,(nyears.gap+nyears.ch+proj)], 
                                    probs = c(0.025, 0.5, 0.975), names = F)
  
  #Ntot
  Ntot_sim[1:nSamples,,sim] <- as.matrix(Ntot)
  
} #sim iter

## summarizing over both sim and mcmc sample
Ntot_mean <- apply(Ntot_sim, c(2), mean)  #median) 
Ntot_q2.5 <- apply(Ntot_sim, c(2), function(x) quantile(x,0.025))
Ntot_q97.5 <- apply(Ntot_sim, c(2), function(x) quantile(x,0.975))

Ntot.sim <- data.frame(year = 1:(nyears.ch+nyears.gap+proj),
                          mean = Ntot_mean, 
                          lower = Ntot_q2.5, 
                          upper = Ntot_q97.5) %>%
  transform(scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi)

lambda.sim <- data.frame(lambda.mean = lambda.mean.sim,
                         lambda.lower = lambda.lower.sim,
                         lambda.upper = lambda.upper.sim,
                         scenario_a = sc_a, scenario_c = sc_c,
                         scenario_y = sc_y, scenario_psi = sc_psi) 

p.neg.sim <- data.frame(value = p.neg.sim, var = 'p.neg', 
                        scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi) 
p.ad.ext.sim <- data.frame(value = p.ad.ext.sim, var = 'p.ad.ext', 
                           scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi) 
p.ext.sim <- data.frame(value = p.ext.sim, var = 'p.ext', 
                        scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi) 
p.ext.100.sim <- data.frame(value = p.ext.100.sim, var = 'p.ext.100', 
                        scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi) 
p.down.50.sim <- data.frame(value = p.down.50.sim, var = 'p.down.50', 
                         scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi) 
p.down.100.sim <- data.frame(value = p.down.100.sim, var = 'p.down.100', 
                         scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi) 
p.de.50.sim <- data.frame(value = p.de.50.sim, var = 'p.de.50', 
                         scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi)
p.de.100.sim <- data.frame(value = p.de.100.sim, var = 'p.de.100', 
                         scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi)
p.qe.sim <- data.frame(value = p.qe.ever.sim, var = 'p.qe', 
                         scenario_a = sc_a, scenario_c = sc_c,
            scenario_y = sc_y, scenario_psi = sc_psi) 

#bind new and old
Ntot.mod <- bind_rows(Ntot.sim, Ntot.mod)
lambda.mod <- bind_rows(lambda.sim, lambda.mod)
p.neg.mod <- bind_rows(p.neg.sim, p.neg.mod)
p.ext.100.mod <- bind_rows(p.ext.100.sim, p.ext.100.mod)
p.ext.mod <- bind_rows(p.ext.sim, p.ext.mod)
p.ad.ext.mod <- bind_rows(p.ad.ext.sim, p.ad.ext.mod)
p.down.50.mod <- bind_rows(p.down.50.sim, p.down.50.mod)
p.de.50.mod <- bind_rows(p.de.50.sim, p.de.50.mod)
p.down.100.mod <- bind_rows(p.down.100.sim, p.down.100.mod)
p.de.100.mod <- bind_rows(p.de.100.sim, p.de.100.mod)
p.qe.mod <- bind_rows(p.qe.sim, p.qe.mod)
    } #sc_psi
  } #sc_y
  } #sc_c
} #sc_a

proj.summary <- bind_rows(p.neg.mod, p.ext.mod, p.ext.100.mod, p.ad.ext.mod, p.down.50.mod, 
                          p.qe.mod, p.de.50.mod, p.down.100.mod, p.de.100.mod)

saveRDS(Ntot.mod, file = here::here('results', 'Projections',  
                                    'Demographic scenarios', 'Ntot.mod.rds'))
saveRDS(lambda.mod, file = here::here('results', 'Projections',
                                      'Demographic scenarios', 'lambda.mod.rds'))
saveRDS(proj.summary, file = here::here('results', 'Projections', 
                                        'Demographic scenarios', 'proj.summary.rds'))


write.csv(prob_tab_all, file = here::here(file = 'results', 'Projections',
                                          'Demographic scenarios', 'probs_all_2168.csv'), row.names = F)

#### figures
Ntot.mod <- Ntot.mod %>%
  transform(scenario_a = factor(as.character(scenario_a),
                                levels = scenarios_a)) %>%
  transform(scenario_y = factor(as.character(scenario_y),
                                 levels = scenarios_y)) %>%
  transform(scenario_c = factor(as.character(scenario_c),
                                 levels = scenarios_c)) %>%
  transform(scenario_psi = factor(as.character(scenario_psi), levels = scenarios_psi))

lambda.mod <- lambda.mod %>%
  transform(scenario_a = factor(as.character(scenario_a),
                                levels = scenarios_a)) %>%
  transform(scenario_y = factor(as.character(scenario_y),
                                 levels = scenarios_y)) %>%
  transform(scenario_c = factor(as.character(scenario_c),
                                 levels = scenarios_c)) %>%
  transform(scenario_psi = factor(as.character(scenario_psi), levels = scenarios_psi))

proj.summary <- proj.summary %>%
  transform(scenario_a = factor(as.character(scenario_a),
                                levels = scenarios_a)) %>%
  transform(scenario_y = factor(as.character(scenario_y),
                                 levels = scenarios_y)) %>%
  transform(scenario_c = factor(as.character(scenario_c),
                                 levels = scenarios_c)) %>%
  transform(scenario_psi = factor(as.character(scenario_psi), levels = scenarios_psi))

##Ntot; mean across sims and mcmc samples
# #changes across adult phi
ggplot(Ntot.mod %>% filter(scenario_psi == 0 & scenario_y == 0 & scenario_c == 0),
       aes(year, mean, col = scenario_a, group = scenario_a)) +
  geom_line() +
  geom_ribbon(aes(x = year, ymin = lower, ymax = upper),
              size = 0.2, alpha = 0.1, linetype = 'dotted', show.legend = F) +
  xlab('') + ylab('Population size') +
  # facet_grid(scenario_a + scenario_y ~ scenario_psi) +
  plot_theme(legend.position = 'top') +
    scale_x_continuous(limits = c(1,nyears.ch+nyears.gap+proj),
                     breaks = seq(2, nyears.ch+nyears.gap+proj, by = 10),
                     labels = seq(2005, (2005+nyears.ch+nyears.gap+proj), by = 10)) +
  # scale_color_manual(values = rainbow2[-c(1,4)], name = 'Scenario')
  scale_color_manual(values = rainbow2, name = 'Scenario') +
  guides(color=guide_legend("Change in adult survival", nrow = 1))

#changes across calf phi
ggplot(Ntot.mod %>% filter(scenario_psi == 0 & scenario_a == 0 & scenario_c == 0),
       aes(year, mean, col = scenario_y, group = scenario_y)) +
  geom_line() +
  geom_ribbon(aes(x = year, ymin = lower, ymax = upper),
              size = 0.2, alpha = 0.1, linetype = 'dotted', show.legend = F) +
  xlab('') + ylab('Population size') +
  # facet_grid(scenario_a + scenario_y ~ scenario_psi) +
  plot_theme(legend.position = 'top') +
    scale_x_continuous(limits = c(1,nyears.ch+nyears.gap+proj),
                     breaks = seq(2, nyears.ch+nyears.gap+proj, by = 10),
                     labels = seq(2005, (2005+nyears.ch+nyears.gap+proj), by = 10)) +
  # scale_color_manual(values = rainbow2[-c(1,4)], name = 'Scenario')
  scale_color_manual(values = rainbow2, name = 'Scenario') +
  guides(color=guide_legend("Change in YOY survival", nrow = 1))

ggplot(Ntot.mod %>% filter(scenario_psi == 0 & scenario_a == 0 & scenario_y == 0),
       aes(year, mean, col = scenario_c, group = scenario_c)) +
  geom_line() +
  geom_ribbon(aes(x = year, ymin = lower, ymax = upper),
              size = 0.2, alpha = 0.1, linetype = 'dotted', show.legend = F) +
  xlab('') + ylab('Population size') +
  # facet_grid(scenario_a + scenario_y ~ scenario_psi) +
  plot_theme(legend.position = 'top') +
    scale_x_continuous(limits = c(1,nyears.ch+nyears.gap+proj),
                     breaks = seq(2, nyears.ch+nyears.gap+proj, by = 10),
                     labels = seq(2005, (2005+nyears.ch+nyears.gap+proj), by = 10)) +
  # scale_color_manual(values = rainbow2[-c(1,4)], name = 'Scenario')
  scale_color_manual(values = rainbow2, name = 'Scenario') +
  guides(color=guide_legend("Change in calf survival", nrow = 1))

#changes across psi
ggplot(Ntot.mod %>% filter(scenario_a == 0 & scenario_y == 0 & scenario_c == 0),
       aes(year, mean, col = scenario_psi, group = scenario_psi)) +
  geom_line() +
  geom_ribbon(aes(x = year, ymin = lower, ymax = upper),
              size = 0.2, alpha = 0.1, linetype = 'dotted', show.legend = F) +
  xlab('') + ylab('Population size') +
  # facet_grid(scenario_a + scenario_y ~ scenario_psi) +
  plot_theme(legend.position = 'top') +
    scale_x_continuous(limits = c(1,nyears.ch+nyears.gap+proj),
                     breaks = seq(2, nyears.ch+nyears.gap+proj, by = 10),
                     labels = seq(2005, (2005+nyears.ch+nyears.gap+proj), by = 10)) +
  # scale_color_manual(values = rainbow2[-c(1,4)], name = 'Scenario')
  scale_color_manual(values = rainbow2, name = 'Scenario') +
  guides(color=guide_legend("Change in fecundity", nrow = 1))

#lambda
ggplot(lambda.mod, aes(y = lambda.mean, x = factor(scenario_a), 
                       group = factor(scenario_a), color = factor(scenario_a))) +
  geom_boxplot(width = 0.5) +
  xlab('Adult survival') + ylab('Mean population growth rate') +
  facet_grid(scenario_psi ~ scenario_y, labeller = label_both, scales = 'free_y') +
  plot_theme(legend.position = 'none',
             panel.border = element_rect(fill = NA)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = '')

#projection summaries
## all vars, adult survival and fecundity
ggplot(proj.summary, aes(y = value, x = factor(scenario_a), 
                         color = factor(scenario_a), group = factor(scenario_a))) +
  geom_boxplot(width = 0.5) +
  xlab('Adult survival') + ylab('Probability') +
  facet_grid(var~scenario_psi, scales = 'free_y', labeller = label_both) +
  plot_theme(legend.position = 'none',
             panel.border = element_rect(fill = NA)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = '')

#all rates by summary state
ggplot(proj.summary %>% filter(var == 'p.ad.ext'), 
       aes(y = value, x = factor(scenario_a), 
                         color = factor(scenario_a), group = factor(scenario_a))) +
  geom_boxplot(width = 0.5) +
  xlab('Adult survival') + ylab('Probability') +
  facet_grid(scenario_c~scenario_psi, scales = 'free_y', labeller = label_both) +
  plot_theme(legend.position = 'none',
             panel.border = element_rect(fill = NA)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = '')

```


```{r covariate coefficients, eval = F}

fec.age <- 10

#### mean/CI's
season <- c('yr')
vars <- c('all_fish', 'sst_goa')
age_grp <- c('b', 'c', 'y', 'psi')

betas <- betas_all <- data.frame()
for (s in season) {

out <- readRDS(here::here('results', 'out_sst_all_fish.rds'))

    for (g in age_grp) {
    temp <- matrix(c(
      t(data.frame(eval(parse(text = paste0('out$mean$b.', v, '.', g))))),
                     t(eval(parse(text = paste0('out$q97.5$b.', v, '.', g)))),
                     t(eval(parse(text = paste0('out$q2.5$b.', v, '.', g)))),
                       v_name, g, s),
                      nrow = 1, ncol = 6)
    colnames(temp) <- c('mean', 'upper','lower', 'covariate', 'rate', 'season')
    betas <- rbind(betas, temp)
    }
  }
  betas_all <- rbind(betas, betas_all)
}

betas_vals <- betas_all %>%
  reshape2::melt(id.vars = c('covariate', 'rate', 'season')) %>%
  transform(value = as.numeric(value)) %>%
  distinct() %>%
  reshape2::dcast(covariate + rate + season ~ variable, value.var = 'value') %>%
  transform(rate = factor(rate, levels = c('b', 'c', 'y', 'psi'),
                          labels = c('Adult survival', 'Calf survival', 'YOY survival', 'Fecundity')))

ggplot(betas_vals, 
       aes(rate, mean, group = season, col = season)) +
  geom_point(position = position_dodge(0.5)) +
  geom_linerange(aes(ymin = lower, ymax = upper), position = position_dodge(0.5)) +
  geom_hline(aes(yintercept = 0), linetype = 'dotted') +
  # facet_wrap(~covariate, scales = 'free_y') +
    facet_wrap(~covariate) +
  xlab('') + ylab('Covariate effect (logit scale)') +
  theme_bw() + theme_classic() +
  scale_color_manual(values = rainbow2[-c(1,4)])

#prob betas greater/equal to zero

post_sum <- beta_probs <- posts <- data.frame()
age <- c('.b', '.c', '.y', '.psi')
env_vars <- c('all_fish', 'sst_goa')

cov_vars <- numeric()
for (e in env_vars) {
  for (a in age) {
    temp <- paste0('b.', e, a)
    cov_vars <- c(cov_vars, temp)
  }
}

#for appendix
# for (s in season) {
# 
# out <- readRDS(here::here('results', 'Appendices', 'Covariates', 
#                     paste0('out_med_B(1,1)_exp(1)T(0.2,)_yr_age10_sst_all_fish.rds')))
# 
# for (v in env_vars) {
# posts_temp <- data.frame(b = eval(parse(text = paste0('out$sims.list$b.', v, '.b'))),
#                          c = eval(parse(text = paste0('out$sims.list$b.', v, '.c'))),
#                          y = eval(parse(text = paste0('out$sims.list$b.', v, '.y'))),
#                          psi = eval(parse(text = paste0('out$sims.list$b.', v, '.psi')))) %>%
#   transform(var = v)
# 
# post_sum_temp <- data.frame(
#             med = apply(posts_temp[,1:4], 2, function(x) quantile(x, probs = 0.50, na.rm = T, names = F)),
#             lower = apply(posts_temp[,1:4], 2, function(x) quantile(x, probs = 0.025, na.rm = T, names = F)),
#             upper = apply(posts_temp[,1:4], 2, function(x) quantile(x, probs = 0.975, na.rm = T, names = F))) %>%
#   transform(Season = s) %>%
#   transform(direction = ifelse(med>0, 'positive', 'negative'))
# post_sum_temp$age <- row.names(post_sum_temp)
# post_sum_temp$cov <- v
# 
# posts <- bind_rows(posts_temp, posts)
# post_sum <- bind_rows(post_sum_temp, post_sum)
# 
#   } #v
# } #season
# 
# #melt long and merge with summary stat 'direction'
# posts_long <- posts %>%
#   reshape2::melt() %>%
#   dplyr::rename(cov = var, age = variable) %>%
#   merge(post_sum %>% select(cov, age, direction), by = c('cov', 'age'))
# 
# beta_probs <- data.frame()
# temp_probs <- data.frame(cov = NA, prob = NA)
# for (v in env_vars) {
#   for (a in age_grp) {
#   temp <- posts_long %>% filter(cov == v & age == a)
#   if (sum(temp$direction == 'negative')>0) {
#     prob = -sum(temp$value < 0)/dim(temp)[1]
#   } else { prob = sum(temp$value > 0)/dim(temp)[1] }
#   temp_probs$cov = v
#   temp_probs$age = a
#   temp_probs$prob = prob
#   beta_probs <- bind_rows(beta_probs, temp_probs)
#   }
# }
# 
# cov_post_sum <- post_sum %>%
#   merge(beta_probs, by = c('age', 'cov'))
# 
# write.csv(cov_post_sum, file = here::here('results', 'cov_post_sum.csv'), row.names = F)

```


#### Additional comparisons and projections for appendices

```{r developing a quasi-extinction level}

proj <- 250
nSims <- 100
fec.age <- 10

out <- readRDS(here::here('results', 'jags', 'out_RE.rds'))

#length of mcmc chain
nSamples <- dim(out$sims.list$N)[1]

#storage for sim loop
Ntot_sim <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj, nSims))
p.ext.yr.mean.sim <- p.ext.yr.upper.sim <- p.ext.yr.lower.sim <- array(NA, dim = c(nSims, nyears.ch+nyears.gap+proj))
p.ext.sim <- p.ad.ext.sim <- p.qe.end.sim <- p.qe.ever.sim <- p.neg.sim <- 
  p.down.50.sim <- p.down.100.sim <- numeric(nSims)
lambda.mean.sim <- lambda.upper.sim <- lambda.lower.sim <- numeric(nSims)
qe.size.sim <- end.size.sim <- array(NA, dim = c(nSims, 3))

for (sim in 1:nSims) {

# lambda.mean <- lambda.upper <- lambda.upper <- numeric()

    i <- fec.age
    G <- fec.age+3 #total age groups

    N <- out$sims.list$N #age-specific population during data period; 6000 samples of 15 yrs of data for 13 age groups
    N_proj <- array(NA, dim = c(nSamples, proj, G))
    
    #temp storage for population model objects; need row for each of nSamples and col for each proj year
    A.NB <- A.Byoy <- A.BSk <- array(NA, dim = c(nSamples, proj)) 
    Anew.NB <- Aplus.NB <- array(NA, dim = c(nSamples, proj))
    Aplus.Byoy.NB <- Aplus.Byoy.Sk <- Anew.Byoy <- array(NA, dim = c(nSamples, proj))
    A.Byoy.age <- A.BSk.stay <- array(NA, dim = c(nSamples, proj))
    
    #total population size for data period + projections (Ntot) and just projections (Ntot_proj)
    Ntot <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj)) #add 1 for 2004
    Ntot_proj <- array(NA, dim = c(nSamples, proj))
    
    #demographic rates
    phiN.prob.proj <- phiB.prob.proj <- phiC.prob.proj <- array(NA, dim = c(nSamples, proj-1))
    psiB.prob.proj <- phiY.prob.proj <- array(NA, dim = c(nSamples, proj-1))

    #grab last year from data period to initialize
    N_proj[,1,] <- N[,dim(N)[2],] #set up space for age-specific population projections, populate with last year from data period
    A.NB[,1] <- N[,dim(N)[2],i+1]
    A.Byoy[,1] <- N[,dim(N)[2],i+2]
    A.BSk[,1] <- N[,dim(N)[2],i+3]
    
    Ntot[,1:(nyears.ch+nyears.gap)] <- out$sims.list$Ntot[,1:(dim(N)[2]-1)] #fills up to Ntot[,14]
    Ntot_proj[,1] <- out$sims.list$Ntot[,(dim(N)[2])] #grab 15th year

   ## projection; sigma == sd, sigma^2 == variance, 1/variance == precision
    for (t in 1:(proj-1)) {
      #use deviates (for every mcmc sample row, sample one of the twelve t "columns");
      pick.year <- sample(1:12, 1)
      phiB.prob.proj[,t] <- out$sims.list$phiB.prob[,pick.year]
      phiN.prob.proj[,t] <- out$sims.list$phiN.prob[,pick.year]
      phiC.prob.proj[,t] <- out$sims.list$phiC.true.prob[,pick.year] #"true" indicating it has been multiplied by phiB
      phiY.prob.proj[,t] <- out$sims.list$phiY.true.prob[,pick.year]
      psiB.prob.proj[,t] <- out$sims.list$psiB.prob[,pick.year]

     ### PLUS GROUP, contains B.yoy, B.Sk, NB ###
     ## NB group (from fec.age-1 and NB plus group)
     Anew.NB[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiN.prob.proj[,t]*(1-out$mean$psiN))
     Aplus.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiN.prob.proj[,t]*(1-out$mean$psiN))
     A.NB[,t+1] <- Anew.NB[,t+1] + Aplus.NB[,t+1]

     ## B.yoy group (from fec.age-1, NB plus, Sk)
     Anew.Byoy[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiB.prob.proj[,t]*(out$mean$psiN))
     Aplus.Byoy.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiB.prob.proj[,t]*(out$mean$psiN))
     Aplus.Byoy.Sk[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(psiB.prob.proj[,t]))
     A.Byoy[,t+1] <- Aplus.Byoy.NB[,t+1] + Anew.Byoy[,t+1] + Aplus.Byoy.Sk[,t+1]

     ## B.Sk (from aging B.yoy and repeat skipping)
     A.BSk.stay[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(1-psiB.prob.proj[,t]))
     A.Byoy.age[,t+1] <- rbinom(nSamples, A.Byoy[,t], phiB.prob.proj[,t])
     A.BSk[,t+1] <- A.Byoy.age[,t+1] + A.BSk.stay[,t+1]

      ### YOTY/CALVES ###
     # N_proj[,t+1,1] <- N_proj[,t+1,G-1]  #YOY
     N_proj[,t+1,1] <- A.Byoy[,t+1]  #YOY
     N_proj[,t+1,2] <- rbinom(nSamples, N_proj[,t,1], phiY.prob.proj[,t]) #1yo calf
     N_proj[,t+1,3] <- rbinom(nSamples, N_proj[,t,2], phiY.prob.proj[,t]) #2yo calf

    for (a in 4:6) { #calves age 3-5
     N_proj[,t+1,a] <- rbinom(nSamples, N_proj[,t,a-1], phiC.prob.proj[,t])
     } #a

     # # ### PB and MALES ###
     for (aa in 7:i) { #new 6-8 year olds
     N_proj[,t+1,aa] <- rbinom(nSamples, N_proj[,t,aa-1], phiN.prob.proj[,t])
     } #aa

     #return to the N_proj[t,age] matrix and fill in groups
     N_proj[,t+1,i+1] <- A.NB[,t+1] #all 9+ NB
     N_proj[,t+1,i+2] <- A.Byoy[,t+1] #all 9+ Byoy
     N_proj[,t+1,i+3] <- A.BSk[,t+1] #all 9+ skip breeders

     #Ntot
     Ntot_proj[,t+1] = rowSums(N_proj[1:nSamples,t+1,1:G])
    } #t pop mod

#fill space in Ntot with Ntot_proj projection years, essentially bind_cols()
Ntot[,((nyears.ch+nyears.gap+1):(nyears.ch+nyears.gap+proj))] <- Ntot_proj[,]

###### summarize objects over mcmc samples

#growth rate over the whole study period
lambda.yr.mean <- lambda.yr.lower <- lambda.yr.upper <- numeric(length = length(2:(nyears.ch+nyears.gap+proj)))

p.ext.yr.mean <- p.ext.yr.lower <- p.ext.yr.upper <- numeric(length = length(2:(nyears.ch+nyears.gap+proj)))

for (t in 2:(nyears.ch+nyears.gap+proj)) {
  #mean and quantiles per year across mcmc samples; leave na.rm for zero size pops in mcmc samples
  lambda.yr.mean[t] <- mean(Ntot[,t]/(Ntot[,t-1]), na.rm = T) 
  lambda.yr.lower[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.025, na.rm = T, names = F) 
  lambda.yr.upper[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.975, na.rm = T, names = F) 
  
  p.ext.yr.mean[t] <- mean(Ntot[,t]<2)


} #t lambda

#### derive and store values for each simulation

p.ext.yr.mean.sim[sim,] <- p.ext.yr.mean

#geometric mean, and quantiles
lambda.mean.sim[sim] <- exp(mean(log(lambda.yr.mean[which(lambda.yr.mean>0)])))
lambda.lower.sim[sim] <- exp(mean(log(lambda.yr.lower[which(lambda.yr.lower>0)])))
lambda.upper.sim[sim] <- exp(mean(log(lambda.yr.upper[which(lambda.yr.upper>0)])))

#prob of having less than 2 individuals and less than 1 breeding age female at end
p.ext.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)]<2)
p.ad.ext.sim[sim] <- mean(N_proj[,proj,c((i+2):(i+3))]<1)

#probability of population being below qe individuals at the end year or ever
p.qe.end.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)]<50)
p.qe.ever.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]<50)>1)

#prob of reaching downlist criteria (520) at any point in 1:50 or 1:95 years
p.down.100.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]>520)>1)
p.down.50.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+50)]>520)>1)

#probability that have fewer individuals at end than start
p.neg.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)] < Ntot[,1])

#population size at end of projection
end.size.sim[sim,1:3] <- quantile(Ntot[,(nyears.gap+nyears.ch+proj)], 
                                probs = c(0.025, 0.5, 0.975), names = F)

#Ntot
Ntot_sim[1:nSamples,,sim] <- as.matrix(Ntot)

} #sim iter

###search over a sequence of population sizes for rows where Ntot was n at t_proj == 10
#for those rows where it reached that size by year 10, what proportion of 1:nSims went ext at end
ext.size <- data.frame()
for (n in (20:300)) {
      for (i in 1:nSamples) {
  if (sum(Ntot_sim[i,nyears.gap+nyears.ch+50,] == n)>1)
      {
  ext.size.temp <- data.frame(sample = i, size = n, 
                              p = mean(Ntot_sim[i,nyears.gap+nyears.ch+proj,]<2))
  } #if
      ext.size <- bind_rows(ext.size, ext.size.temp)
  } #i
} #n

#then find the mean p.ext per pop size and hone in on pop size where p.ext is 50%, 75%, 95%, etc
qe.size <- ext.size %>%
  group_by(size) %>%
  dplyr::summarize(prob = round(median(p),3), 
                   lower = round(quantile(p, probs = 0.025, names = F),3), 
                   upper = round(quantile(p, probs = 0.975, names = F),3))

# 25 in 100: 95% NA; 50% 50-62; 25% 100-105
# 25 in 150: 95% 29-35 individuals; 50% 150-160; 25% 250
# 25 in 200: 95% 85-100; 50% 250-255; 25% NA
# 75 in 150: 95% NA; 50% 40-45; 25% 95-105
# 75 in 200: 95% NA; 50% 120; 25% 160-180 variable
# 75 in 250: 95% 34-40; 50% 165-175; 25% 250-280 variable 

# saveRDS(ext.size, here::here('results', 'Appendices', 'qe', 'ext.size.75.250yr.rds'))

#make figure
qe.dat <- readRDS(file = here::here('results', 'Appendices', 'qe', 'qe.size.75.250yr.rds'))

qe.vals <- qe.dat %>%
  transform(bin = ifelse(prob > 0.9, '>90%', 
                  ifelse(prob <= 0.9 & prob > 0.8, '80-90%',
                  ifelse(prob <= 0.8 & prob > 0.7, '70-80%',
                  ifelse(prob <= 0.7 & prob > 0.6, '60-70%',
                  ifelse(prob <= 0.6 & prob > 0.5, '50-60%',
                  ifelse(prob <= 0.5 & prob > 0.4, '40-50%',
                  ifelse(prob <= 0.4 & prob > 0.3, '30-40%',
                  ifelse(prob <= 0.3 & prob > 0.2, '20-30%',
                  ifelse(prob <= 0.2 & prob > 0.1, '10-20%', '0-10%')))))))))) %>%
  transform(bin = factor(bin, levels = c('>90%', '80-90%',
              '70-80%', '60-70%', '50-60%', '40-50%', '30-40%', '20-30%', '10-20%', '0-10%')))

ggplot(qe.vals, aes(x = size, y = prob, col = bin)) +
  geom_point() + scale_x_reverse(breaks = c(300, 250, 200, 150, 100, 50)) +
  xlab('Population size at 50 years') +
  ylab('Extinction probability at 250 years') +
  plot_theme(legend.position = 'top') +
  scale_color_brewer(palette = 'RdYlBu', name = '')

ggplot(qe.vals, aes(x = size, y = prob, col = bin)) +
  geom_linerange(aes(ymin = lower, ymax = upper), col = 'lightgrey', alpha = 0.9) + geom_point() + 
  scale_x_reverse(breaks = c(300, 250, 200, 150, 100, 50)) +
  xlab('Population size at 50 years') +
  ylab('Extinction probability at 250 years') +
  plot_theme(legend.position = 'top') +
  scale_color_brewer(palette = 'RdYlBu', name = '')


```

```{r AFR, eval = T}

#must save and load individual model output for all AFR ages, or available by request from first author

proj <- 150
nSims <- 100
mods <- c(8, 10, 12, 14, 16)

#mod storage
Ntot.mod <- lambda.mod <- data.frame() #5 and 4 columns, respectively
p.ext.mod <- p.ad.ext.mod <- p.neg.mod <-  p.down.mod <- data.frame() #just two columns

for (m in mods) {
out <- readRDS(here::here('results', 'Appendices', 'AFR',
                        paste0('out_med_B(1,1)_exp(1)T(0.2,)_null_age', m, '.rds')))
nSamples <- dim(out$sims.list$N)[1]

#storage for sim loop
Ntot_sim <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj, nSims))
p.ext.sim <- p.ad.ext.sim <- p.qe.end.sim <- p.qe.ever.sim <- p.neg.sim <- 
  p.down.50.sim <- p.down.100.sim <- numeric(nSims)
lambda.mean.sim <- lambda.upper.sim <- lambda.lower.sim <- numeric(nSims)
end.size.sim <- array(NA, dim = c(nSims, 3))

for (sim in 1:nSims) {
  
  i <- m
  G <- i+3 #total age groups
  
  N <- out$sims.list$N #age-specific population during data period; 6000 samples of 15 yrs of data for 13 age groups
  N_proj <- array(NA, dim = c(nSamples, proj, G))
  
  #temp storage for population model objects; need a row for each of nSamples and columns for each projection year
  A.NB <- A.Byoy <- A.BSk <- array(NA, dim = c(nSamples, proj)) 
  Anew.NB <- Aplus.NB <- array(NA, dim = c(nSamples, proj))
  Aplus.Byoy.NB <- Aplus.Byoy.Sk <- Anew.Byoy <- array(NA, dim = c(nSamples, proj))
  A.Byoy.age <- A.BSk.stay <- array(NA, dim = c(nSamples, proj))
  
  #total population size for data period + projections (Ntot) and just projections (Ntot_proj)
  Ntot <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj)) #add 1 for 2004
  Ntot_proj <- array(NA, dim = c(nSamples, proj))
  
  #demographic rates
  phiN.prob.proj <- phiB.prob.proj <- phiC.prob.proj <- array(NA, dim = c(nSamples, proj-1))
  psiB.prob.proj <- phiY.prob.proj <- array(NA, dim = c(nSamples, proj-1))
  
  #grab last year from data period to initialize
  N_proj[,1,] <- N[,dim(N)[2],] #set up space for age-specific population projections, populate with last year from data period
  A.NB[,1] <- N[,dim(N)[2],i+1]
  A.Byoy[,1] <- N[,dim(N)[2],i+2]
  A.BSk[,1] <- N[,dim(N)[2],i+3]
  
  Ntot[,1:(nyears.ch+nyears.gap)] <- out$sims.list$Ntot[,1:(dim(N)[2]-1)] #fills up to Ntot[,14]
  Ntot_proj[,1] <- out$sims.list$Ntot[,(dim(N)[2])] #grab 15th year
  
  ## projection; sigma == sd, sigma^2 == variance, 1/variance == precision
  for (t in 1:(proj-1)) {
    #use deviates (for every mcmc sample row, sample one of the twelve t "columns");
    pick.year <- sample(1:12, 1)
    phiB.prob.proj[,t] <- out$sims.list$phiB.prob[,pick.year]
    phiN.prob.proj[,t] <- out$sims.list$phiN.prob[,pick.year]
    phiC.prob.proj[,t] <- out$sims.list$phiC.true.prob[,pick.year] #"true" indicating it has been multiplied by phiB
    phiY.prob.proj[,t] <- out$sims.list$phiY.true.prob[,pick.year]
    psiB.prob.proj[,t] <- out$sims.list$psiB.prob[,pick.year]
    
    ### PLUS GROUP, contains B.yoy, B.Sk, NB ###
    ## NB group (from fec.age-1 and NB plus group)
    Anew.NB[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiN.prob.proj[,t]*(1-out$mean$psiN))
    Aplus.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiN.prob.proj[,t]*(1-out$mean$psiN))
    A.NB[,t+1] <- Anew.NB[,t+1] + Aplus.NB[,t+1]
    
    ## B.yoy group (from fec.age-1, NB plus, Sk)
    Anew.Byoy[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiB.prob.proj[,t]*(out$mean$psiN))
    Aplus.Byoy.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiB.prob.proj[,t]*(out$mean$psiN))
    Aplus.Byoy.Sk[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(psiB.prob.proj[,t]))
    A.Byoy[,t+1] <- Aplus.Byoy.NB[,t+1] + Anew.Byoy[,t+1] + Aplus.Byoy.Sk[,t+1]
    
    ## B.Sk (from aging B.yoy and repeat skipping)
    A.BSk.stay[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(1-psiB.prob.proj[,t]))
    A.Byoy.age[,t+1] <- rbinom(nSamples, A.Byoy[,t], phiB.prob.proj[,t])
    A.BSk[,t+1] <- A.Byoy.age[,t+1] + A.BSk.stay[,t+1]
    
    ### YOTY/CALVES ###
    # N_proj[,t+1,1] <- N_proj[,t+1,G-1]  #YOY
    N_proj[,t+1,1] <- A.Byoy[,t+1]  #YOY
    N_proj[,t+1,2] <- rbinom(nSamples, N_proj[,t,1], phiY.prob.proj[,t]) #1yo calf
    N_proj[,t+1,3] <- rbinom(nSamples, N_proj[,t,2], phiY.prob.proj[,t]) #2yo calf
    
    for (a in 4:6) { #calves age 3-5
      N_proj[,t+1,a] <- rbinom(nSamples, N_proj[,t,a-1], phiC.prob.proj[,t])
    } #a
    
    # # ### PB and MALES ###
    for (aa in 7:i) { #new 6-8 year olds
      N_proj[,t+1,aa] <- rbinom(nSamples, N_proj[,t,aa-1], phiN.prob.proj[,t])
    } #aa
    
    #return to the N_proj[t,age] matrix and fill in groups
    N_proj[,t+1,i+1] <- A.NB[,t+1] #all 9+ NB
    N_proj[,t+1,i+2] <- A.Byoy[,t+1] #all 9+ Byoy
    N_proj[,t+1,i+3] <- A.BSk[,t+1] #all 9+ skip breeders
    
    #Ntot
    Ntot_proj[,t+1] = rowSums(N_proj[1:nSamples,t+1,1:G])
  } #t pop mod
  
  #fill space in Ntot with Ntot_proj projection years, essentially bind_cols()
  Ntot[,((nyears.ch+nyears.gap+1):(nyears.ch+nyears.gap+proj))] <- Ntot_proj[,]
  
  ###### summarize objects over mcmc samples
  
  #growth rate over the whole study period
  lambda.yr.mean <- lambda.yr.lower <- lambda.yr.upper <- numeric(length = length(2:(nyears.ch+nyears.gap+proj)))
  for (t in 2:(nyears.ch+nyears.gap+proj)) {
    #mean and quantiles per year across mcmc samples; leave na.rm for zero size pops in mcmc samples
    lambda.yr.mean[t] <- mean(Ntot[,t]/(Ntot[,t-1]), na.rm = T) 
    lambda.yr.lower[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.025, na.rm = T, names = F) 
    lambda.yr.upper[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.975, na.rm = T, names = F) 
  } #t lambda
  
  #### derive and store values for each simulation
  
  #geometric mean, and quantiles
  lambda.mean.sim[sim] <- exp(mean(log(lambda.yr.mean[which(lambda.yr.mean>0)])))
  lambda.lower.sim[sim] <- exp(mean(log(lambda.yr.lower[which(lambda.yr.lower>0)])))
  lambda.upper.sim[sim] <- exp(mean(log(lambda.yr.upper[which(lambda.yr.upper>0)])))
  
  #prob of having less than 2 individuals and less than 1 breeding age female at end
  p.ext.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)]<2)
  p.ad.ext.sim[sim] <- mean(N_proj[,proj,c((i+2):(i+3))]<1)
  
  #probability of population being below qe individuals at the end year or ever
  p.qe.ever.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]<50)>1)
  
  #prob of reaching downlist criteria (520) at any point in 1:50 or 1:95 years
  p.down.100.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]>520)>1)

  #probability that have fewer individuals at end than start
  p.neg.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)] < Ntot[,1])
  
  #population size at end of projection
  end.size.sim[sim,1:3] <- quantile(Ntot[,(nyears.gap+nyears.ch+proj)], 
                                    probs = c(0.025, 0.5, 0.975), names = F)
  
  #Ntot
  Ntot_sim[1:nSamples,,sim] <- as.matrix(Ntot)
  
} #sim iter

## summarizing over both sim and mcmc sample
Ntot_mean <- apply(Ntot_sim, c(2), median) 
Ntot_q2.5 <- apply(Ntot_sim, c(2), function(x) quantile(x,0.025))
Ntot_q97.5 <- apply(Ntot_sim, c(2), function(x) quantile(x,0.975))

Ntot.sim <- data.frame(year = 1:(nyears.ch+nyears.gap+proj),
                          mean = Ntot_mean, 
                          lower = Ntot_q2.5, 
                          upper = Ntot_q97.5) %>%
  transform(mod = m)

lambda.sim <- data.frame(lambda.mean = lambda.mean.sim,
                         lambda.lower = lambda.lower.sim,
                         lambda.upper = lambda.upper.sim,
                         mod = m) 

p.neg.sim <- data.frame(value = p.neg.sim, var = 'p.neg', mod = m) 
p.ad.ext.sim <- data.frame(value = p.ad.ext.sim, var = 'p.ad.ext', mod = m) 
p.ext.sim <- data.frame(value = p.ext.sim, var = 'p.ext', mod = m) 
p.down.sim <- data.frame(value = p.down.100.sim, var = 'p.down', mod = m) 

#bind new and old
Ntot.mod <- bind_rows(Ntot.sim, Ntot.mod)
lambda.mod <- bind_rows(lambda.sim, lambda.mod)
p.neg.mod <- bind_rows(p.neg.sim, p.neg.mod)
p.ext.mod <- bind_rows(p.ext.sim, p.ext.mod)
p.ad.ext.mod <- bind_rows(p.ad.ext.sim, p.ad.ext.mod)
p.down.mod <- bind_rows(p.down.sim, p.down.mod)

} #mod

proj.summary <- bind_rows(p.neg.mod, p.ext.mod, p.ad.ext.mod, p.down.mod)

saveRDS(Ntot.mod, file = here::here('results', 'Appendices', 'AFR', 'Ntot.mod.rds'))
saveRDS(lambda.mod, file = here::here('results', 'Appendices', 'AFR', 'lambda.mod.rds'))
saveRDS(proj.summary, file = here::here('results', 'Appendices', 'AFR', 'proj.summary.rds'))

## figures
#Ntot; mean across sims and prior
ggplot(Ntot.mod, aes(year, mean, color = factor(mod), group = factor(mod))) +
  geom_line() +
  geom_ribbon(aes(x = year, ymin = lower, ymax = upper),
              size = 0.2, alpha = 0.1, linetype = 'dotted', show.legend = F) +
  xlab('') + ylab('Population size') +
  plot_theme(legend.position = 'top') +
    scale_x_continuous(limits = c(1,nyears.ch+nyears.gap+proj),
                     breaks = seq(2, nyears.ch+nyears.gap+proj, by = 10),
                     labels = seq(2005, (2005+nyears.ch+nyears.gap+proj), by = 10)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = 'AFR')

#lambda
ggplot(lambda.mod, aes(y = lambda.mean, x = factor(mod), group = factor(mod), color = factor(mod))) +
  geom_boxplot(width = 0.5) +
  xlab('AFR') + ylab('Mean population growth rate') +
  plot_theme(legend.position = 'none',
             panel.border = element_rect(fill = NA)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = 'AFR')

#projection summaries
ggplot(proj.summary, aes(y = value, x = factor(mod), color = factor(mod), group = factor(mod))) +
  geom_boxplot(width = 0.5) +
  xlab('AFR') + ylab('Probability') +
  facet_wrap(~var, scales = 'free_y') +
  plot_theme(legend.position = 'none',
             panel.border = element_rect(fill = NA)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = 'AFR')

```

```{r pgrp prior and max med day, eval = T}

#must save and load individual model output for all combinations of data and pgrp prior model runs, or available by request from first author


f <- 10
proj <- 150
nSims <- 100
surv_type <- c('med', 'max')
mods <- c('B(1,1)', 'B(2,1)', 'B(10,3)', 'B(15,1)')

#mod storage
Ntot.mod <- lambda.mod <- data.frame() #5 and 4 columns, respectively
p.ext.mod <- p.ad.ext.mod <- p.neg.mod <-  p.down.mod <- data.frame() #just two columns

for (d in surv_type) {
for (m in mods) {
out <- readRDS(here::here('results', 'Appendices', 'pGrp Prior',
                        paste0('out_', d, '_', m, '_exp(1)T(0.2,)_null_age', 
                               f, '.rds')))
nSamples <- dim(out$sims.list$N)[1]

#storage for sim loop
Ntot_sim <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj, nSims))
p.ext.sim <- p.ad.ext.sim <- p.qe.end.sim <- p.qe.ever.sim <- p.neg.sim <- 
  p.down.50.sim <- p.down.100.sim <- numeric(nSims)
lambda.mean.sim <- lambda.upper.sim <- lambda.lower.sim <- numeric(nSims)
end.size.sim <- array(NA, dim = c(nSims, 3))

for (sim in 1:nSims) {
  
  i <- f
  G <- i+3 #total age groups
  
  N <- out$sims.list$N #age-specific population during data period; 6000 samples of 15 yrs of data for f+3 age groups
  N_proj <- array(NA, dim = c(nSamples, proj, G))
  
  #temp storage for population model objects; need a row for each of nSamples and columns for each projection year
  A.NB <- A.Byoy <- A.BSk <- array(NA, dim = c(nSamples, proj)) 
  Anew.NB <- Aplus.NB <- array(NA, dim = c(nSamples, proj))
  Aplus.Byoy.NB <- Aplus.Byoy.Sk <- Anew.Byoy <- array(NA, dim = c(nSamples, proj))
  A.Byoy.age <- A.BSk.stay <- array(NA, dim = c(nSamples, proj))
  
  #total population size for data period + projections (Ntot) and just projections (Ntot_proj)
  Ntot <- array(NA, dim = c(nSamples, nyears.ch+nyears.gap+proj)) #add 1 for 2004
  Ntot_proj <- array(NA, dim = c(nSamples, proj))
  
  #demographic rates
  phiN.prob.proj <- phiB.prob.proj <- phiC.prob.proj <- array(NA, dim = c(nSamples, proj-1))
  psiB.prob.proj <- phiY.prob.proj <- array(NA, dim = c(nSamples, proj-1))
  
  #grab last year from data period to initialize
  N_proj[,1,] <- N[,dim(N)[2],] #set up space for age-specific population projections, populate with last year from data period
  A.NB[,1] <- N[,dim(N)[2],i+1]
  A.Byoy[,1] <- N[,dim(N)[2],i+2]
  A.BSk[,1] <- N[,dim(N)[2],i+3]
  
  Ntot[,1:(nyears.ch+nyears.gap)] <- out$sims.list$Ntot[,1:(dim(N)[2]-1)] #fills up to Ntot[,14]
  Ntot_proj[,1] <- out$sims.list$Ntot[,(dim(N)[2])] #grab 15th year
  
  ## projection; sigma == sd, sigma^2 == variance, 1/variance == precision
  for (t in 1:(proj-1)) {
    #use deviates (for every mcmc sample row, sample one of the twelve t "columns");
    pick.year <- sample(1:12, 1)
    phiB.prob.proj[,t] <- out$sims.list$phiB.prob[,pick.year]
    phiN.prob.proj[,t] <- out$sims.list$phiN.prob[,pick.year]
    phiC.prob.proj[,t] <- out$sims.list$phiC.true.prob[,pick.year] #"true" indicating it has been multiplied by phiB
    phiY.prob.proj[,t] <- out$sims.list$phiY.true.prob[,pick.year]
    psiB.prob.proj[,t] <- out$sims.list$psiB.prob[,pick.year]
    
    ### PLUS GROUP, contains B.yoy, B.Sk, NB ###
    ## NB group (from fec.age-1 and NB plus group)
    Anew.NB[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiN.prob.proj[,t]*(1-out$mean$psiN))
    Aplus.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiN.prob.proj[,t]*(1-out$mean$psiN))
    A.NB[,t+1] <- Anew.NB[,t+1] + Aplus.NB[,t+1]
    
    ## B.yoy group (from fec.age-1, NB plus, Sk)
    Anew.Byoy[,t+1] <- rbinom(nSamples, N_proj[,t,i], phiB.prob.proj[,t]*(out$mean$psiN))
    Aplus.Byoy.NB[,t+1] <- rbinom(nSamples, A.NB[,t], phiB.prob.proj[,t]*(out$mean$psiN))
    Aplus.Byoy.Sk[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(psiB.prob.proj[,t]))
    A.Byoy[,t+1] <- Aplus.Byoy.NB[,t+1] + Anew.Byoy[,t+1] + Aplus.Byoy.Sk[,t+1]
    
    ## B.Sk (from aging B.yoy and repeat skipping)
    A.BSk.stay[,t+1] <- rbinom(nSamples, A.BSk[,t], phiB.prob.proj[,t]*(1-psiB.prob.proj[,t]))
    A.Byoy.age[,t+1] <- rbinom(nSamples, A.Byoy[,t], phiB.prob.proj[,t])
    A.BSk[,t+1] <- A.Byoy.age[,t+1] + A.BSk.stay[,t+1]
    
    ### YOTY/CALVES ###
    N_proj[,t+1,1] <- A.Byoy[,t+1]  #YOY
    N_proj[,t+1,2] <- rbinom(nSamples, N_proj[,t,1], phiY.prob.proj[,t]) #1yo calf
    N_proj[,t+1,3] <- rbinom(nSamples, N_proj[,t,2], phiY.prob.proj[,t]) #2yo calf
    
    for (a in 4:6) { #calves age 3-5
      N_proj[,t+1,a] <- rbinom(nSamples, N_proj[,t,a-1], phiC.prob.proj[,t])
    } #a
    
    # # ### PB and MALES ###
    for (aa in 7:i) { #new 6-8 year olds
      N_proj[,t+1,aa] <- rbinom(nSamples, N_proj[,t,aa-1], phiN.prob.proj[,t])
    } #aa
    
    #return to the N_proj[t,age] matrix and fill in groups
    N_proj[,t+1,i+1] <- A.NB[,t+1] #all 9+ NB
    N_proj[,t+1,i+2] <- A.Byoy[,t+1] #all 9+ Byoy
    N_proj[,t+1,i+3] <- A.BSk[,t+1] #all 9+ skip breeders
    
    #Ntot
    Ntot_proj[,t+1] = rowSums(N_proj[1:nSamples,t+1,1:G])
  } #t pop mod
  
  #fill space in Ntot with Ntot_proj projection years, essentially bind_cols()
  Ntot[,((nyears.ch+nyears.gap+1):(nyears.ch+nyears.gap+proj))] <- Ntot_proj[,]
  
  ###### summarize objects over mcmc samples
  
  #growth rate over the whole study period
  lambda.yr.mean <- lambda.yr.lower <- lambda.yr.upper <- numeric(length = length(2:(nyears.ch+nyears.gap+proj)))
  for (t in 2:(nyears.ch+nyears.gap+proj)) {
    #mean and quantiles per year across mcmc samples; leave na.rm for zero size pops in mcmc samples
    lambda.yr.mean[t] <- mean(Ntot[,t]/(Ntot[,t-1]), na.rm = T) 
    lambda.yr.lower[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.025, na.rm = T, names = F) 
    lambda.yr.upper[t] <- quantile(Ntot[,t]/(Ntot[,t-1]), probs = 0.975, na.rm = T, names = F) 
  } #t lambda
  
  #### derive and store values for each simulation
  
  #geometric mean, and quantiles
  lambda.mean.sim[sim] <- exp(mean(log(lambda.yr.mean[which(lambda.yr.mean>0)])))
  lambda.lower.sim[sim] <- exp(mean(log(lambda.yr.lower[which(lambda.yr.lower>0)])))
  lambda.upper.sim[sim] <- exp(mean(log(lambda.yr.upper[which(lambda.yr.upper>0)])))
  
  #prob of having less than 2 individuals and less than 1 breeding age female at end
  p.ext.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)]<2)
  p.ad.ext.sim[sim] <- mean(N_proj[,proj,c((i+2):(i+3))]<1)
  
  #probability of population being below qe individuals at the end year or ever
  p.qe.ever.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]<50)>1)
  
  #prob of reaching downlist criteria (520) at any point in 1:50 or 1:95 years
  p.down.100.sim[sim] <- mean(rowSums(Ntot[,1:(nyears.gap+nyears.ch+proj)]>520)>1)

  #probability that have fewer individuals at end than start
  p.neg.sim[sim] <- mean(Ntot[,(nyears.gap+nyears.ch+proj)] < Ntot[,1])
  
  #population size at end of projection
  end.size.sim[sim,1:3] <- quantile(Ntot[,(nyears.gap+nyears.ch+proj)], 
                                    probs = c(0.025, 0.5, 0.975), names = F)
  
  #Ntot
  Ntot_sim[1:nSamples,,sim] <- as.matrix(Ntot)
  
} #sim iter

## summarizing over both sim and mcmc sample
Ntot_mean <- apply(Ntot_sim, c(2), median) 
Ntot_q2.5 <- apply(Ntot_sim, c(2), function(x) quantile(x,0.025))
Ntot_q97.5 <- apply(Ntot_sim, c(2), function(x) quantile(x,0.975))

Ntot.sim <- data.frame(year = 1:(nyears.ch+nyears.gap+proj),
                          mean = Ntot_mean, 
                          lower = Ntot_q2.5, 
                          upper = Ntot_q97.5) %>%
  transform(mod = m, day = d)

lambda.sim <- data.frame(lambda.mean = lambda.mean.sim,
                         lambda.lower = lambda.lower.sim,
                         lambda.upper = lambda.upper.sim,
                         mod = m, day = d) 

p.neg.sim <- data.frame(value = p.neg.sim, var = 'p.neg', mod = m, day = d) 
p.ad.ext.sim <- data.frame(value = p.ad.ext.sim, var = 'p.ad.ext', mod = m, day = d) 
p.ext.sim <- data.frame(value = p.ext.sim, var = 'p.ext', mod = m, day = d) 
p.down.sim <- data.frame(value = p.down.100.sim, var = 'p.down', mod = m, day = d) 

#bind new and old
Ntot.mod <- bind_rows(Ntot.sim, Ntot.mod)
lambda.mod <- bind_rows(lambda.sim, lambda.mod)
p.neg.mod <- bind_rows(p.neg.sim, p.neg.mod)
p.ext.mod <- bind_rows(p.ext.sim, p.ext.mod)
p.ad.ext.mod <- bind_rows(p.ad.ext.sim, p.ad.ext.mod)
p.down.mod <- bind_rows(p.down.sim, p.down.mod)

} #mod prior
} #survey day

proj.summary <- bind_rows(p.neg.mod, p.ext.mod, p.ad.ext.mod, p.down.mod)

saveRDS(Ntot.mod, file = here::here('results', 'Appendices', 'pGrp Prior', 'Ntot.mod.rds'))
saveRDS(lambda.mod, file = here::here('results', 'Appendices', 'pGrp Prior', 'lambda.mod.rds'))
saveRDS(proj.summary, file = here::here('results', 'Appendices', 'pGrp Prior', 'proj.summary.rds'))

## figures
#Ntot; mean across sims and prior
ggplot(Ntot.mod, aes(year, mean, color = factor(mod), group = factor(mod))) +
  geom_line() +
  geom_ribbon(aes(x = year, ymin = lower, ymax = upper),
              size = 0.2, alpha = 0.1, linetype = 'dotted', show.legend = F) +
  xlab('') + ylab('Population size') +
  facet_grid(~day) +
  plot_theme(legend.position = 'top') +
    scale_x_continuous(limits = c(1,nyears.ch+nyears.gap+proj),
                     breaks = seq(2, nyears.ch+nyears.gap+proj, by = 10),
                     labels = seq(2005, (2005+nyears.ch+nyears.gap+proj), by = 10)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = 'Prior')

#lambda
ggplot(lambda.mod, aes(y = lambda.mean, x = factor(mod), 
                       group = factor(mod), color = factor(mod))) +
  geom_boxplot(width = 0.5) +
  xlab('Prior') + ylab('Mean population growth rate') +
  facet_grid(~day) +
  plot_theme(legend.position = 'none',
             panel.border = element_rect(fill = NA)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = 'AFR')

#projection summaries
ggplot(proj.summary, aes(y = value, x = factor(mod), color = factor(mod), group = factor(mod))) +
  geom_boxplot(width = 0.5) +
  xlab('Prior') + ylab('Probability') +
  facet_grid(var~day, scales = 'free') +
  plot_theme(legend.position = 'top',
             panel.border = element_rect(fill = NA)) +
  scale_color_manual(values = rainbow2[-c(1,4,7)], name = 'Prior')

```


